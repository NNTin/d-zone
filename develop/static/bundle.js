"use strict";(()=>{var Ht=Object.create;var ue=Object.defineProperty;var Yt=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var Zt=Object.getPrototypeOf,$t=Object.prototype.hasOwnProperty;var Jt=(n,s,e)=>s in n?ue(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var S=(n,s)=>()=>(n&&(s=n(n=0)),s);var qt=(n,s)=>()=>(s||n((s={exports:{}}).exports,s),s.exports),G=(n,s)=>{for(var e in s)ue(n,e,{get:s[e],enumerable:!0})},Qt=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of Kt(s))!$t.call(n,i)&&i!==e&&ue(n,i,{get:()=>s[i],enumerable:!(t=Yt(s,i))||t.enumerable});return n};var P=(n,s,e)=>(e=n!=null?Ht(Zt(n)):{},Qt(s||!n||!n.__esModule?ue(e,"default",{value:n,enumerable:!0}):e,n));var r=(n,s,e)=>Jt(n,typeof s!="symbol"?s+"":s,e);var g,W,E=S(()=>{"use strict";g={randomIntRange(n,s){return Math.floor(Math.random()*(+s-+n+1))+ +n},pickInArray(n){return n[this.randomIntRange(0,n.length-1)]},pickInObject(n){return this.pickInArray(Object.keys(n))},findAndRemove(n,s){for(let e=0;e<s.length;e++)s[e]===n&&(s.splice(e,1),e--)},right(n,s){return n.substring(n.length-s,n.length)},clamp(n,s,e){return Math.min(e,Math.max(s,n))},clampWrap(n,s,e){let t=(n-s)%(e+1-s);return t>=0?s+t:e+1+t},fractionalArrayIndex(n,s){let e=Math.floor(s),t=n[e];if(e===s)return t;let i=n[Math.ceil(s)],o=s-Math.floor(s);return t+(i-t)*o},getURLParameter(n){return decodeURIComponent((new RegExp("[?|&]"+n+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},abbreviate(n,s){let e=n.split(" "),t=/[a-z0-9]/i,i="";for(let o=0;o<e.length;o++)for(let a=0;a<e[o].length;a++)if(t.test(e[o][a])){i+=e[o][a];break}if(i.trim()===""&&(i="1"),s&&s.indexOf(i)>=0){let o=0;i+=o;do o++,i=i.substring(0,i.length-1)+o;while(s.indexOf(i)>=0)}return i},alphabet:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],vowels:["a","e","i","o","u"],consonants:["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],hex:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"]},W=g});function z(n){return!isNaN(parseFloat(n))&&isFinite(n)}var Se,k,N=S(()=>{"use strict";Se=class{constructor(s,e){r(this,"canvas");r(this,"context");(!z(s)||!z(e))&&console.error("bad canvas size!",s,e),this.canvas=document.createElement("canvas"),this.canvas.width=s,this.canvas.height=e;let t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get 2D context from canvas");this.context=t}drawImage(s,e,t,i,o,a,h,l,c,u){(!s||!(e>=0)||!(t>=0)||!(i>=0)||!(o>=0)||!z(a)||!z(h)||!(l>=0)||!(c>=0))&&(console.error("bad drawImage params!",s,e,t,i,o,a,h,l,c),window.pause&&window.pause()),u!==void 0&&(this.context.save(),this.context.globalAlpha=u),this.context.drawImage(s,e,t,i,o,a,h,l,c),u!==void 0&&this.context.restore()}fill(s){this.context.fillStyle=s,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}fillRect(s,e,t,i,o){(!z(e)||!z(t)||!z(i)||!z(o))&&(console.error("bad fillRect params!",s,e,t,i,o),window.pause&&window.pause()),this.context.fillStyle=s,this.context.fillRect(Math.round(e),Math.round(t),Math.round(i),Math.round(o))}clearRect(s,e,t,i){(!z(s)||!z(e)||!z(t)||!z(i))&&(console.error("bad clearRect params!",s,e,t,i),window.pause&&window.pause()),this.context.clearRect(Math.round(s),Math.round(e),Math.round(t),Math.round(i))}},k=Se});var L=qt((Ii,Ee)=>{"use strict";var j=typeof Reflect=="object"?Reflect:null,He=j&&typeof j.apply=="function"?j.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)},le;j&&typeof j.ownKeys=="function"?le=j.ownKeys:Object.getOwnPropertySymbols?le=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:le=function(s){return Object.getOwnPropertyNames(s)};function Vt(n){console&&console.warn&&console.warn(n)}var Ke=Number.isNaN||function(s){return s!==s};function y(){y.init.call(this)}Ee.exports=y;Ee.exports.once=si;y.EventEmitter=y;y.prototype._events=void 0;y.prototype._eventsCount=0;y.prototype._maxListeners=void 0;var Ye=10;function de(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(y,"defaultMaxListeners",{enumerable:!0,get:function(){return Ye},set:function(n){if(typeof n!="number"||n<0||Ke(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");Ye=n}});y.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};y.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||Ke(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function Ze(n){return n._maxListeners===void 0?y.defaultMaxListeners:n._maxListeners}y.prototype.getMaxListeners=function(){return Ze(this)};y.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",o=this._events;if(o!==void 0)i=i&&o.error===void 0;else if(!i)return!1;if(i){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var h=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw h.context=a,h}var l=o[s];if(l===void 0)return!1;if(typeof l=="function")He(l,this,e);else for(var c=l.length,u=Ve(l,c),t=0;t<c;++t)He(u[t],this,e);return!0};function $e(n,s,e,t){var i,o,a;if(de(e),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",s,e.listener?e.listener:e),o=n._events),a=o[s]),a===void 0)a=o[s]=e,++n._eventsCount;else if(typeof a=="function"?a=o[s]=t?[e,a]:[a,e]:t?a.unshift(e):a.push(e),i=Ze(n),i>0&&a.length>i&&!a.warned){a.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=n,h.type=s,h.count=a.length,Vt(h)}return n}y.prototype.addListener=function(s,e){return $e(this,s,e,!1)};y.prototype.on=y.prototype.addListener;y.prototype.prependListener=function(s,e){return $e(this,s,e,!0)};function ei(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Je(n,s,e){var t={fired:!1,wrapFn:void 0,target:n,type:s,listener:e},i=ei.bind(t);return i.listener=e,t.wrapFn=i,i}y.prototype.once=function(s,e){return de(e),this.on(s,Je(this,s,e)),this};y.prototype.prependOnceListener=function(s,e){return de(e),this.prependListener(s,Je(this,s,e)),this};y.prototype.removeListener=function(s,e){var t,i,o,a,h;if(de(e),i=this._events,i===void 0)return this;if(t=i[s],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(o=-1,a=t.length-1;a>=0;a--)if(t[a]===e||t[a].listener===e){h=t[a].listener,o=a;break}if(o<0)return this;o===0?t.shift():ti(t,o),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,h||e)}return this};y.prototype.off=y.prototype.removeListener;y.prototype.removeAllListeners=function(s){var e,t,i;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var o=Object.keys(t),a;for(i=0;i<o.length;++i)a=o[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[s],typeof e=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this};function qe(n,s,e){var t=n._events;if(t===void 0)return[];var i=t[s];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?ii(i):Ve(i,i.length)}y.prototype.listeners=function(s){return qe(this,s,!0)};y.prototype.rawListeners=function(s){return qe(this,s,!1)};y.listenerCount=function(n,s){return typeof n.listenerCount=="function"?n.listenerCount(s):Qe.call(n,s)};y.prototype.listenerCount=Qe;function Qe(n){var s=this._events;if(s!==void 0){var e=s[n];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}y.prototype.eventNames=function(){return this._eventsCount>0?le(this._events):[]};function Ve(n,s){for(var e=new Array(s),t=0;t<s;++t)e[t]=n[t];return e}function ti(n,s){for(;s+1<n.length;s++)n[s]=n[s+1];n.pop()}function ii(n){for(var s=new Array(n.length),e=0;e<s.length;++e)s[e]=n[e].listener||n[e];return s}function si(n,s){return new Promise(function(e,t){function i(a){n.removeListener(s,o),t(a)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",i),e([].slice.call(arguments))}et(n,s,o,{once:!0}),s!=="error"&&ni(n,i,{once:!0})})}function ni(n,s,e){typeof n.on=="function"&&et(n,"error",s,e)}function et(n,s,e,t){if(typeof n.on=="function")t.once?n.once(s,e):n.on(s,e);else if(typeof n.addEventListener=="function")n.addEventListener(s,function i(o){t.once&&n.removeEventListener(s,i),e(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}});var Be,D,_,ri,dt,C,X=S(()=>{"use strict";N();Be={upper:{y:0,height:8,xSpacing:1,chars:[["A",5],["B",5],["C",5],["D",5],["E",4],["F",4],["G",5],["H",5],["I",3],["J",5],["K",5],["L",4],["M",5],["N",5],["O",5],["P",5],["Q",5],["R",5],["S",5],["T",5],["U",5],["V",5],["W",5],["X",5],["Y",5],["Z",5]]},lower:{y:8,height:11,xSpacing:1,chars:[["a",5],["b",4],["c",4],["d",4],["e",4],["f",4],["g",4],["h",4],["i",1],["j",2],["k",4],["l",1],["m",5],["n",4],["o",4],["p",4],["q",4],["r",4],["s",4],["t",4],["u",4],["v",5],["w",5],["x",4],["y",4],["z",4],[" ",4]]},numsAndSymbols:{y:19,xSpacing:1,height:8,chars:[["0",4],["1",3],["2",4],["3",4],["4",4],["5",4],["6",4],["7",4],["8",4],["9",4],["`",2],["~",6],["!",1],["@",7],["#",7],["$",4],["%",5],["^",5],["&",6],["*",3],["(",2],[")",2],["_",5],["=",5],["-",5],["+",5],["|",1],[",",2],[".",1],["<",5],[">",5],["?",4],["/",3],["\\",3],[";",1],[":",1],["'",1],['"',3],["[",2],["]",2],["{",3],["}",3]]},icons:{count:4,y:27,height:12,chars:[[":icon-npm:",12],[":icon-github:",12],[":icon-lock:",12],[":icon-lock-small:",12]]},accented1:{y:39,xSpacing:1,height:13,oy:-2,chars:[["\xE1",5],["\xC1",5],["\xE0",5],["\xC0",5],["\xE2",5],["\xC2",5],["\xE4",5],["\xC4",5],["\xE3",5],["\xC3",5],["\xE5",5],["\xC5",5],["\xE6",7],["\xC6",7],["\xE7",4],["\xC7",5],["\xE9",4],["\xC9",4],["\xE8",4],["\xC8",4],["\xEA",4],["\xCA",4],["\xEB",4],["\xCB",4],["\xED",2],["\xCD",3],["\xEC",2],["\xCC",3],["\xEE",3],["\xCE",3],["\xEF",3],["\xCF",3]]},accented2:{y:52,xSpacing:1,height:10,oy:-2,chars:[["\xF1",4],["\xD1",5],["\xF3",4],["\xD3",5],["\xF2",4],["\xD2",5],["\xF4",4],["\xD4",5],["\xF6",4],["\xD6",5],["\xF5",4],["\xD5",5],["\xF8",4],["\xD8",5],["\u0153",7],["\u0152",8],["\xDF",5],["\xFA",4],["\xDA",5],["\xF9",4],["\xD9",5],["\xFB",4],["\xDB",5],["\xFC",4],["\xDC",5]]}},D={};for(let n in Be){if(!Be.hasOwnProperty(n))continue;let s=Be[n],e=0;for(let t=0;t<s.chars.length;t++){let i=s.chars[t][0],o=s.chars[t][1]+(s.xSpacing||0);D[i]={x:e,y:s.y,w:o,h:s.height,char:i,oy:s.oy},e+=o}}_={x:4,y:3},ri=1,C={loadImage:function(n){dt=n},blot:function(n){let s=n.x||0,e=n.y||0,t=n.metrics||this.calculateMetrics(n),i=n.lineStart?n.lineStart:0,o=n.lineCount?Math.min(t.lines.length,n.lineCount):t.lines.length,a=n.canvas||new k(_.x*2+s+t.w-1,_.y*2+e+o*10);n.bg&&a.fill(n.bg);let h=0;for(let l=i;l<Math.min(t.lines.length,i+o);l++){let c=t.lines[l].chars.length;n.maxChars&&(c=Math.min(c,n.maxChars-h));for(let u=0;u<c;u++){let m=t.lines[l].chars[u];m.char.char!=" "&&a.drawImage(dt,m.char.x,m.char.y,m.w,m.char.h,_.x+s+m.x,_.y+e+(l-i)*10+(m.oy||0)+ri,m.w,m.char.h)}h+=t.lines[l].chars.length}return a.canvas},transition:function(n){let s=n.metrics||(n.text?this.calculateMetrics(n):{lines:[],text:"",w:0}),e=n.canvas||new k(s.w+_.x*2,(n.lineCount||s.lines.length)*10+_.y*2),t=Math.max(2,Math.max(0,n.progress-.25)/.75*e.canvas.width),i=Math.min(1,n.progress*4)*e.canvas.height*-1;return e.fillRect(n.bg,(e.canvas.width-t)/2,e.canvas.height,t,i),e.canvas},calculateMetrics:function(n){let s=n.text,e=[],t=s.split(" "),i=D[" "],o=0,a=[],h=0;for(let l=0;l<t.length;l++){let c=t[l];if(c=="")continue;let u=0,m=[];if(a.length>0&&(m.push({x:o,char:i,w:i.w}),u+=i.w),c.length>1&&D[c])m.push({x:o+u,char:D[c],w:D[c].w,oy:-2}),u+=D[c].w;else for(let p=0;p<c.length;p++){let f=D[c[p]]||i;m.push({x:o+u,char:f,w:f.w,oy:f.oy}),u+=f.w}if(n.maxWidth&&o+u>n.maxWidth){if(u>n.maxWidth){o>0&&(e.push({w:o,chars:a}),h=Math.max(o,h),o=0,a=[]),m=[],u=0;for(let p=0;p<c.length;p++){let f=D[c[p]]||i;if(o+u+f.w<n.maxWidth)m.push({x:o+u,char:f,w:f.w,oy:f.oy}),u+=f.w;else{let w=o+u+f.w-n.maxWidth;m.push({x:o+u,char:f,w:f.w-w,oy:f.oy}),u+=f.w-w;break}}o+=u,a=a.concat(m)}else l--;e.push({w:o,chars:a}),h=Math.max(o,h),o=0,a=[]}else o+=u,a=a.concat(m),l==t.length-1&&(e.push({w:o,chars:a}),h=Math.max(o,h))}return{lines:e,text:s,w:h}},fontMap:D}});var Ie,v,H=S(()=>{"use strict";E();Ie=[],v={generateClosestGrids:function(n){for(let s=n*-1;s<=n;s++)for(let e=n*-1;e<=n;e++)Ie.push([s,e]);Ie.sort(function(s,e){return Math.abs(s[0])+Math.abs(s[1])-(Math.abs(e[0])+Math.abs(e[1]))})},closestGrids:Ie,DIRECTIONS:{north:{x:0,y:-1},east:{x:1,y:0},south:{x:0,y:1},west:{x:-1,y:0}},randomDirection:function(){return this.DIRECTIONS[g.pickInObject(this.DIRECTIONS)]},getNeighbors:function(n){let s=+n.split(":")[0],e=+n.split(":")[1];return{n:s+":"+(e-1),e:s+1+":"+e,s:s+":"+(e+1),w:s-1+":"+e}},get8Neighbors:function(n){let s=+n.split(":")[0],e=+n.split(":")[1];return{n:s+":"+(e-1),e:s+1+":"+e,s:s+":"+(e+1),w:s-1+":"+e,nw:s-1+":"+(e-1),ne:s+1+":"+(e-1),sw:s-1+":"+(e+1),se:s+1+":"+(e+1)}},getDistance:function(n,s){return Math.abs(n.x-s.x)+Math.abs(n.y-s.y)},intervalOverlaps:function(n,s,e,t){return n>=e&&n<t||e>=n&&e<s},buildNoiseMap:function(n,s){let e=[];for(let t=0;t<n;t++){e.push([]);for(let i=0;i<s;i++)e[t].push(Math.random())}return e},getNoiseMapPoint:function(n,s,e){let t=Math.floor(s),i=n[t];if(t==s)return g.fractionalArrayIndex(i,e);let o=Math.ceil(s),a=n[o],h=Math.floor(e);if(h==e)return g.fractionalArrayIndex([i[h],a[h]],s-t);let l=g.fractionalArrayIndex(i,e),c=g.fractionalArrayIndex(a,e);return g.fractionalArrayIndex([l,c],s-t)}}});var ft,U,De=S(()=>{"use strict";ft=P(L(),1);E();U=class extends ft.EventEmitter{constructor(){super();r(this,"sprite",{});r(this,"game");r(this,"position");r(this,"zDepth");r(this,"invisible");r(this,"exists");this.sprite={}}addToGame(e){this.game=e,this.game.entities.push(this),this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(this.game.world.addToWorld(this),this.invisible||this.game.renderer.addToZBuffer(this.sprite,this.zDepth)):this.game.renderer.overlay.push(this.sprite),this.exists=!0}remove(){this.exists=!1,this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(!this.invisible&&this.game&&this.game.renderer.removeFromZBuffer(this.sprite,this.zDepth),this.game&&this.game.world.removeFromWorld(this)):this.game&&g.findAndRemove(this,this.game.renderer.overlay),this.game&&g.findAndRemove(this,this.game.entities)}tickDelay(e,t){this.game&&this.game.schedule.push({type:"once",tick:this.game.ticks+t,cb:e,entity:this})}tickRepeat(e,t,i){if(this.game){if(!isFinite(t)||t<=0){console.error("Entity.tickRepeat: Invalid ticks parameter",{ticks:t,entity:this.constructor.name,isFinite:isFinite(t),isPositive:t>0});return}this.game.schedule.push({type:"repeat",start:this.game.ticks,count:t,cb:e,afterCB:i,entity:this})}}removeFromSchedule(e){if(this.game){for(let t=0;t<this.game.schedule.length;t++)if(this.game.schedule[t].entity===this&&this.game.schedule[t].cb===e){this.game.schedule[t].type="deleted";break}}}}});var T,Y=S(()=>{"use strict";De();T=class extends U{constructor(e){super();r(this,"height");r(this,"zDepth");r(this,"pixelSize");r(this,"screen");this.position={x:e.position.x,y:e.position.y,z:e.position.z,fakeZ:0},this.height=e.height,this.zDepth=this.calcZDepth(),this.pixelSize={x:e.pixelSize.x,y:e.pixelSize.y,z:e.pixelSize.z},this.screen={x:0,y:0},this.updateScreen(),this.sprite.screen=this.screen,this.sprite.position=this.position}move(e,t,i){let o=this.position.x+e,a=this.position.y+t,h=this.position.z+i;this.game.world.moveObject(this,o,a,h),this.updateScreen();let l=this.calcZDepth();l!=this.zDepth&&(this.game.renderer.updateZBuffer(this.zDepth,this.sprite,l),this.zDepth=l)}underneath(){return this.game.world.objectAtXYZ(this.position.x,this.position.y,this.position.z+this.height)}calcZDepth(){return this.position.x+this.position.y}updateScreen(){this.screen.x=(this.position.x-this.position.y)*16-this.pixelSize.x,this.screen.y=(this.position.x+this.position.y)*8-(this.position.z+this.height)*16}}});var gt={};G(gt,{default:()=>fe});var fe,bt=S(()=>{"use strict";Y();fe=class extends T{constructor(e,t,i,o){super({position:{x:t,y:i,z:o},pixelSize:{x:16,y:16,z:1},height:.5});r(this,"invisible",!0);r(this,"style");this.style=e}}});var yt={};G(yt,{default:()=>K});var ai,K,Ne=S(()=>{"use strict";ai={tile:{"G-G-G-G":{x:0,y:108,w:32,h:18,ox:-1,oy:-2},"S-S-S-S":{x:32,y:90,w:32,h:18,ox:-1,oy:-2},"G-S-G-S":{x:64,y:90,w:32,h:18,ox:-1,oy:-2},"S-G-S-G":{x:96,y:90,w:32,h:18,ox:-1,oy:-2},"G-G-G-S":{x:0,y:18,w:32,h:18,ox:-1,oy:-2},"S-G-G-G":{x:0,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-G-G":{x:0,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-G":{x:0,y:72,w:32,h:18,ox:-1,oy:-2},"S-G-G-S":{x:32,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-G-G":{x:32,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-G":{x:32,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-S":{x:32,y:72,w:32,h:18,ox:-1,oy:-2},"S-S-G-S":{x:64,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-G":{x:64,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-S":{x:64,y:54,w:32,h:18,ox:-1,oy:-2},"S-G-S-S":{x:64,y:72,w:32,h:18,ox:-1,oy:-2},"F-F-F-F":{x:64,y:198,w:32,h:18,ox:-1,oy:-2},"G-F-G-F":{x:0,y:198,w:32,h:18,ox:-1,oy:-2},"F-G-F-G":{x:32,y:198,w:32,h:18,ox:-1,oy:-2},"G-G-G-F":{x:0,y:126,w:32,h:18,ox:-1,oy:-2},"F-G-G-G":{x:0,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-G-G":{x:0,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-G":{x:0,y:180,w:32,h:18,ox:-1,oy:-2},"F-G-G-F":{x:32,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-G-G":{x:32,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-G":{x:32,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-F":{x:32,y:180,w:32,h:18,ox:-1,oy:-2},"F-F-G-F":{x:64,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-F-G":{x:64,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-F":{x:64,y:162,w:32,h:18,ox:-1,oy:-2},"F-G-F-F":{x:64,y:180,w:32,h:18,ox:-1,oy:-2},"E-E-S-E":{x:96,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-S-E":{x:96,y:36,w:32,h:18,ox:-1,oy:-2},"E-E-S-S":{x:96,y:54,w:32,h:18,ox:-1,oy:-2},"E-S-S-S":{x:96,y:72,w:32,h:18,ox:-1,oy:-2},"E-E-E-S":{x:128,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-E":{x:128,y:18,w:32,h:18,ox:-1,oy:-2},"S-E-E-E":{x:160,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-E-S":{x:160,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-E":{x:192,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-S":{x:192,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-S":{x:224,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-S-S":{x:224,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-E":{x:224,y:36,w:32,h:18,ox:-1,oy:-2},"S-E-S-E":{x:224,y:54,w:32,h:18,ox:-1,oy:-2}}},K=class{constructor(s){r(this,"map");this.map=JSON.parse(JSON.stringify(ai[s]))}}});var vt={};G(vt,{default:()=>ge});var ge,xt=S(()=>{"use strict";E();Ne();ge=class{constructor(s){r(this,"game");r(this,"grid");r(this,"tileCode");r(this,"position");r(this,"zDepth");r(this,"screen");r(this,"imageName");r(this,"sheet");r(this,"sprite");this.game=s.game,this.grid=s.grid,this.tileCode=s.tileCode,this.position=s.position,this.zDepth=this.position.x+this.position.y,this.screen={x:(this.position.x-this.position.y)*16-16,y:(this.position.x+this.position.y)*8-this.position.z*16-8},this.imageName="static-tiles",this.sheet=new K("tile");let e=this.sheet.map[this.tileCode]||{x:0,y:0,w:16,h:16,ox:0,oy:0};if(this.sprite={metrics:{x:e.x||0,y:e.y||0,w:e.w||16,h:e.h||16,ox:e.ox||0,oy:e.oy||0},image:this.imageName,position:this.position,screen:this.screen},this.tileCode=="G-G-G-G"){let t=g.randomIntRange(0,2),i=Math.random();Math.random()>.98?t=8:Math.random()>.95?t=g.randomIntRange(5,7):i>.6&&(t=g.randomIntRange(3,4)),this.sprite.metrics.x+=t*this.sprite.metrics.w}}}});var Mt={};G(Mt,{default:()=>Ae});var be,wt,hi,ci,Ae,Re=S(()=>{"use strict";wt=(n,s)=>{let e=Math.abs(n.x-s.x),t=Math.abs(n.y-s.y);return e>t?8*t+5*e:8*e+5*t},hi=n=>{let s;for(let e in n)n.hasOwnProperty(e)&&(!s||s.f>n[e].f)&&(s=n[e]);return s},ci=(n,s,e)=>{let t=[],i=s;for(;!(i.x==n.x&&i.y==n.y);)t.push({x:i.x,y:i.y,z:be[i.x+":"+i.y]}),i=e[i.parent];return t.reverse()},Ae={loadMap:function(n){be=n},findPath:function(n){let s=n.start,e=n.end;if(s.x==e.x&&s.y==e.y||!(be[e.x+":"+e.y]>=0))return[];let t=wt(e,s),i={x:s.x,y:s.y,grid:s.x+":"+s.y,g:0,h:t,f:t},o=!0,a=0,h={},l={};for(h[i.grid]=i,a++;a>0;){if(l[i.grid]=i,delete h[i.grid],a--,i.x==e.x&&i.y==e.y)return ci(s,i,l);for(let u=-1;u<=1;u++)for(let m=-1;m<=1;m++){if(u==0&&m==0)continue;let p=i.x+u,f=i.y+m,w=p+":"+f;if(!(be[w]>=0)||l[w])continue;let M=u==0||m==0?5:8,O=i.g+M;if(h[w]){let x=h[w];O<x.g&&(x.g=O,x.f=x.g+x.h,x.parent=i.grid)}else{let x={x:p,y:f,grid:w,g:O,h:wt(e,{x:p,y:f}),f:0,parent:i.grid};x.f=x.g+x.h,h[x.grid]=x,a++}}let c=hi(h);if(!c)break;i=c,o=!1}return[]}}});var li,oe,Tt=S(()=>{"use strict";li={actor:{online:{north:{x:28,y:0,w:14,h:14,ox:0,oy:5},south:{x:0,y:0,w:14,h:14,ox:0,oy:5},east:{x:14,y:0,w:14,h:14,ox:0,oy:5},west:{x:28,y:0,w:14,h:14,ox:0,oy:5}},idle:{north:{x:56,y:0,w:14,h:14,ox:0,oy:5},south:{x:42,y:0,w:14,h:14,ox:0,oy:5},east:{x:56,y:0,w:14,h:14,ox:0,oy:5},west:{x:42,y:0,w:14,h:14,ox:0,oy:5}},offline:{north:{x:84,y:0,w:14,h:14,ox:0,oy:5},south:{x:70,y:0,w:14,h:14,ox:0,oy:5},east:{x:84,y:0,w:14,h:14,ox:0,oy:5},west:{x:70,y:0,w:14,h:14,ox:0,oy:5}},hopping:{animation:{frames:13,zStartFrame:3},north:{x:0,y:83,w:35,h:27,ox:-2,oy:-6},south:{x:0,y:137,w:35,h:27,ox:-19,oy:3},east:{x:0,y:56,w:35,h:27,ox:-2,oy:3},west:{x:0,y:110,w:35,h:27,ox:-19,oy:-6}}}},oe=class{constructor(s){r(this,"map");this.map=JSON.parse(JSON.stringify(li[s]))}}});var re,zt=S(()=>{"use strict";Y();re=class extends T{constructor(e,t){let i={position:{x:t.x,y:t.y,z:t.z},pixelSize:{x:0,y:0,z:0},height:.5};super(i);r(this,"parent");r(this,"invisible",!0);r(this,"unWalkable",!0);this.parent=e,this.addToGame(this.parent.game)}}});var A,Lt=S(()=>{"use strict";H();E();A=class{constructor(s){r(this,"actor");r(this,"state","idle");r(this,"impulseCompleteBound");r(this,"impulseInterval",300);r(this,"impulseBound");this.actor=s,this.impulseCompleteBound=this.impulseComplete.bind(this),this.impulseBound=this.impulse.bind(this),this.wait()}wait(){this.actor&&this.actor.tickDelay(this.impulseBound,20+Math.round(Math.random()*this.impulseInterval))}impulse(){if(!(!this.actor||this.actor.presence!="online"))if(this.actor.destination)this.wait();else{let s=g.pickInObject(v.DIRECTIONS),e=v.DIRECTIONS[s],t=this.actor.tryMove(e.x,e.y);if(t){if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)){console.error("Wander: tryMove returned NaN destination",{actor:this.actor.username,canMove:t,direction:s,moveXY:e,currentPosition:this.actor.position}),this.wait();return}this.actor.destination=t,this.actor.startMove(),this.actor.once("movecomplete",this.impulseCompleteBound)}else this.wait()}}impulseComplete(){this.wait()}detach(){this.actor.removeListener("movecomplete",this.impulseCompleteBound),this.actor.removeFromSchedule(this.impulseBound),delete this.actor}}});var R,Pt=S(()=>{"use strict";H();E();Re();R=class{constructor(s,e){r(this,"actor");r(this,"target");r(this,"attempt");r(this,"boundResetAttempt");r(this,"boundStartGoTo");r(this,"destination");r(this,"path");this.actor=s,this.target=e,this.attempt=g.randomIntRange(1,4),this.boundResetAttempt=this.resetAttempt.bind(this),this.target.on("movecomplete",this.boundResetAttempt),this.boundStartGoTo=this.startGoTo.bind(this),this.actor.destination?this.actor.once("movecomplete",this.boundStartGoTo):this.startGoTo()}startGoTo(){!this.actor||this.actor.presence!="online"||this.actor.underneath()||this.actor.tickDelay(()=>{this.performMove()},2)}performMove(){if(!this.actor||this.actor.presence!="online"||this.actor.underneath())return;let s=v.closestGrids[this.attempt];if(v.getDistance(this.actor.position,this.target.position)<=Math.abs(s[0])+Math.abs(s[1])){this.actor.stopGoTo(this);return}this.destination={x:this.target.position.x+s[0],y:this.target.position.y+s[1]};let t={x:this.destination.x-this.actor.position.x,y:this.destination.y-this.actor.position.y};var i={x:0,y:0};let o=Math.abs(t.x),a=Math.abs(t.y);o>a?(i.x=Math.max(-1,Math.min(1,t.x)),i.y=0):a>o?(i.x=0,i.y=Math.max(-1,Math.min(1,t.y))):o===a&&o>0&&(i.x=Math.max(-1,Math.min(1,t.x)),i.y=0);var h=this.actor.tryMove(i.x,i.y);if(h)this.actor.destination=h,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo);else if(this.path=Ae.findPath({start:this.actor.position,end:this.destination}),this.path[0]){let l={x:this.path[0].x-this.actor.position.x,y:this.path[0].y-this.actor.position.y},c={x:this.path[0].x,y:this.path[0].y,z:this.path[0].z};Math.abs(l.x)>0&&Math.abs(l.y)>0&&(Math.abs(l.x)>=Math.abs(l.y)?c={x:this.actor.position.x+Math.sign(l.x),y:this.actor.position.y,z:this.path[0].z}:c={x:this.actor.position.x,y:this.actor.position.y+Math.sign(l.y),z:this.path[0].z}),this.actor.destination=c,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo)}else{if(this.attempt++,this.attempt>8){console.log(`GoTo: ${this.actor.username} giving up after 8 attempts`),this.actor.stopGoTo(this);return}this.startGoTo()}}resetAttempt(){this.attempt=g.randomIntRange(1,4)}detach(){this.actor&&this.actor.removeListener("movecomplete",this.boundStartGoTo),this.target&&this.target.removeListener("movecomplete",this.boundResetAttempt),delete this.actor,delete this.target}}});function bi(n){let s=1;for(let e=0;e<ye.length;e++)if(n.length>=ye[e][0])s=ye[e][1];else if(n.length<ye[e][0])break;return s}var di,Z,ye,mi,pi,fi,gi,Ge,$,Bt=S(()=>{"use strict";De();X();di=96,Z=4,ye=[[0,3],[75,2],[150,1]],mi=5,pi=60,fi=10,gi=8,Ge="rgba(0, 0, 0, 0.7)";$=class extends U{constructor(e,t,i){super();r(this,"parent");r(this,"text");r(this,"screen");r(this,"sprite");r(this,"canvas");r(this,"textMetrics");this.parent=e,this.text=t,this.screen={x:0,y:0},this.sprite={keepOnScreen:!0,screen:this.screen,parent:this.parent,stay:i,metrics:{x:0,y:0,w:0,h:0}}}updateScreen(){if(!this.canvas)return;if(!this.parent||!this.parent.preciseScreen){console.warn("TextBox.updateScreen: Parent or parent.preciseScreen is missing",{hasParent:!!this.parent,hasPreciseScreen:this.parent&&!!this.parent.preciseScreen,textboxText:this.text,stackTrace:new Error().stack}),this.screen.x=0,this.screen.y=0,this.sprite&&(this.sprite.screen=this.screen,this.sprite.hidden=!0),this.remove();return}let e=isFinite(this.parent.preciseScreen.x)?this.parent.preciseScreen.x:0,t=isFinite(this.parent.preciseScreen.y)?this.parent.preciseScreen.y:0;(e!==this.parent.preciseScreen.x||t!==this.parent.preciseScreen.y)&&console.warn("TextBox.updateScreen: NaN detected in parent.preciseScreen, using fallback",{originalX:this.parent.preciseScreen.x,originalY:this.parent.preciseScreen.y,fallbackX:e,fallbackY:t,parentType:this.parent.constructor?.name||"unknown"}),this.screen.x=e-this.canvas.width/2+this.parent.pixelSize.x,this.screen.y=t-this.canvas.height+2,this.sprite&&(this.sprite.screen=this.screen)}updateSprite(){this.sprite.image=this.canvas,this.sprite.image&&(this.sprite.metrics.w=this.sprite.image.width,this.sprite.metrics.h=this.sprite.image.height)}blotText(e){e||(e={}),e.bg=e.bg||Ge,e.text=e.text||this.text,e.text&&(this.canvas=C.blot(e),this.updateScreen(),this.updateSprite())}scrollMessage(e){let t=this;function i(){t.remove(),e()}if(!this.parent||!this.parent.preciseScreen){console.warn("TextBox.scrollMessage: Parent invalid at start, completing immediately"),i();return}if(this.textMetrics=C.calculateMetrics({text:this.text,maxWidth:di}),this.text.trim()===""||this.textMetrics.lines.length===0||this.textMetrics.lines[0].chars.length===0){i();return}let o=bi(this.text),a=0,h=0,l=t.textMetrics.lines[a].chars.length;for(let u=1;u<Z;u++){let m=t.textMetrics.lines[a+u];if(m)l+=m.chars.length;else break}let c=function(){if(!t.parent||!t.parent.preciseScreen){console.warn("TextBox.scrollMessage: Parent became invalid during animation, stopping"),i();return}if(h++,t.blotText({text:t.text,metrics:t.textMetrics,maxChars:h,lineStart:a,lineCount:Z}),h===l)if(a+=Z,a>=t.textMetrics.lines.length)t.tickDelay(function(){t.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){console.warn("TextBox.scrollMessage: Parent became invalid during closing animation, stopping"),i();return}t.canvas=C.transition({bg:Ge,metrics:t.textMetrics,progress:1-u.percent,lineCount:Math.min(t.textMetrics.lines.length,Z)}),t.updateScreen(),t.updateSprite()},gi,i)},o*pi);else{h=0,l=t.textMetrics.lines[a].chars.length;for(let u=1;u<Z;u++){let m=t.textMetrics.lines[a+u];if(m)l+=m.chars.length;else break}t.tickDelay(c,o*mi)}else t.tickDelay(c,o)};this.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){console.warn("TextBox.scrollMessage: Parent became invalid during opening animation, stopping"),i();return}t.canvas=C.transition({bg:Ge,metrics:t.textMetrics,progress:u.percent,lineCount:Math.min(t.textMetrics.lines.length,Z)}),t.updateScreen(),t.updateSprite()},fi,function(){t.tickDelay(c,o)})}remove(){if(this.game&&this.game.schedule)for(let e=this.game.schedule.length-1;e>=0;e--){let t=this.game.schedule[e];t.entity===this&&(t.type="deleted")}super.remove()}}});var It={};G(It,{default:()=>ve});var ve,Dt=S(()=>{"use strict";H();E();Y();Tt();zt();Lt();Pt();Bt();ve=class extends T{constructor(e){(isNaN(e.x)||isNaN(e.y)||isNaN(e.z))&&(console.error("Actor constructor: Invalid coordinates provided",{username:e.username,uid:e.uid,coordinates:{x:e.x,y:e.y,z:e.z}}),e.x=isNaN(e.x)?0:e.x,e.y=isNaN(e.y)?0:e.y,e.z=isNaN(e.z)?0:e.z);let t={position:{x:e.x,y:e.y,z:e.z},pixelSize:{x:7,y:7,z:8},height:.5};super(t);r(this,"preciseScreen");r(this,"uid");r(this,"username");r(this,"nametag");r(this,"sheet");r(this,"presence","online");r(this,"talking",!1);r(this,"destination",!1);r(this,"facing");r(this,"behaviors",[]);r(this,"boundOnMessage");r(this,"roleColor");r(this,"placeholder");r(this,"moveTick");r(this,"talkBox");r(this,"talkTimeLeft");r(this,"frame",0);r(this,"lastMessage");r(this,"messageBox");r(this,"moveStart");r(this,"movePlaceholder");r(this,"destDelta");r(this,"unWalkable");this.preciseScreen=this.toScreenPrecise(),e.maxListeners&&this.setMaxListeners(e.maxListeners),this.uid=e.uid,this.username=e.username,this.nametag=new $(this,this.username,!0),this.nametag.blotText(),this.sheet=new oe("actor"),this.frame=0,this.sprite&&(this.sprite.image="actors",this.sprite.screen=this.screen),this.facing=g.pickInObject(v.DIRECTIONS),this.boundOnMessage=this.onMessage.bind(this),this.roleColor=e.roleColor,this.updateSprite()}onUpdate(){this.talking&&this.updateSprite();let e=this.game;if(e.mouseOut||e.mouseOver&&(e.mouseOver.zDepth>this.zDepth||e.mouseOver.position.z>this.position.z)||e.ui.mouseOnElement)return;let t={x:e.centerMouseX-e.renderer.canvases[0].panning.panned.x,y:e.centerMouseY-e.renderer.canvases[0].panning.panned.y},i=this.sheet.map.online.north;t.x>=this.preciseScreen.x+i.ox&&t.x<this.preciseScreen.x+i.w+i.ox&&t.y>=this.preciseScreen.y+i.oy&&t.y<this.preciseScreen.y+i.h+i.oy?(e.mouseOver=this,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!1)):e.mouseOver===this&&(e.mouseOver=!1,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!0))}addToGame(e){super.addToGame(e),this.roleColor&&e.renderer.addColorSheet({sheet:"actors",color:this.roleColor,alpha:.8,regions:[{alpha:.4,x:70,y:0,w:28,h:14}]}),this.nametag&&(this.nametag.addToGame(e),this.nametag.sprite.hidden=!0),e.on("update",this.onUpdate.bind(this)),e.users&&e.users.on("message",this.boundOnMessage),this.behaviors.push(new A(this))}updatePresence(e){if(this.presence=e,this.updateSprite(),e!="online"){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof A&&(this.behaviors[t].detach(),this.behaviors.splice(t,1));this.destination&&(this.moveTick&&(console.log(`Actor.updatePresence: ${this.username} cancelling movement due to presence change to ${e}`),this.removeFromSchedule(this.moveTick),delete this.moveTick,this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,delete this.moveStart,delete this.destDelta),this.destination=!1)}else{let t=!1;for(let i of this.behaviors)if(i instanceof A){t=!0;break}t||this.behaviors.push(new A(this))}}toScreenPrecise(){if(isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z))return console.error("Actor.toScreenPrecise: Position coordinates contain NaN",{actor:this.username,position:this.position,caller:new Error().stack}),{x:0,y:0};if(this.destination&&this.moveStart!==void 0){let t=this.game;if(t&&t.ticks!==void 0){let i=this.destination.x-this.position.x,o=this.destination.y-this.position.y,a=this.destination.z-this.position.z,h=t.ticks-this.moveStart,c=3*this.sheet.map.hopping.animation.frames,u=Math.min(h/c,1),m={x:(i-o)*16*u,y:(i+o)*8-a*16*u};return{x:this.screen.x+m.x,y:this.screen.y+m.y}}}let e={x:(this.position.x-this.position.y)*16-8,y:(this.position.x+this.position.y)*8-this.position.z*16-8};return isNaN(e.x)||isNaN(e.y)?(console.error("Actor.toScreenPrecise: Calculated screen coordinates are NaN",{actor:this.username,position:this.position,screen:e,calculation:{screenX:`(${this.position.x} - ${this.position.y}) * 16 - 8 = ${(this.position.x-this.position.y)*16-8}`,screenY:`(${this.position.x} + ${this.position.y}) * 8 - (${this.position.z}) * 16 - 8 = ${(this.position.x+this.position.y)*8-this.position.z*16-8}`}}),{x:0,y:0}):e}updateSprite(){if(!this.sprite)return;let e=this.facing,t=this.destination?"hopping":this.presence;if(!this.destination&&this.talking&&(t="online",e=e==="north"?"east":e==="west"?"south":e),!this.sheet.map[t]||!this.sheet.map[t][e]){if(!this.sheet.map[t])switch(t){case"dnd":case"busy":t="idle";break;case"away":case"invisible":t="offline";break;default:t="online";break}if(!this.sheet.map[t]||!this.sheet.map[t][e]){console.error("Actor: No sprite found for state:",t,"facing:",e),console.error("Actor: Available states:",Object.keys(this.sheet.map)),this.sheet.map[t]&&console.error("Actor: Available facings for",t,":",Object.keys(this.sheet.map[t]));return}}let i=this.sheet.map[t][e],o={x:i.x,y:i.y,w:i.w,h:i.h,ox:i.ox||0,oy:i.oy||0};if(!this.destination&&this.talking){let a=this.game;a&&a.ticks!==void 0&&(o.y+=Math.floor(a.ticks/4)%4*o.h)}else if(this.destination){let a=o.x,h=o.y;o.x+=(this.frame||0)*o.w;let l=this.sheet.map.hopping.animation;if(this.frame>=l.zStartFrame){let c=this.destination.z-this.position.z;c>0?o.oy-=Math.min(8,this.frame-l.zStartFrame):c<0&&(o.oy+=Math.min(8,this.frame-l.zStartFrame))}}if(this.talking&&this.messageBox&&this.messageBox.updateScreen(),this.sprite.metrics=o,this.roleColor){let a=this.game;a&&a.renderer&&a.renderer.addColorSheet?(a.renderer.addColorSheet({color:this.roleColor,sheet:"actors",alpha:1}),this.sprite.image=[this.roleColor,"actors"]):this.sprite.image="actors"}else this.sprite.image="actors"}tryMove(e,t){let i=this.game;if(!i.world||!i.world.canWalk)return!1;if(this.underneath())return console.log("actor: object on top"),this.emit("getoffme"),!1;if(isNaN(e)||isNaN(t))return console.error("Actor.tryMove: Movement deltas contain NaN",{actor:this.username,deltaX:e,deltaY:t,currentPosition:this.position}),!1;if(isNaN(this.position.x)||isNaN(this.position.y))return console.error("Actor.tryMove: Current position contains NaN",{actor:this.username,position:this.position,movementDeltas:{x:e,y:t}}),!1;let o={x:this.position.x+e,y:this.position.y+t};if(isNaN(o.x)||isNaN(o.y))return console.error("Actor.tryMove: Calculated destination contains NaN",{actor:this.username,destination:o,currentPosition:this.position,movementDeltas:{x:e,y:t}}),!1;if(i.world.canWalk(o.x,o.y)){let a=i.world.getHeight(o.x,o.y);if(a>=0&&Math.abs(this.position.z-a)<=.5)return{x:o.x,y:o.y,z:a};console.error("Actor.tryMove: Destination not walkable or invalid height",{actor:this.username,destination:o,walkable:a,currentPosition:this.position,movementDeltas:{x:e,y:t}})}return!1}startMove(){if(!this.destination)return;if(this.moveTick){console.warn("Actor.startMove: Movement already in progress, ignoring new startMove call",{actor:this.username,currentDestination:this.destination,frame:this.frame,moveStart:this.moveStart});return}let e=this.game;if(!e||!e.world){console.error("Actor.startMove: Game or world not available");return}if(this.moveStart=e.ticks,e.world.objectAtXYZ(this.destination.x,this.destination.y,this.destination.z)){this.destination=!1;return}this.movePlaceholder=new re(this,{x:this.destination.x,y:this.destination.y,z:this.destination.z}),this.unWalkable=!0,delete e.world.walkable[this.position.x+":"+this.position.y],this.destDelta={x:this.destination.x-this.position.x,y:this.destination.y-this.position.y,z:this.destination.z-this.position.z},this.destDelta.x>0?this.facing="east":this.destDelta.x<0?this.facing="west":this.destDelta.y>0?this.facing="south":this.destDelta.y<0&&(this.facing="north"),this.destDelta.x!==0&&this.destDelta.y!==0&&console.warn(`Actor.startMove: ${this.username} diagonal movement detected! This should not happen.`,{destDelta:this.destDelta,destination:this.destination,position:this.position}),this.frame=0;let i=this.sheet.map.hopping.animation,o=this.position.x+this.position.y+(this.destDelta.x+this.destDelta.y)/2;this.moveTick=this.tickRepeat(a=>{if(!this.exists){this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder);return}let h=!1;if(a.ticks>0&&a.ticks%3===0&&(this.frame++,h=!0),h&&this.frame===6)e.renderer.updateZBuffer(this.zDepth,this.sprite,o),this.zDepth=o;else if(h&&this.frame===8){let l=this.destination.x+this.destination.y;e.renderer.updateZBuffer(o,this.sprite,l),this.zDepth=l}this.preciseScreen=this.toScreenPrecise(),this.nametag&&this.nametag.updateScreen(),this.updateSprite(),this.frame>=i.frames&&(this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,this.move(this.destination.x,this.destination.y,this.destination.z,!0),this.destination=!1,this.frame=0,delete this.moveStart,delete this.destDelta,this.updateSprite(),this.emit("movecomplete"),delete this.moveTick)},3*i.frames),this.updateSprite()}move(e,t,i,o){if(isNaN(e)||isNaN(t)||typeof i<"u"&&isNaN(i)){console.error("Actor.move: Invalid coordinates provided",{actor:this.username,parameters:{x:e,y:t,z:i,absolute:o},currentPosition:this.position});return}if(o){let a=this.game;a&&a.world&&a.world.moveObject?a.world.moveObject(this,e,t,i!==void 0?i:this.position.z):(this.position.x=e,this.position.y=t,typeof i<"u"&&(this.position.z=i))}else{typeof i<"u"?super.move(e,t,i):super.move(e,t,0);return}if(isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z)){console.error("Actor.move: Final position contains NaN after movement",{actor:this.username,finalPosition:this.position,movement:{x:e,y:t,z:i,absolute:o}});return}this.zDepth=this.calcZDepth(),this.updateScreen(),this.preciseScreen=this.toScreenPrecise()}startTalking(e,t,i){this.talking=!0,this.lastMessage={channel:t,time:Date.now()},this.nametag&&(this.nametag.sprite.hidden=!0),this.messageBox=new $(this,e,!0),this.messageBox.addToGame(this.game);let o=this;this.messageBox.scrollMessage(function(){delete o.messageBox,o.talking=!1,o.updateSprite(),o.emit("donetalking"),i&&i()})}onMessage(e){let t=this.lastMessage||{time:0};if(e.channel!==t.channel||t.time<Date.now()-180*1e3||e.user===this||this.presence!=="online")return;let i=this;function o(){for(let a=0;a<i.behaviors.length;a++)i.behaviors[a].detach();i.behaviors=[new R(i,e.user)]}this.tickDelay(function(){v.getDistance(i.position,e.user.position)<3||i.underneath()||(i.destination?i.once("movecomplete",o):o())},g.randomIntRange(0,60))}goto(e,t){console.log(`Actor.goto: ${this.username} going to (${e}, ${t})`);let i={position:{x:e,y:t,z:this.game.world.getHeight(e,t)}};for(let o=this.behaviors.length-1;o>=0;o--)this.behaviors[o]instanceof R&&(this.behaviors[o].detach(),this.behaviors.splice(o,1));this.behaviors.push(new R(this,i))}stopGoTo(e){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof R&&(!e||this.behaviors[t]===e)&&(this.behaviors[t].detach(),this.behaviors.splice(t,1))}remove(){let e=this.game;e&&e.users&&e.users.off("message",this.boundOnMessage);for(let t of this.behaviors)t.detach&&t.detach();if(this.behaviors=[],this.movePlaceholder){try{this.movePlaceholder.remove()}catch(t){console.error("Actor.remove: Error removing movePlaceholder:",t)}delete this.movePlaceholder}if(this.messageBox){try{this.messageBox.remove()}catch(t){console.error("Actor.remove: Error removing messageBox:",t)}delete this.messageBox}if(this.talkBox){try{this.talkBox.remove()}catch(t){console.error("Actor.remove: Error removing talkBox:",t)}delete this.talkBox}if(this.nametag){try{this.nametag.remove()}catch(t){console.error("Actor.remove: Error removing nametag:",t)}delete this.nametag}if(this.placeholder){try{this.placeholder.remove()}catch(t){console.error("Actor.remove: Error removing placeholder:",t)}delete this.placeholder}super.remove()}}});var yi,F,Ue=S(()=>{"use strict";yi={beacon:{main:{x:0,y:0,w:31,h:56,ox:-1,oy:-1},light:{x:31,y:0,w:5,h:4,ox:13,oy:0}},seed:{plant:{x:36,y:0,w:16,h:22,ox:2,oy:2},orb:{x:36,y:22,w:8,h:8,ox:8,oy:4}}},F=class{constructor(s){r(this,"map");this.map=JSON.parse(JSON.stringify(yi[s]))}}});var At={};G(At,{default:()=>we});var we,Rt=S(()=>{"use strict";Y();N();Ue();we=class extends T{constructor(e,t,i){super({position:{x:e,y:t,z:i},pixelSize:{x:15,y:16,z:45},height:2.5});r(this,"unWalkable",!0);r(this,"imageName","props");r(this,"sheet");r(this,"pinging",0);this.on("draw",a=>{this.exists&&a.drawEntity(this)}),this.sheet=new F("beacon"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.main)}addToGame(e){super.addToGame(e),e.on("update",this.onUpdate.bind(this)),this.drawSprite()}drawSprite(){if(!this.sheet?.map?.main||!this.game?.renderer?.images?.[this.imageName])return;let e=new k(this.sheet.map.main.w,this.sheet.map.main.h);e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.main.x,this.sheet.map.main.y,this.sheet.map.main.w,this.sheet.map.main.h,0,0,this.sheet.map.main.w,this.sheet.map.main.h),this.pinging&&this.sheet.map.light&&e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.light.x,this.sheet.map.light.y,this.sheet.map.light.w,this.sheet.map.light.h,this.sheet.map.light.ox,0,this.sheet.map.light.w,this.sheet.map.light.h,this.pinging/100),this.sprite&&(this.sprite.image=e.canvas)}onUpdate(){this.pinging&&(this.pinging=Math.max(0,this.pinging-1),this.drawSprite())}ping(){this.pinging=100}}});var Gt={};G(Gt,{default:()=>Me});var Me,Wt=S(()=>{"use strict";E();Y();Ue();Me=class extends T{constructor(e){let t={position:{x:e.destination.x,y:e.destination.y,z:e.destination.z},pixelSize:{x:12,y:12,z:16},height:1};super(t);r(this,"unwalkable",!0);r(this,"origin");r(this,"sheet");r(this,"boundGrow");r(this,"boundWither");r(this,"growTime",80);r(this,"growStage",0);r(this,"growthStage");this.origin=e.origin,this.on("draw",i=>{this.exists&&i.drawEntity(this)}),this.sprite&&(this.sprite.image="props"),this.boundGrow=this.grow.bind(this),this.boundWither=this.wither.bind(this),this.sheet=new F("seed"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.plant)}addToGame(e){super.addToGame(e),this.tickDelay(this.boundGrow,this.growTime+g.randomIntRange(this.growTime/-6,this.growTime/6))}grow(){this.growStage++;let e=JSON.parse(JSON.stringify(this.sheet.map.plant));e.x+=this.sprite.metrics.w*this.growStage,this.sprite.metrics=e;let t=this.growTime+g.randomIntRange(this.growTime/-6,this.growTime/6);this.growStage<5?this.tickDelay(this.boundGrow,t):this.tickDelay(this.boundWither,Math.floor(t/2))}wither(){let e=this.sheet.map.orb;this.sprite.metrics=JSON.parse(JSON.stringify(e)),this.tickRepeat(t=>{this.sprite.metrics.oy=Math.round(e.oy+t.ticks/2),t.percent>=1&&(this.growthStage=6)},26)}}});E();N();var Oe=["actors","environment","static-tiles","props","font"],ke=class{constructor(s){r(this,"images",{});r(this,"imagesLoaded",0);r(this,"onComplete");this.onComplete=s;for(let e=0;e<Oe.length;e++){let t=Oe[e],i=t+".png",o=new Image;o.addEventListener("load",()=>this.onImageLoad(o,t)),o.src="./img/"+i}}onImageLoad(s,e){let t=new k(s.width,s.height);this.images[e]=t.canvas,t.drawImage(s,0,0,s.width,s.height,0,0,s.width,s.height),this.imagesLoaded++,this.imagesLoaded===Oe.length&&this.onComplete(this.images)}},Xe=ke;var nt=P(L(),1);var it=P(L(),1);var pe=class extends it.EventEmitter{constructor(){super();r(this,"mouseX",0);r(this,"mouseY",0);r(this,"mouseLeft",!1);r(this,"mouseRight",!1);r(this,"mouseOut",!1);r(this,"keys",{});r(this,"canvas",null);r(this,"mouseScale",1);this.setMaxListeners(0),document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this))}bindCanvas(e){this.canvas=e.canvas.canvas,this.mouseScale=e.scale,window.addEventListener("mousemove",this.mousemove.bind(this)),window.addEventListener("mousedown",this.mousedown.bind(this)),window.addEventListener("mouseup",this.mouseup.bind(this)),window.addEventListener("touchmove",this.touchmove.bind(this)),window.addEventListener("touchstart",this.touchstart.bind(this)),window.addEventListener("touchend",this.touchend.bind(this)),window.addEventListener("touchcancel",this.touchend.bind(this)),document.addEventListener("mouseout",this.mouseout.bind(this)),document.addEventListener("mouseover",this.mouseover.bind(this));let t="onwheel"in document.createElement("div")?"wheel":"mousewheel";window.addEventListener(t,this.mousewheel.bind(this))}mousemove(e){let t=e;this.mouseOut||(this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mousemove",{x:this.mouseX,y:this.mouseY}))}touchstart(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchstart",{button:"touch",x:this.mouseX,y:this.mouseY})}touchend(e){let t=e.changedTouches[0];this.emit("touchend",{button:"touch",x:t.pageX,y:t.pageY})}touchmove(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchmove",{button:"touch",x:this.mouseX,y:this.mouseY})}mousedown(e){let i=me[e.button];switch(i){case"left":this.mouseLeft=!0;break;case"right":this.mouseRight=!0;break}this.emit("mousedown",{button:i,x:this.mouseX,y:this.mouseY})}mouseup(e){let i=me[e.button];switch(i){case"left":this.mouseLeft=!1;break;case"right":this.mouseRight=!1;break}this.emit("mouseup",{button:i,x:this.mouseX,y:this.mouseY})}mouseout(e){let t=e,i=me[t.button];this.mouseOut=!0,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseout",{x:this.mouseX,y:this.mouseY,button:i})}mouseover(e){let t=e,i=t.buttons&1?1:t.buttons&2?2:t.buttons&4?3:0,o=me[i-1];this.mouseOut=!1,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseover",{x:this.mouseX,y:this.mouseY,button:o})}mousewheel(e){let t=e;if(!t.deltaY)return;let i=t.deltaY>0?"down":"up";this.emit("mousewheel",{direction:i,x:this.mouseX,y:this.mouseY})}keydown(e){let t=e,i=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():tt[t.keyCode];i==="backspace"&&t.preventDefault(),!this.keys[i]&&(this.keys[i]=!0,this.emit("keydown",{key:i}))}keyup(e){let t=e,i=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():tt[t.keyCode];this.keys[i]&&(this.keys[i]=!1,this.emit("keyup",{key:i}))}},me=["left","middle","right"],tt={37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"};E();var st=typeof performance<"u"&&performance.now?()=>performance.now():()=>Date.now(),Ce=class extends nt.EventEmitter{constructor(e={}){super();r(this,"step");r(this,"lastUpdate",0);r(this,"dt",0);r(this,"ticks",0);r(this,"crashed");r(this,"paused");r(this,"input");r(this,"mouseButtons",[]);r(this,"centerMouseX",-999);r(this,"centerMouseY",-999);r(this,"mouseX");r(this,"mouseY");r(this,"mouseOut");r(this,"mouseOver");r(this,"entities",[]);r(this,"schedule",[]);r(this,"viewWidth");r(this,"viewHeight");r(this,"interval");r(this,"renderer");r(this,"ui");r(this,"users");r(this,"servers");r(this,"server");r(this,"world");r(this,"timeUpdates");r(this,"timeRenders");r(this,"showGrid");r(this,"helpPanel");r(this,"helpButton");r(this,"serverListPanel");r(this,"pendingServerJoin");r(this,"decorator");r(this,"hideZ");this.setMaxListeners(0),this.step=e.step||1e3/60,this.input=new pe,this.input.on("keydown",this.keydown.bind(this)),this.input.on("keyup",this.keyup.bind(this));let t=this;this.interval=setInterval(function(){if(t.crashed)return;let i=st();if(t.dt+=i-t.lastUpdate,t.lastUpdate>0&&t.dt>6e4&&(console.log("too many updates missed! game crash..."),t.crashed=!0,t.paused=!0),t.dt>t.step)for(;t.dt>=t.step;)t.dt-=t.step,!t.paused&&(t.ticks++,t.update());t.lastUpdate=st()},this.step)}update(){let e=this.timeUpdates&&(this.ticks&255)===0;e&&console.time("update"),this.emit("update");for(let t=0;t<this.schedule.length;t++){let i=this.schedule[t],o;if(i.type==="repeat"){if(o=i.start+i.count,i.start<=this.ticks){let a=this.ticks-i.start,h=i.count>0?a/i.count:1;if(!isFinite(h)){console.error("Game.update: Invalid progress calculation",{ticks:a,taskCount:i.count,taskStart:i.start,gameTicks:this.ticks,percent:h}),i.type="deleted";continue}i.cb({ticks:a,percent:h})}}else i.type==="once"&&(o=i.tick);(i.type==="deleted"||o!==void 0&&o<=this.ticks)&&(i.type==="once"?i.cb():i.type==="repeat"&&i.afterCB&&i.afterCB(),this.schedule.splice(t,1),t--)}this.emit("render"),e&&console.timeEnd("update")}bindCanvas(e){this.input.bindCanvas(e),this.viewWidth=e.width,this.viewHeight=e.height,this.input.on("mousemove",this.mousemove.bind(this)),this.input.on("mousedown",this.mousedown.bind(this)),this.input.on("mouseup",this.mouseup.bind(this)),this.input.on("mouseout",this.mouseout.bind(this)),this.input.on("mouseover",this.mouseover.bind(this)),this.input.on("mousewheel",this.mousewheel.bind(this)),this.input.on("touchmove",this.touchmove.bind(this)),this.input.on("touchstart",this.touchstart.bind(this)),this.input.on("touchend",this.touchend.bind(this)),this.input.on("touchcancel",this.touchcancel.bind(this)),e.on("resize",this.viewResize.bind(this))}viewResize(e){this.viewWidth=e.width,this.viewHeight=e.height,this.input.mouseScale=e.scale,this.emit("resize",e)}mousemove(e){this.mouseOut||(this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("mousemove",e))}mousedown(e){this.mouseOver&&(console.log(this.mouseOver),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("mousedown",e)}touchend(e){W.findAndRemove(e.button,this.mouseButtons),this.emit("touchend",e)}touchmove(e){this.mouseOut||(this.mouseOut=!1,this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("touchmove",e))}touchcancel(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("touchcancel",e)}touchstart(e){this.mouseOver&&(console.log(this.mouseOver),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("touchstart",e)}mouseup(e){W.findAndRemove(e.button,this.mouseButtons),this.emit("mouseup",e)}mouseout(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("mouseout",e)}mouseover(e){this.mouseOut=!1,this.emit("mouseover",e)}mousewheel(e){this.emit("mousewheel",e)}keydown(e){this.emit("keydown",e)}keyup(e){this.emit("keyup",e)}reset(){for(this.emit("destroy"),this.removeAllListeners("update"),this.schedule=[];this.entities.length>0;)this.entities[0].remove?this.entities[0].remove():this.entities.splice(0,1)}},ot=Ce;var rt=P(L(),1);var Te=class extends rt.EventEmitter{constructor(e){super();r(this,"clientId");r(this,"redirectUri");r(this,"scopes");r(this,"state");r(this,"accessToken",null);r(this,"user",null);this.clientId=e.clientId,this.redirectUri=e.redirectUri||window.location.origin+"/discord-callback.html",this.scopes=e.scopes||["identify"],this.state=this.generateState(),this.loadStoredAuth()}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}getAuthUrl(){return"https://discord.com/api/oauth2/authorize?"+new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,response_type:"token",scope:this.scopes.join(" "),state:this.state}).toString()}login(){let e=this.getAuthUrl();console.log("Starting Discord OAuth login with URL:",e),localStorage.setItem("discord_oauth_state",this.state);let t=window.open(e,"discord_oauth","width=500,height=700,scrollbars=yes");if(!t){console.error("Popup was blocked by browser"),this.emit("login-error","Popup was blocked by browser. Please allow popups for this site.");return}console.log("Discord OAuth popup opened successfully");let i=this,o=h=>{if(console.log("Received message from popup:",h.data,"from origin:",h.origin),h.origin!==window.location.origin){console.log("Ignoring message from different origin:",h.origin);return}let l=h.data;if(l.type==="discord-auth-success"){let c=l,u=c.accessToken,m=c.state,p=c.expiresIn;if(console.log("Discord auth success received, access token length:",u?u.length:0),window.removeEventListener("message",o),m!==i.state){console.error("State mismatch. Expected:",i.state,"Received:",m),i.emit("login-error","Invalid state parameter");return}u?(i.accessToken=u,i.storeAuth({access_token:u,expires_in:p}),i.fetchUserInfo()):(console.error("No access token in success message"),i.emit("login-error","No access token received"))}else if(l.type==="discord-auth-error"){let c=l;console.error("Discord auth error received:",c.error),window.removeEventListener("message",o),i.emit("login-error",c.error)}};window.addEventListener("message",o);let a=setInterval(()=>{t.closed&&(console.log("Discord OAuth popup was closed"),clearInterval(a),window.removeEventListener("message",o),i.emit("login-cancelled"))},1e3)}fetchUserInfo(){let e=this;fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+this.accessToken}}).then(t=>t.json()).then(t=>{e.user=t,localStorage.setItem("discord_user",JSON.stringify(t)),e.emit("login-success",t)}).catch(t=>{e.emit("login-error",t.message)})}logout(){this.accessToken=null,this.user=null,localStorage.removeItem("discord_auth_token"),localStorage.removeItem("discord_auth_expires"),localStorage.removeItem("discord_user"),this.emit("logout")}storeAuth(e){if(localStorage.setItem("discord_auth_token",e.access_token),e.expires_in){let t=Date.now()+e.expires_in*1e3;localStorage.setItem("discord_auth_expires",t.toString())}}loadStoredAuth(){let e=localStorage.getItem("discord_auth_token"),t=localStorage.getItem("discord_auth_expires"),i=localStorage.getItem("discord_user");if(e&&(!t||Date.now()<parseInt(t))){if(this.accessToken=e,i)try{this.user=JSON.parse(i)}catch{}this.accessToken&&!this.user&&this.fetchUserInfo()}else this.logout()}isLoggedIn(){return!!(this.accessToken&&this.user)}getUser(){return this.user}getAvatarUrl(e=128){return!this.user||!this.user.avatar?null:`https://cdn.discordapp.com/avatars/${this.user.id}/${this.user.avatar}.png?size=${e}`}},ze=Te;var ht=P(L(),1);function oi(n,s){let e=document.createElement("canvas");e.width=n.width,e.height=n.height;let t=e.getContext("2d",{willReadFrequently:!0});t.drawImage(n,0,0);let i=t.getImageData(0,0,e.width,e.height),o=s.getContext("2d",{willReadFrequently:!0}),a=o.getImageData(0,0,s.width,s.height);for(let h=3;h<a.data.length;h+=4)a.data[h]=i.data[h];o.putImageData(a,0,0)}var at={colorize:function(n){let s=document.createElement("canvas");s.width=n.image.width,s.height=n.image.height;let e=s.getContext("2d",{willReadFrequently:!0});e.drawImage(n.image,0,0,n.image.width,n.image.height,0,0,n.image.width,n.image.height),e.globalCompositeOperation="color";let t=document.createElement("canvas");t.width=n.image.width,t.height=n.image.height;let i=t.getContext("2d");if(i.fillStyle=n.color,i.globalAlpha=n.alpha,i.fillRect(0,0,n.image.width,n.image.height),n.regions)for(let o=0;o<n.regions.length;o++){let a=n.regions[o];i.clearRect(a.x,a.y,a.w,a.h),i.fillStyle=a.color?a.color:n.color,i.globalAlpha=a.alpha?a.alpha:n.alpha,i.fillRect(a.x,a.y,a.w,a.h)}return e.drawImage(t,0,0),oi(n.image,s),s},interpolateRGBA:function(n,s,e){let t=n.substring(5,n.length-2).split(","),i=+t[0],o=+t[1],a=+t[2],h=+t[3],l=s.substring(5,s.length-2).split(","),c=+l[0],u=+l[1],m=+l[2],p=+l[3];return"rgba("+[Math.round(i+(c-i)*e),Math.round(o+(u-o)*e),Math.round(a+(m-a)*e),h+(p-h)*e].join(",")+")"}};var Le=class extends ht.EventEmitter{constructor(e){super();r(this,"game");r(this,"images");r(this,"updateDrawn",!1);r(this,"zBuffer",{});r(this,"zBufferKeys",[]);r(this,"overlay",[]);r(this,"frames",0);r(this,"canvases");r(this,"bgCanvas");this.game=e.game,this.images=e.images;let t=this;this.game.on("render",function(){t.updateDrawn=!1});let i=()=>{if(t.updateDrawn===!1){if(t.canvases){let o=t.game.timeRenders&&(t.game.ticks&511)===0;o&&console.time("render");for(let a=0;a<t.canvases.length;a++){let h=t.canvases[a];h.canvas.fill(h.backgroundColor),t.bgCanvas&&h.drawBG(t.bgCanvas),t.game.servers||(h.context.fillStyle="#d4cfb6",h.context.font="14px Arial",h.context.textAlign="center",h.context.fillText("connecting...",Math.round(h.width/2),Math.round(h.height/2-4)));let l=0;for(let c=0;c<t.zBufferKeys.length;c++){let u=t.zBuffer[t.zBufferKeys[c]];for(let m=0;m<u.length;m++)h.drawEntity(u[m]),l++}for(let c=0;c<t.overlay.length;c++)h.drawEntity(t.overlay[c]),l++;t.game.ui&&t.game.ui.emit("draw",h)}o&&console.timeEnd("render")}t.updateDrawn=!0}requestAnimationFrame(i)};requestAnimationFrame(i)}addCanvas(e){e.setRenderer(this),this.canvases||(this.canvases=[]),this.canvases.push(e)}addToZBuffer(e,t){let i=this.zBuffer[t];i?(i.push(e),i.sort((o,a)=>{let h=(o.position?.z||0)+(o.position?.fakeZ||0),l=(a.position?.z||0)+(a.position?.fakeZ||0);return h-l})):this.zBuffer[t]=[e],this.zBufferKeys=Object.keys(this.zBuffer),this.zBufferKeys.sort((o,a)=>parseInt(o)-parseInt(a))}updateZBuffer(e,t,i){this.removeFromZBuffer(t,e),this.addToZBuffer(t,i)}removeFromZBuffer(e,t){let i=this.zBuffer[t];if(i){for(let o=0;o<i.length;o++)if(i[o]===e){i.splice(o,1);break}}}addColorSheet(e){if(this.images[e.color]||(this.images[e.color]={}),!this.images[e.color][e.sheet]){if(e.image=this.images[e.sheet],!e.image){console.error("Renderer.addColorSheet - Base image not found:",e.sheet),console.error("Available images:",Object.keys(this.images));return}this.images[e.color][e.sheet]=at.colorize(e)}}clear(){this.zBuffer={},this.zBufferKeys=[],this.overlay=[]}},ct=Le;E();var ut=P(L(),1);N();var Pe=class extends ut.EventEmitter{constructor(e){super();r(this,"id");r(this,"game");r(this,"backgroundColor");r(this,"scale");r(this,"canvases",[]);r(this,"canvas");r(this,"context");r(this,"width");r(this,"height");r(this,"halfWidth");r(this,"halfHeight");r(this,"panning");r(this,"images");this.id=e.id,this.game=e.game,this.backgroundColor=e.backgroundColor,this.scale=e.initialScale;for(let i=1;i<5;i++){let o=new k(1,1);o.canvas.id=this.id+i,document.body.appendChild(o.canvas),o.canvas.style.transform=`scale(${i}, ${i})`;let a=o.context;a.mozImageSmoothingEnabled!==void 0&&(a.mozImageSmoothingEnabled=!1),a.imageSmoothingEnabled=!1,o.canvas.addEventListener("contextmenu",h=>{h.preventDefault()}),this.canvases.push(o)}this.onZoom(),this.onResize(),window.addEventListener("resize",this.onResize.bind(this)),this.panning={buttons:[],origin:{x:0,y:0},panned:{x:0,y:32}};let t=this;this.game.on("mousedown",i=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=i.x,t.panning.origin.y=i.y),t.panning.buttons.push(i.button))}),this.game.on("mouseup",i=>{W.findAndRemove(i.button,t.panning.buttons)}),this.game.on("mousemove",i=>{let o=i.x-t.panning.origin.x,a=i.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=o,t.panning.panned.y+=a),t.panning.origin.x=i.x,t.panning.origin.y=i.y}),this.game.on("touchstart",i=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=i.x,t.panning.origin.y=i.y),t.panning.buttons.push(i.button))}),this.game.on("touchend",i=>{W.findAndRemove(i.button,t.panning.buttons)}),this.game.on("touchmove",i=>{let o=i.x-t.panning.origin.x,a=i.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=o,t.panning.panned.y+=a),t.panning.origin.x=i.x,t.panning.origin.y=i.y}),this.game.on("mouseout",i=>{}),this.game.on("mouseover",i=>{t.panning.origin.x=i.x,t.panning.origin.y=i.y,i.button||(t.panning.buttons=[])}),this.game.on("mousewheel",i=>{let o=W.clamp(t.scale+(i.direction==="up"?1:-1),1,4);o!==t.scale&&(t.scale=o,t.onZoom(),t.onResize())})}setRenderer(e){this.images=e.images}onResize(){this.width=this.canvas.canvas.width=Math.ceil(window.innerWidth/this.scale),this.height=this.canvas.canvas.height=Math.ceil(window.innerHeight/this.scale),this.halfWidth=Math.round(this.width/2),this.halfHeight=Math.round(this.height/2),this.emit("resize",{scale:this.scale,width:this.width,height:this.height})}onZoom(){for(let e=0;e<this.canvases.length;e++)e+1===this.scale?(this.canvases[e].canvas.style.zIndex="5",this.canvas=this.canvases[e],this.context=this.canvas.context):this.canvases[e].canvas.style.zIndex="1"}draw(){}drawStatic(e){this.context.drawImage(e,0,0)}drawBG(e){if(!e||!e.image){console.error("Canvas: No bgCanvas or bgCanvas.image");return}let t=e.x+this.halfWidth+this.panning.panned.x,i=e.y+this.halfHeight+this.panning.panned.y;if(t>=this.width||i>=this.height||t*-1>=e.image.width||i*-1>=e.image.height)return;let o={x:Math.max(0,t),y:Math.max(0,i)},a={w:Math.min(e.image.width,this.width,this.width-t),h:Math.min(e.image.height,this.height,this.height-i)},h={x:Math.max(0,t*-1),y:Math.max(0,i*-1)},l={x:Math.min(e.image.width,h.x+a.w),y:Math.min(e.image.height,h.y+a.h)},c={x:l.x-h.x,y:l.y-h.y};this.context.drawImage(e.image,h.x,h.y,c.x,c.y,o.x,o.y,c.x,c.y)}drawEntity(e){if(!e||!e.image||e.hidden||e.position&&e.position.z>this.game.hideZ)return;let t={x:e.screen.x+this.halfWidth+this.panning.panned.x+(e.metrics.ox||0),y:e.screen.y+this.halfHeight+this.panning.panned.y+(e.metrics.oy||0)};if(e.keepOnScreen&&(t.x=Math.min(this.width-e.metrics.w,Math.max(0,t.x)),t.y=Math.min(this.height-e.metrics.h,Math.max(0,t.y))),t.x>=this.width||t.y>=this.height||t.x+e.metrics.w<=0||t.y+e.metrics.h<=0)return;let i;if(Array.isArray(e.image)){let h=this.images[e.image[0]];if(!h){console.error("Canvas.drawEntity - Color collection not found for:",e.image[0]),console.error("Available images:",Object.keys(this.images));return}if(i=h[e.image[1]],!i){console.error("Canvas.drawEntity - Colored sprite not found:",e.image),console.error("Available in color collection:",Object.keys(h));return}}else if(typeof e.image=="string"){if(i=this.images[e.image],!i){console.error("Canvas.drawEntity - Image not found:",e.image),console.error("Available images:",Object.keys(this.images));return}}else i=e.image;let o=e===this.game.mouseOver?.sprite;if(o&&(this.context.save(),this.context.shadowColor="rgba(255,255,255,1)",this.context.shadowBlur=3),!e.stay&&e.parent&&this.game.mouseOver!==e.parent)return;if(!isFinite(t.x)||!isFinite(t.y)||!isFinite(e.metrics.x)||!isFinite(e.metrics.y)||!isFinite(e.metrics.w)||!isFinite(e.metrics.h)){console.error("Canvas.drawEntity - NaN detected:",{spriteType:e.constructor?.name||"unknown",spriteParent:e.parent?.constructor?.name||"no parent",spriteParentUsername:e.parent?.username||"no username",spriteParentPosition:e.parent?.position||"no position",spriteImage:typeof e.image=="string"?e.image:"canvas object",screen:{x:t.x,y:t.y},metrics:e.metrics,drawImageParams:[e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h]});return}this.canvas.drawImage(i,e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h),o&&this.context.restore(),this.game.showGrid&&e.grid&&(this.context.fillStyle="#bbbbbb",this.context.font="9px Arial",this.context.fillText(e.grid,Math.round(t.x)+5,Math.round(t.y)+9))}},lt=Pe;var pt=P(L(),1);N();X();var mt=P(L(),1);N();E();var B=class extends mt.EventEmitter{constructor(e){super();r(this,"ui");r(this,"parent");r(this,"elements");r(this,"w");r(this,"h");r(this,"autosize");r(this,"top");r(this,"bottom");r(this,"left");r(this,"right");r(this,"x",0);r(this,"y",0);r(this,"canvas");this.ui=e.ui,this.parent=e.parent,this.elements=[],this.w=1,this.h=1,e.w!==void 0?this.w=e.w:this.autosize=!0,e.h!==void 0?this.h=e.h:this.autosize=!0,e.top!==void 0&&(this.top=e.top),e.bottom!==void 0&&(this.bottom=e.bottom),e.left!==void 0&&(this.left=e.left),e.right!==void 0&&(this.right=e.right),this.canvas=new k(this.w||1,this.h||1),this.reposition()}reposition(){if(!(!this.parent||typeof this.parent.x!="number"||typeof this.parent.y!="number"||typeof this.parent.w!="number"||typeof this.parent.h!="number")&&(this.top!==void 0&&(this.top=="auto"?this.y=Math.round(this.parent.y+this.parent.h/2-this.h/2):this.y=this.parent.y+this.top),this.bottom!==void 0&&(this.y=this.parent.y+this.parent.h-this.h-this.bottom),this.left!==void 0&&(this.left=="auto"?this.x=Math.round(this.parent.x+this.parent.w/2-this.w/2):this.x=this.parent.x+this.left),this.right!==void 0&&(this.x=this.parent.x+this.parent.w-this.w-this.right),this.elements))for(let e=0;e<this.elements.length;e++)this.elements[e].reposition()}redraw(e){e.drawImage(this.canvas.canvas||this.canvas,0,0,this.w,this.h,this.x,this.y,this.w,this.h)}remove(){if(this.ui.mouseOnElement===this&&(this.ui.mouseOnElement=!1),this.removeAllListeners("redraw"),this.removeAllListeners("mouse-on-element"),this.removeAllListeners("mouse-off-element"),g.findAndRemove(this,this.ui.elements),this.elements)for(let e=0;e<this.elements.length;e++)this.elements[e].remove();this.ui.redraw()}resize(e,t){this.w=this.canvas.canvas.width=e,this.h=this.canvas.canvas.height=t,this.draw&&this.draw()}resizeChildren(e,t){if(this.elements)for(let i=0;i<this.elements.length;i++)this.elements[i].resize(e,t)}};X();var Q=class extends B{constructor(e){super(e);r(this,"text");r(this,"textCanvas");r(this,"onPress");r(this,"disabled");r(this,"mouseOn");r(this,"pressed");r(this,"onMouseOnBound");r(this,"onMouseOffBound");r(this,"onMouseDownBound");r(this,"onMouseUpBound");e.text&&this.changeText(e.text),e.onPress&&(this.onPress=e.onPress),e.disabled&&(this.disabled=!0),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=C.blot({text:this.text}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2);let e="rgba("+(this.mouseOn?"77,102,184,0.9)":this.disabled?"245,240,213,0.3)":"0,0,0,0.8)");if(this.canvas.fillRect(e,1,1,this.w-2,this.h-2),this.textCanvas){let t=Math.floor((this.canvas.canvas.width-this.textCanvas.width)/2);this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,t,1,this.textCanvas.width,this.textCanvas.height)}this.emit("redraw")}onMouseOn(e){this.disabled||this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.disabled||!this.mouseOn||(this.mouseOn=!1,this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.disabled||!this.mouseOn||(this.pressed=!0,this.draw())}onMouseUp(e){this.disabled||!this.mouseOn||(this.pressed=!1,this.onPress&&this.onPress(),this.draw())}};var V=class extends B{constructor(s){super(s),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.emit("redraw")}};X();E();var ee=class extends B{constructor(e){super(e);r(this,"text","");r(this,"textCanvas");r(this,"onSubmit");r(this,"focused");r(this,"mouseOn");r(this,"onMouseOnBound");r(this,"onMouseOffBound");r(this,"onMouseDownBound");r(this,"onMouseUpBound");r(this,"onKeyDownBound");this.changeText(e.text||""),e.onSubmit&&(this.onSubmit=e.onSubmit),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound),this.onKeyDownBound=this.onKeyDown.bind(this),this.on("key-down",this.onKeyDownBound)}changeText(e){this.text=e;let t=e+(this.focused?"_":"");this.textCanvas=C.blot({text:t}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear();let e=this.mouseOn?"rgba(220,220,220,0.8)":"rgba(255,255,255,0.8)";e=this.focused?"rgba(115,138,215,0.8)":e,this.canvas.fillRect(e,0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,1,1,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}focus(e){this.focused=e!==!1,this.changeText(this.text)}submit(){this.onSubmit&&this.onSubmit(this.text)}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn||this.focus(!1)}onMouseUp(e){this.mouseOn&&this.focus()}onKeyDown(e){if(!this.focused)return;e.key=="enter"&&this.submit();let t=e.key;if(e.key=="backspace")this.changeText(this.text.substring(0,Math.max(0,this.text.length-1)));else{if(e.key=="period"&&(t="."),e.key=="dash"&&(t="-"),t!="."&&t!="-"&&g.alphabet.indexOf(t)<0&&g.hex.indexOf(t)<0)return;this.changeText(this.text+(this.ui.game.input.keys.shift?t.toUpperCase():t))}}};X();var te=class extends B{constructor(e){super(e);r(this,"text");r(this,"textCanvas");r(this,"onPress");r(this,"hyperlink");r(this,"maxWidth");r(this,"mouseOn");r(this,"pressed");r(this,"onMouseOnBound");r(this,"onMouseOffBound");r(this,"onMouseDownBound");r(this,"onMouseUpBound");e.onPress&&(this.onPress=e.onPress),e.hyperlink&&(this.hyperlink=e.hyperlink),e.maxWidth&&(this.maxWidth=e.maxWidth),e.text&&this.changeText(e.text),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=C.blot({text:this.text,maxWidth:this.maxWidth}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width,this.h=this.canvas.canvas.height=this.textCanvas.height),this.reposition(),this.draw()}draw(){this.canvas.clear(),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,0,0,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.hyperlink&&(document.body.style.cursor="pointer"),this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.hyperlink&&(document.body.style.cursor="default"),this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn&&(this.pressed=!0,this.draw())}onMouseUp(e){this.mouseOn&&(this.pressed=!1,this.onPress&&this.onPress(),this.hyperlink&&this.hyperlink!=="#"&&this.hyperlink!=="javascript:void(0)"&&window.open(this.hyperlink),this.draw())}};var ie=class extends pt.EventEmitter{constructor(e){super();r(this,"game");r(this,"elements",[]);r(this,"x",0);r(this,"y",0);r(this,"w");r(this,"h");r(this,"canvas");r(this,"mouseOnElement",!1);r(this,"boundRedraw");r(this,"boundOnMouseOnElement");r(this,"boundOnMouseOffElement");this.game=e,this.game.renderer?.images?.font&&C.loadImage(this.game.renderer.images.font),this.game.on("resize",this.onResize.bind(this)),this.game.on("mousemove",this.onMouseMove.bind(this)),this.game.on("mousedown",this.onMouseDown.bind(this)),this.game.on("mouseup",this.onMouseUp.bind(this)),this.game.on("keydown",this.onKeyDown.bind(this)),this.game.on("keyup",this.onKeyUp.bind(this)),this.elements=[],this.x=0,this.y=0,this.w=1,this.h=1,this.canvas=new k(1,1);let t=this;this.on("draw",function(i){i.drawStatic(t.canvas.canvas)}),this.boundRedraw=this.redraw.bind(this),this.boundOnMouseOnElement=this.onMouseOnElement.bind(this),this.boundOnMouseOffElement=this.onMouseOffElement.bind(this)}addButton(e){e.parent||(e.parent=this),e.ui=this;let t=new Q(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addPanel(e){e.parent||(e.parent=this),e.ui=this;let t=new V(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t}addInput(e){e.parent||(e.parent=this),e.ui=this;let t=new ee(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addLabel(e){e.parent||(e.parent=this),e.ui=this;let t=new te(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}redraw(){this.canvas.clear();for(let e=0;e<this.elements.length;e++)this.elements[e].redraw(this.canvas)}onMouseMove(e){if(!(this.game.mouseButtons.length>0))for(let t=0;t<this.elements.length;t++){let i=this.elements[t];e.x>=i.x&&e.x<i.x+i.w&&e.y>=i.y&&e.y<i.y+i.h?i.emit("mouse-on",e):i.emit("mouse-off",e)}}onMouseDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-down",e)}onMouseUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-up",e)}onKeyDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-down",e)}onKeyUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-up",e)}onMouseOnElement(e){this.mouseOnElement=e,this.game.mouseOver=!1}onMouseOffElement(e){this.mouseOnElement=this.mouseOnElement===e?!1:this.mouseOnElement}onResize(e){this.w=e.width,this.h=e.height,this.canvas.canvas.width=this.w,this.canvas.canvas.height=this.h;for(let t=0;t<this.elements.length;t++)this.elements[t].reposition();this.redraw()}};var Ct=P(L(),1);E();H();N();var St,Ot,kt,Et,ui=new k(200,100),se,ne=class extends Ct.EventEmitter{constructor(e,t){super();r(this,"game");r(this,"worldSize");r(this,"worldRadius");r(this,"objects",{});r(this,"map",{});r(this,"walkable",{});r(this,"mapBounds",{xl:0,yl:0,xh:0,yh:0});r(this,"staticMap",[]);r(this,"islands",[]);r(this,"mainIsland",0);r(this,"tileMap",{});this.game=e,this.game.world=this,this.worldSize=Math.max(24,Math.floor(t/2)*2),this.worldRadius=Math.floor(this.worldSize/2),this.init()}async init(){try{let[e,t,i,o]=await Promise.all([Promise.resolve().then(()=>(bt(),gt)),Promise.resolve().then(()=>(xt(),vt)),Promise.resolve().then(()=>(Ne(),yt)),Promise.resolve().then(()=>(Re(),Mt))]);St=e.default,Ot=t.default,kt=i.default,Et=o.default,this.generateWorld()}catch(e){throw console.error("World: Failed to load world dependencies:",e),e instanceof Error&&console.error("World: Error stack:",e.stack),e}}generateWorld(){v.generateClosestGrids(this.worldSize),ui.clear();let e=v.buildNoiseMap(this.worldRadius/3+1,this.worldRadius/3+1),t=v.buildNoiseMap(this.worldRadius/1.5+1,this.worldRadius/1.5+1),i=(e.length-1)/this.worldSize,o=(t.length-1)/this.worldSize;this.mapBounds={xl:0,yl:0,xh:0,yh:0};for(let h=0;h<this.worldSize;h++)for(let l=0;l<this.worldSize;l++){let c=v.getNoiseMapPoint(e,h*i,l*i),u=v.getNoiseMapPoint(t,h*o,l*o),m=(c+u*2)/3,p=h-this.worldRadius,f=l-this.worldRadius,w=(this.worldRadius-(Math.abs(p)+Math.abs(f))/2)/this.worldRadius;if(m/1.1<w){this.mapBounds.xl=Math.min(p,this.mapBounds.xl),this.mapBounds.yl=Math.min(f,this.mapBounds.yl),this.mapBounds.xh=Math.max(p,this.mapBounds.xh),this.mapBounds.yh=Math.max(f,this.mapBounds.yh);let M=new St("grass",p,f,-.5);M.grid=p+":"+f,this.map[p+":"+f]=M,M.addToGame(this.game)}}console.log("World: Generated",Object.keys(this.map).length,"slab tiles"),this.staticMap=[],this.crawlMap(),this.createTiles(),this.createBackground(),Et.loadMap(this.walkable),se=Object.keys(this.map);let a=se.indexOf("0:0");a>-1&&se.splice(a,1),console.log("Created world with",Object.keys(this.map).length,"tiles")}createBackground(){console.log("World: createBackground - Starting with",this.staticMap.length,"tiles");let e=0,t=0,i=0,o=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y};u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,e=e<u.x?e:u.x,t=t<u.y?t:u.y,i=i>u.x?i:u.x,o=o>u.y?o:u.y}console.log("World: createBackground - Screen bounds:",{lowestScreenX:e,lowestScreenY:t,highestScreenX:i,highestScreenY:o});let a=new k(i-e+32+1,o-t+32+9),h=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y},m=!isFinite(c.screen.x)||!isFinite(c.screen.y)||!isFinite(c.sprite.metrics.ox||0)||!isFinite(c.sprite.metrics.oy||0);if((l<3||m)&&console.log(`World: createBackground - Tile ${l} data:`,{"tile.screen":c.screen,"tile.sprite":c.sprite,"tile.sprite.metrics":c.sprite.metrics,"screen before offset":{x:u.x,y:u.y},hasNaN:m}),u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,u.x-=e,u.y-=t,!isFinite(u.x)||!isFinite(u.y)){console.error(`World: createBackground - NaN detected for tile ${l}:`,{"original tile.screen":{x:c.screen.x,y:c.screen.y},"tile.sprite.metrics.ox":c.sprite.metrics.ox,"tile.sprite.metrics.oy":c.sprite.metrics.oy,lowestScreenX:e,lowestScreenY:t,"final screen":u});continue}let p=this.game.renderer.images[c.sprite.image];if(!p){console.error("World: createBackground - Missing image for tile:",c.sprite.image);continue}a.drawImage(p,c.sprite.metrics.x,c.sprite.metrics.y,c.sprite.metrics.w,c.sprite.metrics.h,Math.round(u.x),Math.round(u.y),c.sprite.metrics.w,c.sprite.metrics.h),h++,l<5&&console.log("World: createBackground - Drew tile",l,":",{image:c.sprite.image,sourceRect:`${c.sprite.metrics.x},${c.sprite.metrics.y} ${c.sprite.metrics.w}x${c.sprite.metrics.h}`,destPos:`${Math.round(u.x)},${Math.round(u.y)}`})}this.game.renderer.bgCanvas={x:e,y:t,image:a.canvas}}crawlMap(){this.islands=[];let e={},t=0;for(let i=this.mapBounds.xl;i<=this.mapBounds.xh;i++)for(let o=this.mapBounds.yl;o<=this.mapBounds.yh;o++){let a=this.map[i+":"+o];if(!a||e[a.grid])continue;let h=[];for(;;){e[a.grid]=a,this.islands[t]?this.islands[t].push(a):this.islands.push([a]);let l=v.getNeighbors(a.grid);for(let c in l){if(!l.hasOwnProperty(c))continue;let u=this.map[l[c]];if(!u){a.border=!0;continue}e[u.grid]||h.push(u)}if(h.length>0)a=h.pop();else{t++;break}}}this.mainIsland=0;for(let i=1;i<this.islands.length;i++)this.mainIsland=this.islands[i].length>this.islands[this.mainIsland].length?i:this.mainIsland;for(let i=0;i<this.islands.length;i++)if(i!=this.mainIsland)for(let o=0;o<this.islands[i].length;o++)delete this.map[this.islands[i][o].grid],this.islands[i][o].remove();for(let i in this.map){if(!this.map.hasOwnProperty(i))continue;let o=this.map[i];if(o.border)o.style="plain";else{let a=v.get8Neighbors(o.grid);for(let h in a)if(a.hasOwnProperty(h)&&!this.map[a[h]]){o.style="plain";break}}}this.map["0:0"]&&(this.map["0:0"].style="plain"),this.map["1:0"]&&(this.map["1:0"].style="plain"),this.map["-1:0"]&&(this.map["-1:0"].style="plain"),this.map["0:1"]&&(this.map["0:1"].style="plain"),this.map["0:-1"]&&(this.map["0:-1"].style="plain"),this.createFlowerPatches()}createFlowerPatches(){for(let e=0;e<Math.ceil(Math.pow(this.worldRadius,2)/80);e++){let t=0,i,o;do{if(o=!0,i=this.map[g.pickInObject(this.map)],!i)continue;let h=v.get8Neighbors(i.grid);for(let l in h){if(!h.hasOwnProperty(l))continue;let c=this.map[h[l]];if(!c||c.style!="grass"){o=!1;break}}t++}while(t<1e3&&(i.style!="grass"||!o));if(t==1e3)continue;i.style="flowers";let a=g.randomIntRange(1,4);for(let h=0;h<a;h++){let l=!0,c=i.position.x+g.randomIntRange(-1,1),u=i.position.y+g.randomIntRange(-1,1),m=this.map[c+":"+u];if(!m)continue;let p=v.get8Neighbors(m.grid);for(let f in p){if(!p.hasOwnProperty(f))continue;let w=this.map[p[f]];if(!w||w.style!="grass"&&w.style!="flowers"){l=!1;break}}l&&(m.style="flowers")}}}createTiles(){this.tileMap={};let e=this;function t(a){return e.map[a].style[0].replace(/p/,"s").toUpperCase()}function i(a,h){return a==h?t(a):e.map[h]?t(h):"E"}function o(a,h,l,c){let u=h.grids,m=i(a,u[0])+"-"+i(a,u[1])+"-"+i(a,u[2])+"-"+i(a,u[3]);return new kt("tile").map[m]||console.error("unknown tile code",m,u),{tileCode:m,position:h,grid:l,game:c}}for(let a in this.map){if(!this.map.hasOwnProperty(a))continue;let h=+a.split(":")[0],l=+a.split(":")[1],c=this.map[a].position.z,u=v.get8Neighbors(a),m={x:h-.5,y:l-.5,z:c,grids:[u.nw,u.n,a,u.w]},p={x:h+.5,y:l-.5,z:c,grids:[u.n,u.ne,u.e,a]},f={x:h+.5,y:l+.5,z:c,grids:[a,u.e,u.se,u.s]},w={x:h-.5,y:l+.5,z:c,grids:[u.w,a,u.s,u.sw]},M=[m,p,f,w];for(let O=0;O<M.length;O++){let x=c+":"+M[O].x+":"+M[O].y;this.tileMap[x]||(this.tileMap[x]=new Ot(o(a,M[O],x,this.game)),this.staticMap.push(this.tileMap[x]))}}this.staticMap.sort(function(a,h){return a.zDepth-h.zDepth})}addToWorld(e){if(this.objects[e.position.x])if(this.objects[e.position.x][e.position.y]){if(this.objects[e.position.x][e.position.y][e.position.z])return console.error("occupado!",e.position.x,e.position.y,e.position.z,e,this.objects[e.position.x][e.position.y][e.position.z]),!1}else this.objects[e.position.x][e.position.y]={};else this.objects[e.position.x]={},this.objects[e.position.x][e.position.y]={};return this.objects[e.position.x][e.position.y][e.position.z]=e,this.updateWalkable(e.position.x,e.position.y),!0}removeFromWorld(e){this.objects[e.position.x]?.[e.position.y]?.[e.position.z]&&(delete this.objects[e.position.x][e.position.y][e.position.z],this.updateWalkable(e.position.x,e.position.y))}moveObject(e,t,i,o){this.removeFromWorld(e),e.position.x=t,e.position.y=i,e.position.z=o,this.addToWorld(e)}updateWalkable(e,t){let i=this.objects[e]?.[t];if(!i||Object.keys(i).length==0){delete this.walkable[e+":"+t];return}let o=Object.keys(i).sort(function(h,l){return+h-+l}),a=i[+o[o.length-1]];if(a.unWalkable)delete this.walkable[e+":"+t];else{let h=a.position.z+a.height;this.walkable[e+":"+t]=h}}canWalk(e,t){if(!this.map[e+":"+t])return!1;let o=this.walkable[e+":"+t],a=this.objects[e]?.[t];if(!a||Object.keys(a).length===0)return!0;let h=Object.keys(a).sort((u,m)=>+u-+m);return!a[+h[h.length-1]].unWalkable}getHeight(e,t){let i=this.walkable[e+":"+t];if(i!==void 0)return i;let o=this.map[e+":"+t];return o?o.position.z+o.height:-.5}randomEmptyGrid(){return se.splice(g.randomIntRange(0,se.length-1),1)[0]}objectAtXYZ(e,t,i){return this.objects[e]?.[t]?.[i]||null}objectUnderXYZ(e,t,i){let o=this.objects[e]?.[t];if(!o)return null;let a=-1e3;for(let h in o)o.hasOwnProperty(h)&&(+h>i||(a=+h>a?+h:a));return o[a]||null}findObject(e){for(let t in this.objects){if(!this.objects.hasOwnProperty(t))continue;let i=this.objects[t];for(let o in i){if(!i.hasOwnProperty(o))continue;let a=i[o];for(let h in a)if(a.hasOwnProperty(h)&&e===a[h])return[t,o,h]}}return null}};var Nt=P(L(),1);var xe,We=null,ae=class extends Nt.EventEmitter{constructor(e,t){super();r(this,"game");r(this,"world");r(this,"actors",{});r(this,"messageQueue",{});this.setMaxListeners(0),this.game=e,this.game.once("destroy",this.destroy.bind(this)),this.game.users=this,this.world=t,this.actors={},this.messageQueue={},We=this.loadActor()}async loadActor(){try{xe=(await Promise.resolve().then(()=>(Dt(),It))).default}catch(e){throw console.error("Failed to load Actor class:",e),e}}async addActor(e){if(!xe&&We&&await We,!xe){console.error("\u274C Actor class not loaded yet");return}let t=this.world.randomEmptyGrid(),i=new xe({x:+t.split(":")[0],y:+t.split(":")[1],z:0,uid:e.uid,username:e.username,roleColor:e.roleColor,maxListeners:this.getMaxListeners()+3});this.actors[i.uid]=i,i.addToGame(this.game),i.updatePresence(e.status)}async updateActor(e){let t=this.actors[e.uid];t?e.delete?(t.updatePresence("offline"),this.removeActor(t)):t.updatePresence(e.status):await this.addActor(e)}removeActor(e){delete this.actors[e.uid],e.remove()}queueMessage(e){!e.message||!this.actors[e.uid]||(this.messageQueue[e.channel]||(this.messageQueue[e.channel]={busy:!1,messages:[]}),this.messageQueue[e.channel].messages.push({uid:e.uid,message:e.message}),this.onMessageAdded(e.channel))}onMessageAdded(e){let t=this.messageQueue[e];if(t.busy||t.messages.length<1)return;t.busy=!0;let i=t.messages[0],o=this;this.actors[i.uid].startTalking(i.message,e,function(){o.messageQueue[e].messages.shift(),o.messageQueue[e].busy=!1,o.onMessageAdded(e)}),this.emit("message",{user:this.actors[i.uid],channel:e})}getActorAtPosition(e,t,i){for(let o in this.actors)if(this.actors.hasOwnProperty(o)&&this.actors[o].position.x==e&&this.actors[o].position.y==t&&this.actors[o].position.z==i)return this.actors[o]}destroy(){this.actors={},this.messageQueue={}}};var Ut=P(L(),1);H();var Fe,je,he=class extends Ut.EventEmitter{constructor(e,t){super();r(this,"game");r(this,"world");r(this,"beacon");this.game=e,this.world=t,this.game.decorator=this,this.init()}async init(){try{let[e,t]=await Promise.all([Promise.resolve().then(()=>(Rt(),At)),Promise.resolve().then(()=>(Wt(),Gt))]);Fe=e.default,je=t.default,this.createBeacon()}catch(e){throw console.error("Failed to load decorator dependencies:",e),e}}sewSeed(e){if(!je){console.error("Seed class not loaded yet");return}let t;for(let o=0;o<v.closestGrids.length;o++){let a=v.closestGrids[o],h=this.world.map[e.origin.x+a[0]+":"+(e.origin.y+a[1])];if(!(!h||h.style=="plain")&&!this.world.objectAtXYZ(h.position.x,h.position.y,h.position.z+h.height)){t=h.position;break}}if(!t)return;new je({origin:e.origin,destination:{x:t.x,y:t.y,z:t.z+.5}}).addToGame(this.game)}createBeacon(){if(!Fe){console.error("Beacon class not loaded yet");return}this.beacon=new Fe(0,0,0),this.beacon.addToGame(this.game)}};var _e={name:"d-zone",version:"0.1.0",description:"An ambient life simulation driven by the user activity within a Discord server",type:"module",main:"index.ts",exports:{".":"./index.ts"},dependencies:{express:"^5.1.0",inherits:"^2.0.4",raf:"^3.4.1",ws:"^8.13.0"},devDependencies:{"@playwright/test":"^1.40.0","@types/express":"^4.17.23","@types/node":"^20.19.17","@types/ws":"^8.18.1","@vitest/ui":"^1.6.0","allure-commandline":"^2.24.1","allure-playwright":"^2.9.2","allure-vitest":"^2.15.1",concurrently:"^9.2.1",esbuild:"^0.25.10",events:"^3.3.0",jsdom:"^24.0.0",msw:"^2.0.0","ts-node":"^10.9.2",typescript:"^5.9.2",vitest:"^1.6.0"},scripts:{"build:dev":"esbuild src/main.ts --bundle --sourcemap --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path","build:prod":"esbuild src/main.ts --bundle --minify --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path",dev:'concurrently "npm run watch" "npm start"',prestart:"npm run build:dev",start:"node server.mjs","start:ts":"ts-node --esm index.ts",test:"vitest run && playwright test","test:unit":"vitest run","test:unit:watch":"vitest","test:unit:ui":"vitest --ui","test:e2e":"playwright test","test:e2e:headed":"playwright test --headed","test:e2e:debug":"playwright test --debug","test:ci":"npm run test -- --project=ci","test:report":"allure generate --clean && allure open","test:report:generate":"allure generate --clean","type-check":"tsc --noEmit",watch:"esbuild src/main.ts --bundle --sourcemap --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path --watch"},repository:{type:"git",url:"git+https://github.com/NNTin/d-zone.git"},keywords:["discord","Discord","isometric","canvas"],author:"Tin Nguyen",contributors:["Devin Spikowski (https://github.com/vegeta897)"],license:"ISC",bugs:{url:"https://github.com/NNTin/d-zone/issues"},homepage:"https://nntin.github.io/d-zone"};var jt,xi,d,J,b;console.log("Loading...");jt=_e.version;xi=new Xe(wi);function wi(n){console.log("Initializing game with images:",Object.keys(n)),d=new ot({step:1e3/60}),d.renderer=new ct({game:d,images:n});let s=new lt({id:"main",game:d,initialScale:2,backgroundColor:"#181213"});d.renderer.addCanvas(s),d.bindCanvas(s),d.ui=new ie(d),Mi(),Si(),d.renderer.canvases[0].onResize(),Oi(),window.pause=function(){d.paused=!0},window.unpause=function(){d.paused=!1},window.game=d}function Ft(n){console.log("Reinitializing Discord OAuth with new client ID:",n);let s=b&&b.isLoggedIn(),e=b?b.getUser():null,t=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";b=new ze({clientId:n,redirectUri:t,scopes:["identify"]}),_t(),s&&e&&console.log("Discord OAuth client ID updated. User may need to re-authenticate if they encounter issues."),console.log("Discord OAuth reinitialized successfully")}function _t(){let n=b.login;b.login=function(){let s=this.getAuthUrl();return console.log("Discord OAuth URL:",s),console.log("Opening Discord OAuth popup..."),n.call(this)},b.on("login-success",function(s){console.log("Discord login successful:",s),localStorage.setItem("discord_user",JSON.stringify(s)),d.pendingServerJoin&&(ce(d.pendingServerJoin),delete d.pendingServerJoin),d.helpPanel&&(d.helpPanel.remove(),delete d.helpPanel,setTimeout(function(){d.helpButton&&d.helpButton.onPress&&d.helpButton.onPress()},100))}),b.on("login-error",function(s){console.error("Discord login error:",s),window.alert("Discord login failed: "+s)}),b.on("login-cancelled",function(){console.log("Discord login cancelled by user")}),b.on("logout",function(){console.log("Discord logout"),d.helpPanel&&(d.helpPanel.remove(),delete d.helpPanel,setTimeout(function(){d.helpButton&&d.helpButton.onPress&&d.helpButton.onPress()},100))})}function Mi(){let n=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";console.log("Discord OAuth redirect URI:",n),console.log("Current location:",window.location.href),console.log("Window origin:",window.location.origin),console.log("Window pathname:",window.location.pathname),fetch(n).then(function(s){console.log("Callback page test - Status:",s.status),s.ok?console.log("\u2713 Callback page is accessible"):console.error("\u2717 Callback page not accessible - Status:",s.status)}).catch(function(s){console.error("\u2717 Callback page test failed:",s)}),b=new ze({clientId:"506432803173433344",redirectUri:n,scopes:["identify"]}),_t()}function Si(){d.helpButton=d.ui.addButton({text:"?",bottom:3,right:3,w:18,h:18,onPress:function(){if(d.serverListPanel&&(d.serverListPanel.remove(),delete d.serverListPanel),d.helpPanel){d.helpPanel.remove(),delete d.helpPanel;return}d.helpPanel=d.ui.addPanel({left:"auto",top:"auto",w:200,h:130}),d.ui.addLabel({text:"D-Zone (fork) "+jt,top:5,left:"auto",parent:d.helpPanel}),d.ui.addLabel({text:_e.description,top:20,left:2,maxWidth:196,parent:d.helpPanel}),d.ui.addLabel({text:"This is a fork of D-Zone (originally by Vegeta897). It follows its own versioning and is not published on npm.",top:50,left:2,maxWidth:196,parent:d.helpPanel}),d.ui.addLabel({text:":icon-npm: View on npm",hyperlink:"https://www.npmjs.com/package/d-zone",top:90,left:8,parent:d.helpPanel}),d.ui.addLabel({text:"View original :icon-github:",hyperlink:"https://github.com/d-zone-org/d-zone",top:90,right:8,parent:d.helpPanel}),d.ui.addLabel({text:"View fork :icon-github:",hyperlink:"https://github.com/nntin/d-zone",top:110,right:8,parent:d.helpPanel});let n=b&&b.isLoggedIn(),s=b&&b.getUser();n&&s?(d.ui.addLabel({text:`Logged in as: ${s.username}`,top:130,left:2,parent:d.helpPanel}),d.ui.addButton({text:"Logout Discord",top:150,left:2,w:80,h:16,parent:d.helpPanel,onPress:function(){b.logout()}})):(d.ui.addButton({text:"Login Discord",top:130,left:2,w:80,h:16,parent:d.helpPanel,onPress:function(){b.login()}}),d.ui.addLabel({text:"Login required for private servers",top:150,left:2,maxWidth:196,parent:d.helpPanel})),d.helpPanel.resize(200,170)}})}function Oi(){let n,s,e;function t(){n&&n.removeAllListeners&&n.removeAllListeners(),s&&s.removeAllListeners&&s.removeAllListeners(),e&&e.removeAllListeners&&e.removeAllListeners()}let i=[],o=g.getURLParameter("socketURL");o&&i.push({url:o,description:"URL parameter"});let a="wss://"+window.location.hostname+window.location.pathname;a=a.replace(/\/$/,"")+"/ws",i.push({url:a,description:"current hostname and pathname"}),i.push({url:"wss://hermes.nntin.xyz/dzone",description:"Hermes fallback server"});let h=0;function l(){if(h>=i.length){console.error("All websocket connection strategies failed");return}let c=i[h];console.log("Attempting websocket connection strategy "+(h+1)+"/"+i.length+": "+c.description+" ("+c.url+")"),J=new WebSocket(c.url),J.addEventListener("message",function(u){let m=JSON.parse(u.data);if(e&&e.beacon.ping(),m.type==="server-list"){d.servers=m.data,console.log("Got server list:",d.servers),d.ui.addButton({text:"Server",top:3,right:3,onPress:function(){if(d.helpPanel&&(d.helpPanel.remove(),delete d.helpPanel),d.serverListPanel){d.serverListPanel.remove(),delete d.serverListPanel;return}let w=function(I){return function(){if(I.passworded&&(!b||!b.isLoggedIn())){d.pendingServerJoin=I,window.alert("This server requires Discord authentication. Please login with Discord first.");return}let q="?s="+I.id;window.location.protocol!=="file:"&&window.history.pushState({server:I.id},I.id,window.location.pathname+q),ce(I),d.serverListPanel.remove(),delete d.serverListPanel}};d.serverListPanel=d.ui.addPanel({left:"auto",top:"auto",w:146,h:28+21*(Object.keys(d.servers||{}).length-1)});let M=136,O=0,x;for(let I in d.servers){if(!d.servers||!d.servers.hasOwnProperty(I))continue;let q=d.servers[I],Xt=q.passworded?":icon-lock-small: ":"";x=d.ui.addButton({text:Xt+d.servers[I].name,left:5,top:5+O*21,w:136,h:18,parent:d.serverListPanel,onPress:w(q),disabled:d.server===q.id}),M=Math.max(M,x.textCanvas.width+2),O++}d.serverListPanel.resize(M+10,d.serverListPanel.h),d.serverListPanel.resizeChildren(M,x.h),d.serverListPanel.reposition()}});let p=ki(),f=d.servers?.[p.id];!f||!f.passworded||b&&b.isLoggedIn()?ce(p):d.pendingServerJoin=p}else if(m.type==="server-join"){let p=m.data.request.server;localStorage.setItem("dzone-default-server",JSON.stringify({id:p})),m.data.clientId&&b&&(console.log("Setting Discord OAuth client ID from server-join:",m.data.clientId),Ft(m.data.clientId)),t(),d.reset(),d.renderer.clear();let f=m.data.users;d.server=p,s=new ne(d,Math.round(3.3*Math.sqrt(Object.keys(f).length))),e=new he(d,s),d.decorator=e,n=new ae(d,s);let w="?s="+m.data.request.server;window.location.protocol!=="file:"&&window.history.replaceState(m.data.request,p,window.location.pathname+w);let M=Object.keys(f).length;d.setMaxListeners(M+100),n.setMaxListeners(M+50),s&&s.setMaxListeners&&s.setMaxListeners(M+50),e&&e.setMaxListeners&&e.setMaxListeners(M+50);for(let O in f)f.hasOwnProperty(O)&&f[O].username&&n&&n.addActor(f[O]);console.log((n?Object.keys(n.actors).length:0).toString()+" actors created"),d.renderer.canvases[0].onResize()}else if(m.type==="presence")n&&n.updateActor(m.data);else if(m.type==="message")n.queueMessage(m.data);else if(m.type==="error")window.alert(m.data.message),d.world||ce({id:"default"});else if(m.type==="update-clientid"&&(console.log("Received client ID update:",m.data.clientId),m.data.clientId&&b&&(Ft(m.data.clientId),d&&d.ui))){let p=d.ui.addPanel({left:"auto",top:50,w:250,h:60,backgroundColor:"#2c3e50"});d.ui.addLabel({text:"\u{1F504} Discord OAuth Updated",top:5,left:"auto",parent:p,color:"#ecf0f1"}),d.ui.addLabel({text:"Discord login configuration has been updated.",top:25,left:5,maxWidth:240,parent:p,color:"#bdc3c7"}),setTimeout(function(){p&&p.remove&&p.remove()},5e3)}}),J.addEventListener("open",function(){console.log("\u2713 Websocket connected successfully using strategy: "+c.description+" ("+c.url+")")}),J.addEventListener("close",function(){console.log("Websocket disconnected from: "+c.description),t(),h===i.indexOf(c)&&(h++,setTimeout(l,1e3))}),J.addEventListener("error",function(u){console.log("Websocket error with strategy "+(h+1)+"/"+i.length+" ("+c.description+"):",u),h===i.indexOf(c)&&(h++,setTimeout(l,1e3))})}l()}window.onpopstate=function(n){let s={id:n.state?.server};ce(s)};function ce(n){let s={type:"connect",data:{server:n.id}},e=null;if(d.servers){for(let t in d.servers)if(d.servers.hasOwnProperty(t)&&d.servers[t].id===n.id){e=d.servers[t];break}}console.log("Server lookup result:",{requestedServerId:n.id,foundServerData:e,allServers:d.servers}),e&&e.passworded&&b&&b.isLoggedIn()?(s.data.discordToken=b.accessToken,s.data.discordUser=b.getUser(),console.log("Sending Discord OAuth data:",{token:b.accessToken?b.accessToken.substring(0,10)+"...":"null",user:b.getUser()})):console.log("Not sending Discord OAuth data. Conditions:",{serverFound:!!e,serverPassworded:e?e.passworded:"unknown",discordAuthExists:!!b,discordLoggedIn:b?b.isLoggedIn():!1}),console.log("Requesting to join server",n.id,"with message:",s),J.send(JSON.stringify(s))}function ki(){let n={id:g.getURLParameter("s")};if(!n.id){let s=localStorage.getItem("dzone-default-server");s&&(n=JSON.parse(s))}return n||(n={id:"default"}),n}})();
