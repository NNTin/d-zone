"use strict";(()=>{var xi=Object.create;var Me=Object.defineProperty;var Mi=Object.getOwnPropertyDescriptor;var Si=Object.getOwnPropertyNames;var Oi=Object.getPrototypeOf,ki=Object.prototype.hasOwnProperty;var Ei=(s,i,e)=>i in s?Me(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var T=(s,i)=>()=>(s&&(i=s(s=0)),i);var Ge=(s,i)=>()=>(i||s((i={exports:{}}).exports,i),i.exports),H=(s,i)=>{for(var e in i)Me(s,e,{get:i[e],enumerable:!0})},Ti=(s,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of Si(i))!ki.call(s,n)&&n!==e&&Me(s,n,{get:()=>i[n],enumerable:!(t=Mi(i,n))||t.enumerable});return s};var B=(s,i,e)=>(e=s!=null?xi(Oi(s)):{},Ti(i||!s||!s.__esModule?Me(e,"default",{value:s,enumerable:!0}):e,s));var a=(s,i,e)=>Ei(s,typeof i!="symbol"?i+"":i,e);var pt=Ge((On,ft)=>{"use strict";function Ci(s){try{return JSON.stringify(s)}catch{return'"[Circular]"'}}ft.exports=Li;function Li(s,i,e){var t=e&&e.stringify||Ci,n=1;if(typeof s=="object"&&s!==null){var r=i.length+n;if(r===1)return s;var o=new Array(r);o[0]=t(s);for(var h=1;h<r;h++)o[h]=t(i[h]);return o.join(" ")}if(typeof s!="string")return s;var l=i.length;if(l===0)return s;for(var c="",u=1-n,m=-1,p=s&&s.length||0,f=0;f<p;){if(s.charCodeAt(f)===37&&f+1<p){switch(m=m>-1?m:0,s.charCodeAt(f+1)){case 100:case 102:if(u>=l||i[u]==null)break;m<f&&(c+=s.slice(m,f)),c+=Number(i[u]),m=f+2,f++;break;case 105:if(u>=l||i[u]==null)break;m<f&&(c+=s.slice(m,f)),c+=Math.floor(Number(i[u])),m=f+2,f++;break;case 79:case 111:case 106:if(u>=l||i[u]===void 0)break;m<f&&(c+=s.slice(m,f));var M=typeof i[u];if(M==="string"){c+="'"+i[u]+"'",m=f+2,f++;break}if(M==="function"){c+=i[u].name||"<anonymous>",m=f+2,f++;break}c+=t(i[u]),m=f+2,f++;break;case 115:if(u>=l)break;m<f&&(c+=s.slice(m,f)),c+=String(i[u]),m=f+2,f++;break;case 37:m<f&&(c+=s.slice(m,f)),c+="%",m=f+2,f++,u--;break}++u}++f}return m===-1?s:(m<p&&(c+=s.slice(m)),c)}});var Mt=Ge((kn,Oe)=>{"use strict";var bt=pt();Oe.exports=_;var le=Xi().console||{},zi={mapHttpRequest:Se,mapHttpResponse:Se,wrapRequestSerializer:_e,wrapResponseSerializer:_e,wrapErrorSerializer:_e,req:Se,res:Se,err:yt,errWithCause:yt};function U(s,i){return s==="silent"?1/0:i.levels.values[s]}var Fe=Symbol("pino.logFuncs"),je=Symbol("pino.hierarchy"),Pi={error:"log",fatal:"error",warn:"error",info:"log",debug:"log",trace:"log"};function vt(s,i){let e={logger:i,parent:s[je]};i[je]=e}function Di(s,i,e){let t={};i.forEach(n=>{t[n]=e[n]?e[n]:le[n]||le[Pi[n]||"log"]||Q}),s[Fe]=t}function Ii(s,i){return Array.isArray(s)?s.filter(function(t){return t!=="!stdSerializers.err"}):s===!0?Object.keys(i):!1}function _(s){s=s||{},s.browser=s.browser||{};let i=s.browser.transmit;if(i&&typeof i.send!="function")throw Error("pino: transmit option must have a send function");let e=s.browser.write||le;s.browser.write&&(s.browser.asObject=!0);let t=s.serializers||{},n=Ii(s.browser.serialize,t),r=s.browser.serialize;Array.isArray(s.browser.serialize)&&s.browser.serialize.indexOf("!stdSerializers.err")>-1&&(r=!1);let o=Object.keys(s.customLevels||{}),h=["error","fatal","warn","info","debug","trace"].concat(o);typeof e=="function"&&h.forEach(function(b){e[b]=e}),(s.enabled===!1||s.browser.disabled)&&(s.level="silent");let l=s.level||"info",c=Object.create(e);c.log||(c.log=Q),Di(c,h,e),vt({},c),Object.defineProperty(c,"levelVal",{get:m}),Object.defineProperty(c,"level",{get:p,set:f});let u={transmit:i,serialize:n,asObject:s.browser.asObject,asObjectBindingsOnly:s.browser.asObjectBindingsOnly,formatters:s.browser.formatters,levels:h,timestamp:Wi(s),messageKey:s.messageKey||"msg",onChild:s.onChild||Q};c.levels=Bi(s),c.level=l,c.isLevelEnabled=function(b){return this.levels.values[b]?this.levels.values[b]>=this.levels.values[this.level]:!1},c.setMaxListeners=c.getMaxListeners=c.emit=c.addListener=c.on=c.prependListener=c.once=c.prependOnceListener=c.removeListener=c.removeAllListeners=c.listeners=c.listenerCount=c.eventNames=c.write=c.flush=Q,c.serializers=t,c._serialize=n,c._stdErrSerialize=r,c.child=function(...b){return M.call(this,u,...b)},i&&(c._logEvent=We());function m(){return U(this.level,this)}function p(){return this._level}function f(b){if(b!=="silent"&&!this.levels.values[b])throw Error("unknown level "+b);this._level=b,K(this,u,c,"error"),K(this,u,c,"fatal"),K(this,u,c,"warn"),K(this,u,c,"info"),K(this,u,c,"debug"),K(this,u,c,"trace"),o.forEach(w=>{K(this,u,c,w)})}function M(b,w,v){if(!w)throw new Error("missing bindings for child Pino");v=v||{},n&&w.serializers&&(v.serializers=w.serializers);let S=v.serializers;if(n&&S){var E=Object.assign({},t,S),L=s.browser.serialize===!0?Object.keys(E):n;delete w.serializers,Ue([w],L,E,this._stdErrSerialize)}function $(xe){this._childLevel=(xe._childLevel|0)+1,this.bindings=w,E&&(this.serializers=E,this._serialize=L),i&&(this._logEvent=We([].concat(xe._logEvent.bindings,w)))}$.prototype=this;let G=new $(this);return vt(this,G),G.child=function(...xe){return M.call(this,b,...xe)},G.level=v.level||this.level,b.onChild(G),G}return c}function Bi(s){let i=s.customLevels||{},e=Object.assign({},_.levels.values,i),t=Object.assign({},_.levels.labels,Ai(i));return{values:e,labels:t}}function Ai(s){let i={};return Object.keys(s).forEach(function(e){i[s[e]]=e}),i}_.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}};_.stdSerializers=zi;_.stdTimeFunctions=Object.assign({},{nullTime:wt,epochTime:xt,unixTime:Fi,isoTime:Ui});function Ni(s){let i=[];s.bindings&&i.push(s.bindings);let e=s[je];for(;e.parent;)e=e.parent,e.logger.bindings&&i.push(e.logger.bindings);return i.reverse()}function K(s,i,e,t){if(Object.defineProperty(s,t,{value:U(s.level,e)>U(t,e)?Q:e[Fe][t],writable:!0,enumerable:!0,configurable:!0}),s[t]===Q){if(!i.transmit)return;let r=i.transmit.level||s.level,o=U(r,e);if(U(t,e)<o)return}s[t]=Gi(s,i,e,t);let n=Ni(s);n.length!==0&&(s[t]=Ri(n,s[t]))}function Ri(s,i){return function(){return i.apply(this,[...s,...arguments])}}function Gi(s,i,e,t){return(function(n){return function(){let o=i.timestamp(),h=new Array(arguments.length),l=Object.getPrototypeOf&&Object.getPrototypeOf(this)===le?le:this;for(var c=0;c<h.length;c++)h[c]=arguments[c];var u=!1;if(i.serialize&&(Ue(h,this._serialize,this.serializers,this._stdErrSerialize),u=!0),i.asObject||i.formatters?n.call(l,..._i(this,t,h,o,i)):n.apply(l,h),i.transmit){let m=i.transmit.level||s._level,p=U(m,e),f=U(t,e);if(f<p)return;ji(this,{ts:o,methodLevel:t,methodValue:f,transmitLevel:m,transmitValue:e.levels.values[i.transmit.level||s._level],send:i.transmit.send,val:U(s._level,e)},h,u)}}})(s[Fe][t])}function _i(s,i,e,t,n){let{level:r,log:o=m=>m}=n.formatters||{},h=e.slice(),l=h[0],c={},u=(s._childLevel|0)+1;if(u<1&&(u=1),t&&(c.time=t),r){let m=r(i,s.levels.values[i]);Object.assign(c,m)}else c.level=s.levels.values[i];if(n.asObjectBindingsOnly){if(l!==null&&typeof l=="object")for(;u--&&typeof h[0]=="object";)Object.assign(c,h.shift());return[o(c),...h]}else{if(l!==null&&typeof l=="object"){for(;u--&&typeof h[0]=="object";)Object.assign(c,h.shift());l=h.length?bt(h.shift(),h):void 0}else typeof l=="string"&&(l=bt(h.shift(),h));return l!==void 0&&(c[n.messageKey]=l),[o(c)]}}function Ue(s,i,e,t){for(let n in s)if(t&&s[n]instanceof Error)s[n]=_.stdSerializers.err(s[n]);else if(typeof s[n]=="object"&&!Array.isArray(s[n])&&i)for(let r in s[n])i.indexOf(r)>-1&&r in e&&(s[n][r]=e[r](s[n][r]))}function ji(s,i,e,t=!1){let n=i.send,r=i.ts,o=i.methodLevel,h=i.methodValue,l=i.val,c=s._logEvent.bindings;t||Ue(e,s._serialize||Object.keys(s.serializers),s.serializers,s._stdErrSerialize===void 0?!0:s._stdErrSerialize),s._logEvent.ts=r,s._logEvent.messages=e.filter(function(u){return c.indexOf(u)===-1}),s._logEvent.level.label=o,s._logEvent.level.value=h,n(o,s._logEvent,l),s._logEvent=We(c)}function We(s){return{ts:0,messages:[],bindings:s||[],level:{label:"",value:0}}}function yt(s){let i={type:s.constructor.name,msg:s.message,stack:s.stack};for(let e in s)i[e]===void 0&&(i[e]=s[e]);return i}function Wi(s){return typeof s.timestamp=="function"?s.timestamp:s.timestamp===!1?wt:xt}function Se(){return{}}function _e(s){return s}function Q(){}function wt(){return!1}function xt(){return Date.now()}function Fi(){return Math.round(Date.now()/1e3)}function Ui(){return new Date(Date.now()).toISOString()}function Xi(){function s(i){return typeof i<"u"&&i}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return s(self)||s(window)||s(this)||{}}}Oe.exports.default=_;Oe.exports.pino=_});var St,Ot,Yi,$i,ke,Hi,Xe,d,z=T(()=>{"use strict";St=B(Mt(),1),Ot=typeof process<"u"&&!0,Yi=typeof process<"u"&&process.env.CI==="true",$i=typeof window<"u"&&window.location.search.includes("e2e-test=true"),ke=typeof window<"u"&&window.location.search.includes("debug=true"),Hi=(0,St.default)({level:Ot?"warn":"debug",browser:{serialize:!0,transmit:{level:"debug",send:function(s,i){typeof window<"u"&&(Yi||$i||ke)&&console.log(`[GAME_LOG] ${JSON.stringify(i)}`)}}},formatters:{level:s=>({level:s})}}),Xe=class{constructor(i){this.baseLogger=i;a(this,"enabled",!Ot)}setEnabled(i){this.enabled=i}isEnabled(){return this.enabled}isDebugMode(){return ke}gameInitialized(i){this.enabled&&this.baseLogger.info({category:"game",event:"initialized",timestamp:Date.now(),...i},"Game initialized")}initialDraw(){this.enabled&&this.baseLogger.info({category:"game",event:"initial_draw",timestamp:Date.now()},"Initial draw complete")}gameReset(){this.enabled&&this.baseLogger.info({category:"game",event:"reset",timestamp:Date.now()},"Game reset")}worldGenerated(i){this.enabled&&this.baseLogger.info({category:"world",event:"generated",timestamp:Date.now(),...i},`World generated: ${i.totalTiles} tiles, ${i.spawnablePositions} spawn positions`)}worldSpawnAnalysis(i){this.enabled&&this.baseLogger.info({category:"world",event:"spawn_analysis",timestamp:Date.now(),...i},`Spawn analysis: ${i.validSpawnPositions} valid, ${i.invalidSpawnPositions} invalid positions`)}worldTileMap(i){this.enabled&&this.baseLogger.info({category:"world",event:"tile_map",timestamp:Date.now(),...i},`Tile map created: ${i.totalTiles} tiles, ${i.uniqueTileCodes} unique tile codes`)}actorSpawned(i){this.enabled&&this.baseLogger.info({category:"actor",event:"spawned",timestamp:Date.now(),...i},`Actor spawned: ${i.username} at (${i.x}, ${i.y})`)}actorMoved(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"moved",timestamp:Date.now(),...i},`Actor moved: ${i.username} from (${i.fromX}, ${i.fromY}, ${i.fromZ}) to (${i.toX}, ${i.toY}, ${i.toZ})`)}actorGoto(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"goto",timestamp:Date.now(),...i},`Actor goto command: ${i.username} -> (${i.targetX}, ${i.targetY})`)}actorRemoved(i){this.enabled&&this.baseLogger.info({category:"actor",event:"removed",timestamp:Date.now(),...i},`Actor removed: ${i.username||i.uid}`)}actorUpdated(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"updated",timestamp:Date.now(),...i},`Actor updated: ${i.username||i.uid}`)}actorAnimationStarted(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"animationStarted",timestamp:Date.now(),...i},`Actor animation started: ${i.username} - ${i.animationType} (${i.state})`)}actorAnimationFinished(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"animationFinished",timestamp:Date.now(),...i},`Actor animation finished: ${i.username} - ${i.animationType} at (${i.position.x}, ${i.position.y})`)}actorSpriteRendered(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"spriteRendered",timestamp:Date.now(),...i},`Actor sprite rendered: ${i.username} - ${i.state}/${i.facing} (${i.presence})`)}nametagShow(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"show",timestamp:Date.now(),actorUid:i,username:e},`Nametag shown: ${e||i}`)}nametagHide(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"hide",timestamp:Date.now(),actorUid:i,username:e},`Nametag hidden: ${e||i}`)}nametagResolved(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"resolved",timestamp:Date.now(),visibleActorUid:i,hiddenActorUids:e,totalCount:e.length+1},`Nametag conflict resolved: showing ${i}, hiding ${e.length} others`)}websocketConnected(i){this.enabled&&this.baseLogger.info({category:"websocket",event:"connected",timestamp:Date.now(),url:i},`WebSocket connected: ${i||"unknown"}`)}websocketDisconnected(i){this.enabled&&this.baseLogger.warn({category:"websocket",event:"disconnected",timestamp:Date.now(),reason:i},`WebSocket disconnected: ${i||"unknown"}`)}websocketMessageReceived(i){this.enabled&&this.baseLogger.debug({category:"websocket",event:"message_received",timestamp:Date.now(),messageType:i.type,dataSize:JSON.stringify(i).length},`WebSocket message: ${i.type}`)}websocketMessageSent(i){this.enabled&&this.baseLogger.debug({category:"websocket",event:"message_sent",timestamp:Date.now(),messageType:i.type,dataSize:JSON.stringify(i).length},`WebSocket sent: ${i.type}`)}serverJoined(i,e){this.enabled&&this.baseLogger.info({category:"websocket",event:"server_joined",timestamp:Date.now(),serverId:i,serverName:e},`Joined server: ${e||i}`)}uiPanelOpened(i){this.enabled&&this.baseLogger.debug({category:"ui",event:"panel_opened",timestamp:Date.now(),panelType:i},`UI panel opened: ${i}`)}uiPanelClosed(i){this.enabled&&this.baseLogger.debug({category:"ui",event:"panel_closed",timestamp:Date.now(),panelType:i},`UI panel closed: ${i}`)}buttonClicked(i,e){this.enabled&&this.baseLogger.debug({category:"ui",event:"button_clicked",timestamp:Date.now(),buttonType:i,buttonText:e},`Button clicked: ${i} (${e||"no text"})`)}canvasHover(i,e,t){this.enabled&&this.baseLogger.debug({category:"canvas",event:"hover",timestamp:Date.now(),x:i,y:e,actorUid:t},`Canvas hover: (${i}, ${e}) ${t?`on actor ${t}`:""}`)}canvasClick(i,e,t){this.enabled&&this.baseLogger.debug({category:"canvas",event:"click",timestamp:Date.now(),x:i,y:e,actorUid:t},`Canvas click: (${i}, ${e}) ${t?`on actor ${t}`:""}`)}canvasResize(i,e){this.enabled&&this.baseLogger.debug({category:"canvas",event:"resize",timestamp:Date.now(),width:i,height:e},`Canvas resized: ${i}x${e}`)}discordLoginAttempt(){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_login_attempt",timestamp:Date.now()},"Discord login attempt started")}discordLoginSuccess(i){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_login_success",timestamp:Date.now(),username:i},`Discord login successful: ${i}`)}discordLoginError(i){this.enabled&&this.baseLogger.error({category:"auth",event:"discord_login_error",timestamp:Date.now(),error:i},`Discord login failed: ${i}`)}discordLogout(){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_logout",timestamp:Date.now()},"Discord logout")}performanceMetric(i,e,t="ms"){this.enabled&&this.baseLogger.debug({category:"performance",event:"metric",timestamp:Date.now(),metric:i,value:e,unit:t},`Performance: ${i} = ${e}${t}`)}frameRate(i){this.enabled&&this.baseLogger.debug({category:"performance",event:"frame_rate",timestamp:Date.now(),fps:i},`FPS: ${i}`)}info(i,e){this.enabled&&this.baseLogger.info(e||{},i)}debug(i,e){this.enabled&&this.baseLogger.debug(e||{},i)}warn(i,e){this.enabled&&this.baseLogger.warn(e||{},i)}error(i,e){this.enabled&&this.baseLogger.error(e||{},i)}},d=new Xe(Hi);typeof window<"u"&&(window.__E2E_TEST_MODE||ke)&&(window.gameLogger=d,console.log("\u2705 [DEBUG/E2E] gameLogger exposed on window.gameLogger"));typeof window<"u"&&ke&&(window.__DEBUG_MODE=!0,console.log("\u{1F41B} [DEBUG] Debug mode enabled - walkable tiles will be highlighted"))});var A=Ge((Cn,Ye)=>{"use strict";var ee=typeof Reflect=="object"?Reflect:null,kt=ee&&typeof ee.apply=="function"?ee.apply:function(i,e,t){return Function.prototype.apply.call(i,e,t)},Ee;ee&&typeof ee.ownKeys=="function"?Ee=ee.ownKeys:Object.getOwnPropertySymbols?Ee=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:Ee=function(i){return Object.getOwnPropertyNames(i)};function Ki(s){console&&console.warn&&console.warn(s)}var Tt=Number.isNaN||function(i){return i!==i};function O(){O.init.call(this)}Ye.exports=O;Ye.exports.once=Vi;O.EventEmitter=O;O.prototype._events=void 0;O.prototype._eventsCount=0;O.prototype._maxListeners=void 0;var Et=10;function Te(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(O,"defaultMaxListeners",{enumerable:!0,get:function(){return Et},set:function(s){if(typeof s!="number"||s<0||Tt(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Et=s}});O.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};O.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||Tt(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function Ct(s){return s._maxListeners===void 0?O.defaultMaxListeners:s._maxListeners}O.prototype.getMaxListeners=function(){return Ct(this)};O.prototype.emit=function(i){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var n=i==="error",r=this._events;if(r!==void 0)n=n&&r.error===void 0;else if(!n)return!1;if(n){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var h=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw h.context=o,h}var l=r[i];if(l===void 0)return!1;if(typeof l=="function")kt(l,this,e);else for(var c=l.length,u=It(l,c),t=0;t<c;++t)kt(u[t],this,e);return!0};function Lt(s,i,e,t){var n,r,o;if(Te(e),r=s._events,r===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",i,e.listener?e.listener:e),r=s._events),o=r[i]),o===void 0)o=r[i]=e,++s._eventsCount;else if(typeof o=="function"?o=r[i]=t?[e,o]:[o,e]:t?o.unshift(e):o.push(e),n=Ct(s),n>0&&o.length>n&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(i)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=s,h.type=i,h.count=o.length,Ki(h)}return s}O.prototype.addListener=function(i,e){return Lt(this,i,e,!1)};O.prototype.on=O.prototype.addListener;O.prototype.prependListener=function(i,e){return Lt(this,i,e,!0)};function Zi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function zt(s,i,e){var t={fired:!1,wrapFn:void 0,target:s,type:i,listener:e},n=Zi.bind(t);return n.listener=e,t.wrapFn=n,n}O.prototype.once=function(i,e){return Te(e),this.on(i,zt(this,i,e)),this};O.prototype.prependOnceListener=function(i,e){return Te(e),this.prependListener(i,zt(this,i,e)),this};O.prototype.removeListener=function(i,e){var t,n,r,o,h;if(Te(e),n=this._events,n===void 0)return this;if(t=n[i],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[i],n.removeListener&&this.emit("removeListener",i,t.listener||e));else if(typeof t!="function"){for(r=-1,o=t.length-1;o>=0;o--)if(t[o]===e||t[o].listener===e){h=t[o].listener,r=o;break}if(r<0)return this;r===0?t.shift():qi(t,r),t.length===1&&(n[i]=t[0]),n.removeListener!==void 0&&this.emit("removeListener",i,h||e)}return this};O.prototype.off=O.prototype.removeListener;O.prototype.removeAllListeners=function(i){var e,t,n;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[i]),this;if(arguments.length===0){var r=Object.keys(t),o;for(n=0;n<r.length;++n)o=r[n],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[i],typeof e=="function")this.removeListener(i,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(i,e[n]);return this};function Pt(s,i,e){var t=s._events;if(t===void 0)return[];var n=t[i];return n===void 0?[]:typeof n=="function"?e?[n.listener||n]:[n]:e?Ji(n):It(n,n.length)}O.prototype.listeners=function(i){return Pt(this,i,!0)};O.prototype.rawListeners=function(i){return Pt(this,i,!1)};O.listenerCount=function(s,i){return typeof s.listenerCount=="function"?s.listenerCount(i):Dt.call(s,i)};O.prototype.listenerCount=Dt;function Dt(s){var i=this._events;if(i!==void 0){var e=i[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}O.prototype.eventNames=function(){return this._eventsCount>0?Ee(this._events):[]};function It(s,i){for(var e=new Array(i),t=0;t<i;++t)e[t]=s[t];return e}function qi(s,i){for(;i+1<s.length;i++)s[i]=s[i+1];s.pop()}function Ji(s){for(var i=new Array(s.length),e=0;e<i.length;++e)i[e]=s[e].listener||s[e];return i}function Vi(s,i){return new Promise(function(e,t){function n(o){s.removeListener(i,r),t(o)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",n),e([].slice.call(arguments))}Bt(s,i,r,{once:!0}),i!=="error"&&Qi(s,n,{once:!0})})}function Qi(s,i,e){typeof s.on=="function"&&Bt(s,"error",i,e)}function Bt(s,i,e,t){if(typeof s.on=="function")t.once?s.once(i,e):s.on(i,e);else if(typeof s.addEventListener=="function")s.addEventListener(i,function n(r){t.once&&s.removeEventListener(i,n),e(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}});var y,Z,P=T(()=>{"use strict";y={randomIntRange(s,i){return Math.floor(Math.random()*(+i-+s+1))+ +s},pickInArray(s){return s[this.randomIntRange(0,s.length-1)]},pickInObject(s){return this.pickInArray(Object.keys(s))},findAndRemove(s,i){for(let e=0;e<i.length;e++)i[e]===s&&(i.splice(e,1),e--)},right(s,i){return s.substring(s.length-i,s.length)},clamp(s,i,e){return Math.min(e,Math.max(i,s))},clampWrap(s,i,e){let t=(s-i)%(e+1-i);return t>=0?i+t:e+1+t},fractionalArrayIndex(s,i){let e=Math.floor(i),t=s[e];if(e===i)return t;let n=s[Math.ceil(i)],r=i-Math.floor(i);return t+(n-t)*r},getURLParameter(s){return decodeURIComponent((new RegExp("[?|&]"+s+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},abbreviate(s,i){let e=s.split(" "),t=/[a-z0-9]/i,n="";for(let r=0;r<e.length;r++)for(let o=0;o<e[r].length;o++)if(t.test(e[r][o])){n+=e[r][o];break}if(n.trim()===""&&(n="1"),i&&i.indexOf(n)>=0){let r=0;n+=r;do r++,n=n.substring(0,n.length-1)+r;while(i.indexOf(n)>=0)}return n},alphabet:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],vowels:["a","e","i","o","u"],consonants:["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],hex:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"]},Z=y});var $e,k,te=T(()=>{"use strict";P();$e=[],k={generateClosestGrids:function(s){for(let i=s*-1;i<=s;i++)for(let e=s*-1;e<=s;e++)$e.push([i,e]);$e.sort(function(i,e){return Math.abs(i[0])+Math.abs(i[1])-(Math.abs(e[0])+Math.abs(e[1]))})},closestGrids:$e,DIRECTIONS:{north:{x:0,y:-1},east:{x:1,y:0},south:{x:0,y:1},west:{x:-1,y:0}},randomDirection:function(){return this.DIRECTIONS[y.pickInObject(this.DIRECTIONS)]},getNeighbors:function(s){let i=+s.split(":")[0],e=+s.split(":")[1];return{n:i+":"+(e-1),e:i+1+":"+e,s:i+":"+(e+1),w:i-1+":"+e}},get8Neighbors:function(s){let i=+s.split(":")[0],e=+s.split(":")[1];return{n:i+":"+(e-1),e:i+1+":"+e,s:i+":"+(e+1),w:i-1+":"+e,nw:i-1+":"+(e-1),ne:i+1+":"+(e-1),sw:i-1+":"+(e+1),se:i+1+":"+(e+1)}},getDistance:function(s,i){return Math.abs(s.x-i.x)+Math.abs(s.y-i.y)},intervalOverlaps:function(s,i,e,t){return s>=e&&s<t||e>=s&&e<i},buildNoiseMap:function(s,i){let e=[];for(let t=0;t<s;t++){e.push([]);for(let n=0;n<i;n++)e[t].push(Math.random())}return e},getNoiseMapPoint:function(s,i,e){let t=Math.floor(i),n=s[t];if(t==i)return y.fractionalArrayIndex(n,e);let r=Math.ceil(i),o=s[r],h=Math.floor(e);if(h==e)return y.fractionalArrayIndex([n[h],o[h]],i-t);let l=y.fractionalArrayIndex(n,e),c=y.fractionalArrayIndex(o,e);return y.fractionalArrayIndex([l,c],i-t)}}});var At,q,He=T(()=>{"use strict";At=B(A(),1);P();z();q=class extends At.EventEmitter{constructor(){super();a(this,"sprite",{});a(this,"game");a(this,"position");a(this,"zDepth");a(this,"invisible");a(this,"exists");this.sprite={}}addToGame(e){this.game=e,this.game.entities.push(this),this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(this.game.world.addToWorld(this),this.invisible||this.game.renderer.addToZBuffer(this.sprite,this.zDepth)):this.game.renderer.overlay.push(this.sprite),this.exists=!0}remove(){this.exists=!1,this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(!this.invisible&&this.game&&this.game.renderer.removeFromZBuffer(this.sprite,this.zDepth),this.game&&this.game.world.removeFromWorld(this)):this.game&&y.findAndRemove(this,this.game.renderer.overlay),this.game&&y.findAndRemove(this,this.game.entities)}tickDelay(e,t){this.game&&this.game.schedule.push({type:"once",tick:this.game.ticks+t,cb:e,entity:this})}tickRepeat(e,t,n){if(this.game){if(!isFinite(t)||t<=0){d.error("Entity tickRepeat: Invalid ticks parameter",{ticks:t,entity:this.constructor.name,isFinite:isFinite(t),isPositive:t>0});return}this.game.schedule.push({type:"repeat",start:this.game.ticks,count:t,cb:e,afterCB:n,entity:this})}}removeFromSchedule(e){if(this.game){for(let t=0;t<this.game.schedule.length;t++)if(this.game.schedule[t].entity===this&&this.game.schedule[t].cb===e){this.game.schedule[t].type="deleted";break}}}}});function N(s){return!isNaN(parseFloat(s))&&isFinite(s)}var Ke,C,X=T(()=>{"use strict";z();Ke=class{constructor(i,e){a(this,"canvas");a(this,"context");(!N(i)||!N(e))&&d.error("BetterCanvas: Invalid canvas size",{width:i,height:e}),this.canvas=document.createElement("canvas"),this.canvas.width=i,this.canvas.height=e;let t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get 2D context from canvas");this.context=t}drawImage(i,e,t,n,r,o,h,l,c,u){(!i||!(e>=0)||!(t>=0)||!(n>=0)||!(r>=0)||!N(o)||!N(h)||!(l>=0)||!(c>=0))&&(d.error("BetterCanvas drawImage: Invalid parameters",{hasImg:!!i,sx:e,sy:t,sw:n,sh:r,dx:o,dy:h,dw:l,dh:c}),window.pause&&window.pause()),u!==void 0&&(this.context.save(),this.context.globalAlpha=u),this.context.drawImage(i,e,t,n,r,o,h,l,c),u!==void 0&&this.context.restore()}fill(i){this.context.fillStyle=i,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}fillRect(i,e,t,n,r){(!N(e)||!N(t)||!N(n)||!N(r))&&(d.error("BetterCanvas fillRect: Invalid parameters",{color:i,x:e,y:t,w:n,h:r}),window.pause&&window.pause()),this.context.fillStyle=i,this.context.fillRect(Math.round(e),Math.round(t),Math.round(n),Math.round(r))}clearRect(i,e,t,n){(!N(i)||!N(e)||!N(t)||!N(n))&&(d.error("BetterCanvas clearRect: Invalid parameters",{x:i,y:e,w:t,h:n}),window.pause&&window.pause()),this.context.clearRect(Math.round(i),Math.round(e),Math.round(t),Math.round(n))}},C=Ke});var Ze,j,ie,en,Nt,D,ne=T(()=>{"use strict";X();Ze={upper:{y:0,height:8,xSpacing:1,chars:[["A",5],["B",5],["C",5],["D",5],["E",4],["F",4],["G",5],["H",5],["I",3],["J",5],["K",5],["L",4],["M",5],["N",5],["O",5],["P",5],["Q",5],["R",5],["S",5],["T",5],["U",5],["V",5],["W",5],["X",5],["Y",5],["Z",5]]},lower:{y:8,height:11,xSpacing:1,chars:[["a",5],["b",4],["c",4],["d",4],["e",4],["f",4],["g",4],["h",4],["i",1],["j",2],["k",4],["l",1],["m",5],["n",4],["o",4],["p",4],["q",4],["r",4],["s",4],["t",4],["u",4],["v",5],["w",5],["x",4],["y",4],["z",4],[" ",4]]},numsAndSymbols:{y:19,xSpacing:1,height:8,chars:[["0",4],["1",3],["2",4],["3",4],["4",4],["5",4],["6",4],["7",4],["8",4],["9",4],["`",2],["~",6],["!",1],["@",7],["#",7],["$",4],["%",5],["^",5],["&",6],["*",3],["(",2],[")",2],["_",5],["=",5],["-",5],["+",5],["|",1],[",",2],[".",1],["<",5],[">",5],["?",4],["/",3],["\\",3],[";",1],[":",1],["'",1],['"',3],["[",2],["]",2],["{",3],["}",3]]},icons:{count:4,y:27,height:12,chars:[[":icon-npm:",12],[":icon-github:",12],[":icon-lock:",12],[":icon-lock-small:",12]]},accented1:{y:39,xSpacing:1,height:13,oy:-2,chars:[["\xE1",5],["\xC1",5],["\xE0",5],["\xC0",5],["\xE2",5],["\xC2",5],["\xE4",5],["\xC4",5],["\xE3",5],["\xC3",5],["\xE5",5],["\xC5",5],["\xE6",7],["\xC6",7],["\xE7",4],["\xC7",5],["\xE9",4],["\xC9",4],["\xE8",4],["\xC8",4],["\xEA",4],["\xCA",4],["\xEB",4],["\xCB",4],["\xED",2],["\xCD",3],["\xEC",2],["\xCC",3],["\xEE",3],["\xCE",3],["\xEF",3],["\xCF",3]]},accented2:{y:52,xSpacing:1,height:10,oy:-2,chars:[["\xF1",4],["\xD1",5],["\xF3",4],["\xD3",5],["\xF2",4],["\xD2",5],["\xF4",4],["\xD4",5],["\xF6",4],["\xD6",5],["\xF5",4],["\xD5",5],["\xF8",4],["\xD8",5],["\u0153",7],["\u0152",8],["\xDF",5],["\xFA",4],["\xDA",5],["\xF9",4],["\xD9",5],["\xFB",4],["\xDB",5],["\xFC",4],["\xDC",5]]}},j={};for(let s in Ze){if(!Ze.hasOwnProperty(s))continue;let i=Ze[s],e=0;for(let t=0;t<i.chars.length;t++){let n=i.chars[t][0],r=i.chars[t][1]+(i.xSpacing||0);j[n]={x:e,y:i.y,w:r,h:i.height,char:n,oy:i.oy},e+=r}}ie={x:4,y:3},en=1,D={loadImage:function(s){Nt=s},blot:function(s){let i=s.x||0,e=s.y||0,t=s.metrics||this.calculateMetrics(s),n=s.lineStart?s.lineStart:0,r=s.lineCount?Math.min(t.lines.length,s.lineCount):t.lines.length,o=s.canvas||new C(ie.x*2+i+t.w-1,ie.y*2+e+r*10);s.bg&&o.fill(s.bg);let h=0;for(let l=n;l<Math.min(t.lines.length,n+r);l++){let c=t.lines[l].chars.length;s.maxChars&&(c=Math.min(c,s.maxChars-h));for(let u=0;u<c;u++){let m=t.lines[l].chars[u];m.char.char!=" "&&o.drawImage(Nt,m.char.x,m.char.y,m.w,m.char.h,ie.x+i+m.x,ie.y+e+(l-n)*10+(m.oy||0)+en,m.w,m.char.h)}h+=t.lines[l].chars.length}return o.canvas},transition:function(s){let i=s.metrics||(s.text?this.calculateMetrics(s):{lines:[],text:"",w:0}),e=s.canvas||new C(i.w+ie.x*2,(s.lineCount||i.lines.length)*10+ie.y*2),t=Math.max(2,Math.max(0,s.progress-.25)/.75*e.canvas.width),n=Math.min(1,s.progress*4)*e.canvas.height*-1;return e.fillRect(s.bg,(e.canvas.width-t)/2,e.canvas.height,t,n),e.canvas},calculateMetrics:function(s){let i=s.text,e=[],t=i.split(" "),n=j[" "],r=0,o=[],h=0;for(let l=0;l<t.length;l++){let c=t[l];if(c=="")continue;let u=0,m=[];if(o.length>0&&(m.push({x:r,char:n,w:n.w}),u+=n.w),c.length>1&&j[c])m.push({x:r+u,char:j[c],w:j[c].w,oy:-2}),u+=j[c].w;else for(let p=0;p<c.length;p++){let f=j[c[p]]||n;m.push({x:r+u,char:f,w:f.w,oy:f.oy}),u+=f.w}if(s.maxWidth&&r+u>s.maxWidth){if(u>s.maxWidth){r>0&&(e.push({w:r,chars:o}),h=Math.max(r,h),r=0,o=[]),m=[],u=0;for(let p=0;p<c.length;p++){let f=j[c[p]]||n;if(r+u+f.w<s.maxWidth)m.push({x:r+u,char:f,w:f.w,oy:f.oy}),u+=f.w;else{let M=r+u+f.w-s.maxWidth;m.push({x:r+u,char:f,w:f.w-M,oy:f.oy}),u+=f.w-M;break}}r+=u,o=o.concat(m)}else l--;e.push({w:r,chars:o}),h=Math.max(r,h),r=0,o=[]}else r+=u,o=o.concat(m),l==t.length-1&&(e.push({w:r,chars:o}),h=Math.max(r,h))}return{lines:e,text:i,w:h}},fontMap:j}});function an(s){let i=1;for(let e=0;e<Ce.length;e++)if(s.length>=Ce[e][0])i=Ce[e][1];else if(s.length<Ce[e][0])break;return i}var tn,se,Ce,nn,sn,rn,on,qe,re,Rt=T(()=>{"use strict";z();He();ne();tn=96,se=4,Ce=[[0,3],[75,2],[150,1]],nn=5,sn=60,rn=10,on=8,qe="rgba(0, 0, 0, 0.7)";re=class extends q{constructor(e,t,n){super();a(this,"parent");a(this,"text");a(this,"screen");a(this,"sprite");a(this,"canvas");a(this,"textMetrics");this.parent=e,this.text=t,this.screen={x:0,y:0},this.sprite={keepOnScreen:!0,screen:this.screen,parent:this.parent,stay:n,metrics:{x:0,y:0,w:0,h:0}}}updateScreen(){if(!this.canvas)return;if(!this.parent||!this.parent.preciseScreen){d.warn("TextBox updateScreen: Parent or preciseScreen missing",{hasParent:!!this.parent,hasPreciseScreen:this.parent&&!!this.parent.preciseScreen,textboxText:this.text}),this.screen.x=0,this.screen.y=0,this.sprite&&(this.sprite.screen=this.screen,this.sprite.hidden=!0),this.remove();return}let e=isFinite(this.parent.preciseScreen.x)?this.parent.preciseScreen.x:0,t=isFinite(this.parent.preciseScreen.y)?this.parent.preciseScreen.y:0;(e!==this.parent.preciseScreen.x||t!==this.parent.preciseScreen.y)&&d.warn("TextBox updateScreen: NaN detected in parent preciseScreen",{originalX:this.parent.preciseScreen.x,originalY:this.parent.preciseScreen.y,fallbackX:e,fallbackY:t,parentType:this.parent.constructor?.name||"unknown"}),this.screen.x=e-this.canvas.width/2+this.parent.pixelSize.x,this.screen.y=t-this.canvas.height+2,this.sprite&&(this.sprite.screen=this.screen)}updateSprite(){this.sprite.image=this.canvas,this.sprite.image&&(this.sprite.metrics.w=this.sprite.image.width,this.sprite.metrics.h=this.sprite.image.height)}blotText(e){e||(e={}),e.bg=e.bg||qe,e.text=e.text||this.text,e.text&&(this.canvas=D.blot(e),this.updateScreen(),this.updateSprite())}scrollMessage(e){let t=this;function n(){t.remove(),e()}if(!this.parent||!this.parent.preciseScreen){d.warn("TextBox scrollMessage: Parent invalid at start"),n();return}if(this.textMetrics=D.calculateMetrics({text:this.text,maxWidth:tn}),this.text.trim()===""||this.textMetrics.lines.length===0||this.textMetrics.lines[0].chars.length===0){n();return}let r=an(this.text),o=0,h=0,l=t.textMetrics.lines[o].chars.length;for(let u=1;u<se;u++){let m=t.textMetrics.lines[o+u];if(m)l+=m.chars.length;else break}let c=function(){if(!t.parent||!t.parent.preciseScreen){d.warn("TextBox scrollMessage: Parent became invalid during animation"),n();return}if(h++,t.blotText({text:t.text,metrics:t.textMetrics,maxChars:h,lineStart:o,lineCount:se}),h===l)if(o+=se,o>=t.textMetrics.lines.length)t.tickDelay(function(){t.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){d.warn("TextBox scrollMessage: Parent became invalid during closing animation"),n();return}t.canvas=D.transition({bg:qe,metrics:t.textMetrics,progress:1-u.percent,lineCount:Math.min(t.textMetrics.lines.length,se)}),t.updateScreen(),t.updateSprite()},on,n)},r*sn);else{h=0,l=t.textMetrics.lines[o].chars.length;for(let u=1;u<se;u++){let m=t.textMetrics.lines[o+u];if(m)l+=m.chars.length;else break}t.tickDelay(c,r*nn)}else t.tickDelay(c,r)};this.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){d.warn("TextBox scrollMessage: Parent became invalid during opening animation"),n();return}t.canvas=D.transition({bg:qe,metrics:t.textMetrics,progress:u.percent,lineCount:Math.min(t.textMetrics.lines.length,se)}),t.updateScreen(),t.updateSprite()},rn,function(){t.tickDelay(c,r)})}remove(){if(this.game&&this.game.schedule)for(let e=this.game.schedule.length-1;e>=0;e--){let t=this.game.schedule[e];t.entity===this&&(t.type="deleted")}super.remove()}}});var I,oe=T(()=>{"use strict";He();I=class extends q{constructor(e){super();a(this,"height");a(this,"zDepth");a(this,"pixelSize");a(this,"screen");this.position={x:e.position.x,y:e.position.y,z:e.position.z,fakeZ:0},this.height=e.height,this.zDepth=this.calcZDepth(),this.pixelSize={x:e.pixelSize.x,y:e.pixelSize.y,z:e.pixelSize.z},this.screen={x:0,y:0},this.updateScreen(),this.sprite.screen=this.screen,this.sprite.position=this.position}move(e,t,n){let r=this.position.x+e,o=this.position.y+t,h=this.position.z+n;this.game.world.moveObject(this,r,o,h),this.updateScreen();let l=this.calcZDepth();l!=this.zDepth&&(this.game.renderer.updateZBuffer(this.zDepth,this.sprite,l),this.zDepth=l)}underneath(){return this.game.world.objectAtXYZ(this.position.x,this.position.y,this.position.z+this.height)}calcZDepth(){return this.position.x+this.position.y}updateScreen(){this.screen.x=(this.position.x-this.position.y)*16-this.pixelSize.x,this.screen.y=(this.position.x+this.position.y)*8-(this.position.z+this.height)*16}}});var _t={};H(_t,{default:()=>Je});var Le,Gt,hn,cn,Je,Ve=T(()=>{"use strict";Gt=(s,i)=>{let e=Math.abs(s.x-i.x),t=Math.abs(s.y-i.y);return e>t?8*t+5*e:8*e+5*t},hn=s=>{let i;for(let e in s)s.hasOwnProperty(e)&&(!i||i.f>s[e].f)&&(i=s[e]);return i},cn=(s,i,e)=>{let t=[],n=i;for(;!(n.x==s.x&&n.y==s.y);)t.push({x:n.x,y:n.y,z:Le[n.x+":"+n.y]}),n=e[n.parent];return t.reverse()},Je={loadMap:function(s){Le=s},findPath:function(s){let i=s.start,e=s.end;if(i.x==e.x&&i.y==e.y||!(Le[e.x+":"+e.y]>=0))return[];let t=Gt(e,i),n={x:i.x,y:i.y,grid:i.x+":"+i.y,g:0,h:t,f:t},r=!0,o=0,h={},l={};for(h[n.grid]=n,o++;o>0;){if(l[n.grid]=n,delete h[n.grid],o--,n.x==e.x&&n.y==e.y)return cn(i,n,l);for(let u=-1;u<=1;u++)for(let m=-1;m<=1;m++){if(u==0&&m==0)continue;let p=n.x+u,f=n.y+m,M=p+":"+f;if(!(Le[M]>=0)||l[M])continue;let b=u==0||m==0?5:8,w=n.g+b;if(h[M]){let v=h[M];w<v.g&&(v.g=w,v.f=v.g+v.h,v.parent=n.grid)}else{let v={x:p,y:f,grid:M,g:w,h:Gt(e,{x:p,y:f}),f:0,parent:n.grid};v.f=v.g+v.h,h[v.grid]=v,o++}}let c=hn(h);if(!c)break;n=c,r=!1}return[]}}});var W,jt=T(()=>{"use strict";z();te();P();Ve();W=class{constructor(i,e){a(this,"actor");a(this,"target");a(this,"attempt");a(this,"boundResetAttempt");a(this,"boundStartGoTo");a(this,"destination");a(this,"path");this.actor=i,this.target=e,this.attempt=y.randomIntRange(1,4),this.boundResetAttempt=this.resetAttempt.bind(this),this.target.on("movecomplete",this.boundResetAttempt),this.boundStartGoTo=this.startGoTo.bind(this),d.info("GoTo behavior created",{actor:this.actor.username,target:this.target.username,attempt:this.attempt,closestGridsLength:k.closestGrids?.length||0}),this.actor.destination?this.actor.once("movecomplete",this.boundStartGoTo):this.startGoTo()}startGoTo(){!this.actor||this.actor.presence!="online"||this.actor.underneath()||this.actor.tickDelay(()=>{this.performMove()},2)}performMove(){if(!this.actor||this.actor.presence!="online"||this.actor.underneath())return;if(!k.closestGrids||this.attempt>=k.closestGrids.length){d.error("GoTo: Invalid attempt index for closestGrids",{attempt:this.attempt,closestGridsLength:k.closestGrids?.length||0,actor:this.actor.username}),this.actor.stopGoTo(this);return}let i=k.closestGrids[this.attempt];if(k.getDistance(this.actor.position,this.target.position)<=Math.abs(i[0])+Math.abs(i[1])){this.actor.stopGoTo(this);return}this.destination={x:this.target.position.x+i[0],y:this.target.position.y+i[1]};let t={x:this.destination.x-this.actor.position.x,y:this.destination.y-this.actor.position.y};var n={x:0,y:0};let r=Math.abs(t.x),o=Math.abs(t.y);r>o?(n.x=Math.max(-1,Math.min(1,t.x)),n.y=0):o>r?(n.x=0,n.y=Math.max(-1,Math.min(1,t.y))):r===o&&r>0&&(n.x=Math.max(-1,Math.min(1,t.x)),n.y=0);var h=this.actor.tryMove(n.x,n.y);if(h)this.actor.destination=h,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo);else if(this.path=Je.findPath({start:this.actor.position,end:this.destination}),this.path&&this.path.length>0&&this.path[0]){let l={x:this.path[0].x-this.actor.position.x,y:this.path[0].y-this.actor.position.y},c={x:this.path[0].x,y:this.path[0].y,z:this.path[0].z};Math.abs(l.x)>0&&Math.abs(l.y)>0&&(Math.abs(l.x)>=Math.abs(l.y)?c={x:this.actor.position.x+Math.sign(l.x),y:this.actor.position.y,z:this.path[0].z}:c={x:this.actor.position.x,y:this.actor.position.y+Math.sign(l.y),z:this.path[0].z}),this.actor.destination=c,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo)}else{if(this.attempt++,this.attempt>8){d.info("GoTo behavior giving up after maximum attempts",{actor:this.actor.username,attempts:this.attempt,target:this.target}),this.actor.stopGoTo(this);return}this.startGoTo()}}resetAttempt(){this.attempt=y.randomIntRange(1,4)}detach(){this.actor&&this.actor.removeListener("movecomplete",this.boundStartGoTo),this.target&&this.target.removeListener("movecomplete",this.boundResetAttempt),delete this.actor,delete this.target}};typeof window<"u"&&(window.GoTo=W)});var Y,Wt=T(()=>{"use strict";z();te();P();Y=class{constructor(i){a(this,"actor");a(this,"state","idle");a(this,"impulseCompleteBound");a(this,"impulseInterval",300);a(this,"impulseBound");this.actor=i,this.impulseCompleteBound=this.impulseComplete.bind(this),this.impulseBound=this.impulse.bind(this),this.wait()}wait(){this.actor&&this.actor.tickDelay(this.impulseBound,20+Math.round(Math.random()*this.impulseInterval))}impulse(){if(!(!this.actor||this.actor.presence!="online"))if(this.actor.destination)this.wait();else{let i=y.pickInObject(k.DIRECTIONS),e=k.DIRECTIONS[i],t=this.actor.tryMove(e.x,e.y);if(t){if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)){d.error("Wander behavior: tryMove returned NaN destination",{actor:this.actor.username,canMove:t,direction:i,moveXY:e,currentPosition:this.actor.position}),this.wait();return}this.actor.destination=t,this.actor.startMove(),this.actor.once("movecomplete",this.impulseCompleteBound)}else this.wait()}}impulseComplete(){this.wait()}detach(){this.actor.removeListener("movecomplete",this.impulseCompleteBound),this.actor.removeFromSchedule(this.impulseBound),delete this.actor}}});var de,Ft=T(()=>{"use strict";oe();de=class extends I{constructor(e,t){let n={position:{x:t.x,y:t.y,z:t.z},pixelSize:{x:0,y:0,z:0},height:.5};super(n);a(this,"parent");a(this,"invisible",!0);a(this,"unWalkable",!0);this.parent=e,this.addToGame(this.parent.game)}}});var un,me,Ut=T(()=>{"use strict";un={actor:{online:{north:{x:28,y:0,w:14,h:14,ox:0,oy:5},south:{x:0,y:0,w:14,h:14,ox:0,oy:5},east:{x:14,y:0,w:14,h:14,ox:0,oy:5},west:{x:28,y:0,w:14,h:14,ox:0,oy:5}},idle:{north:{x:56,y:0,w:14,h:14,ox:0,oy:5},south:{x:42,y:0,w:14,h:14,ox:0,oy:5},east:{x:56,y:0,w:14,h:14,ox:0,oy:5},west:{x:42,y:0,w:14,h:14,ox:0,oy:5}},offline:{north:{x:84,y:0,w:14,h:14,ox:0,oy:5},south:{x:70,y:0,w:14,h:14,ox:0,oy:5},east:{x:84,y:0,w:14,h:14,ox:0,oy:5},west:{x:70,y:0,w:14,h:14,ox:0,oy:5}},hopping:{animation:{frames:13,zStartFrame:3},north:{x:0,y:83,w:35,h:27,ox:-2,oy:-6},south:{x:0,y:137,w:35,h:27,ox:-19,oy:3},east:{x:0,y:56,w:35,h:27,ox:-2,oy:3},west:{x:0,y:110,w:35,h:27,ox:-19,oy:-6}}}},me=class{constructor(i){a(this,"map");this.map=JSON.parse(JSON.stringify(un[i]))}}});var Xt={};H(Xt,{default:()=>ze});var ze,Yt=T(()=>{"use strict";z();te();Rt();P();oe();jt();Wt();Ft();Ut();ze=class extends I{constructor(e){(isNaN(e.x)||isNaN(e.y)||isNaN(e.z))&&(d.error("Actor constructor: Invalid coordinates provided",{username:e.username,uid:e.uid,coordinates:{x:e.x,y:e.y,z:e.z}}),e.x=isNaN(e.x)?0:e.x,e.y=isNaN(e.y)?0:e.y,e.z=isNaN(e.z)?0:e.z);let t={position:{x:e.x,y:e.y,z:e.z},pixelSize:{x:7,y:7,z:8},height:.5};super(t);a(this,"preciseScreen");a(this,"uid");a(this,"username");a(this,"nametag");a(this,"sheet");a(this,"presence","online");a(this,"talking",!1);a(this,"destination",!1);a(this,"facing");a(this,"behaviors",[]);a(this,"boundOnMessage");a(this,"roleColor");a(this,"placeholder");a(this,"moveTick");a(this,"talkBox");a(this,"talkTimeLeft");a(this,"frame",0);a(this,"lastMessage");a(this,"messageBox");a(this,"moveStart");a(this,"movePlaceholder");a(this,"destDelta");a(this,"unWalkable");this.preciseScreen=this.toScreenPrecise(),e.maxListeners&&this.setMaxListeners(e.maxListeners),this.uid=e.uid,this.username=e.username,this.nametag=new re(this,this.username,!0),this.nametag.blotText(),this.sheet=new me("actor"),this.frame=0,this.sprite&&(this.sprite.image="actors",this.sprite.screen=this.screen),this.facing=y.pickInObject(k.DIRECTIONS),this.boundOnMessage=this.onMessage.bind(this),this.roleColor=e.roleColor,this.updateSprite()}onUpdate(){this.talking&&this.updateSprite();let e=this.game;if(e.mouseOut||e.mouseOver&&(e.mouseOver.zDepth>this.zDepth||e.mouseOver.position.z>this.position.z)||e.ui.mouseOnElement)return;let t={x:e.centerMouseX-e.renderer.canvases[0].panning.panned.x,y:e.centerMouseY-e.renderer.canvases[0].panning.panned.y},n=this.sheet.map.online.north;t.x>=this.preciseScreen.x+n.ox&&t.x<this.preciseScreen.x+n.w+n.ox&&t.y>=this.preciseScreen.y+n.oy&&t.y<this.preciseScreen.y+n.h+n.oy?(e.mouseOver=this,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!1)):e.mouseOver===this&&(e.mouseOver=!1,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!0))}addToGame(e){super.addToGame(e),d.actorSpawned({uid:this.uid,username:this.username,x:this.position.x,y:this.position.y,z:this.position.z,roleColor:this.roleColor,presence:this.presence}),this.roleColor&&e.renderer.addColorSheet({sheet:"actors",color:this.roleColor,alpha:.8,regions:[{alpha:.4,x:70,y:0,w:28,h:14}]}),this.nametag&&(this.nametag.addToGame(e),this.nametag.sprite.hidden=!0),e.on("update",this.onUpdate.bind(this)),e.users&&e.users.on("message",this.boundOnMessage),this.behaviors.push(new Y(this))}updatePresence(e){if(this.presence=e,this.updateSprite(),e!="online"){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof Y&&(this.behaviors[t].detach(),this.behaviors.splice(t,1));this.destination&&(this.moveTick&&(d.info("Actor cancelling movement due to presence change",{username:this.username,newPresence:e}),this.removeFromSchedule(this.moveTick),delete this.moveTick,this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,delete this.moveStart,delete this.destDelta),this.destination=!1)}else{let t=!1;for(let n of this.behaviors)if(n instanceof Y){t=!0;break}t||this.behaviors.push(new Y(this))}}toScreenPrecise(){if(isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z))return d.error("Actor toScreenPrecise: Position coordinates contain NaN",{actor:this.username,position:this.position,uid:this.uid}),{x:0,y:0};if(this.destination&&this.moveStart!==void 0){let t=this.game;if(t&&t.ticks!==void 0){let n=this.destination.x-this.position.x,r=this.destination.y-this.position.y,o=this.destination.z-this.position.z,h=t.ticks-this.moveStart,c=3*this.sheet.map.hopping.animation.frames,u=Math.min(h/c,1),m={x:(n-r)*16*u,y:(n+r)*8-o*16*u};return{x:this.screen.x+m.x,y:this.screen.y+m.y}}}let e={x:(this.position.x-this.position.y)*16-8,y:(this.position.x+this.position.y)*8-this.position.z*16-8};return isNaN(e.x)||isNaN(e.y)?(d.error("Actor toScreenPrecise: Calculated screen coordinates are NaN",{actor:this.username,position:this.position,screen:e,uid:this.uid}),{x:0,y:0}):e}updateSprite(){if(!this.sprite)return;let e=this.facing,t=this.destination?"hopping":this.presence;if(!this.destination&&this.talking&&(t="online",e=e==="north"?"east":e==="west"?"south":e),!this.sheet.map[t]||!this.sheet.map[t][e]){if(!this.sheet.map[t])switch(t){case"dnd":case"busy":t="idle";break;case"away":case"invisible":t="offline";break;default:t="online";break}if(!this.sheet.map[t]||!this.sheet.map[t][e]){d.error("Actor sprite not found",{actor:this.username,state:t,facing:e,availableStates:Object.keys(this.sheet.map),availableFacingsForState:this.sheet.map[t]?Object.keys(this.sheet.map[t]):null});return}}let n=this.sheet.map[t][e],r={x:n.x,y:n.y,w:n.w,h:n.h,ox:n.ox||0,oy:n.oy||0};if(!this.destination&&this.talking){let h=this.game;h&&h.ticks!==void 0&&(r.y+=Math.floor(h.ticks/4)%4*r.h)}else if(this.destination){let h=r.x,l=r.y;r.x+=(this.frame||0)*r.w;let c=this.sheet.map.hopping.animation;if(this.frame>=c.zStartFrame){let u=this.destination.z-this.position.z;u>0?r.oy-=Math.min(8,this.frame-c.zStartFrame):u<0&&(r.oy+=Math.min(8,this.frame-c.zStartFrame))}}this.talking&&this.messageBox&&this.messageBox.updateScreen(),this.sprite.metrics=r;let o;if(this.roleColor){let h=this.game;h&&h.renderer&&h.renderer.addColorSheet?(h.renderer.addColorSheet({color:this.roleColor,sheet:"actors",alpha:1}),o=[this.roleColor,"actors"],this.sprite.image=o):(o="actors",this.sprite.image=o)}else o="actors",this.sprite.image=o;d.actorSpriteRendered({uid:this.uid,username:this.username,state:t,facing:e,frame:this.frame||0,spriteMetrics:r,image:o,presence:this.presence,talking:this.talking,moving:!!this.destination})}tryMove(e,t){let n=this.game;if(!n.world||!n.world.canWalk)return!1;if(this.underneath())return d.debug("Actor movement blocked: object on top",{actor:this.username}),this.emit("getoffme"),!1;if(isNaN(e)||isNaN(t))return d.error("Actor tryMove: Movement deltas contain NaN",{actor:this.username,deltaX:e,deltaY:t,currentPosition:this.position}),!1;if(isNaN(this.position.x)||isNaN(this.position.y))return d.error("Actor tryMove: Current position contains NaN",{actor:this.username,position:this.position,movementDeltas:{x:e,y:t}}),!1;let r={x:this.position.x+e,y:this.position.y+t};if(isNaN(r.x)||isNaN(r.y))return d.error("Actor tryMove: Calculated destination contains NaN",{actor:this.username,destination:r,currentPosition:this.position,movementDeltas:{x:e,y:t}}),!1;if(n.world.canWalk(r.x,r.y)){let o=n.world.getHeight(r.x,r.y);if(o>=0&&Math.abs(this.position.z-o)<=.5)return{x:r.x,y:r.y,z:o};d.error("Actor tryMove: Destination not walkable or invalid height",{actor:this.username,destination:r,walkable:o,currentPosition:this.position,movementDeltas:{x:e,y:t}})}return!1}startMove(){if(!this.destination)return;if(this.moveTick){d.warn("Actor startMove: Movement already in progress",{actor:this.username,currentDestination:this.destination,frame:this.frame,moveStart:this.moveStart});return}let e=this.game;if(!e||!e.world){d.error("Actor startMove: Game or world not available",{actor:this.username});return}if(this.moveStart=e.ticks,e.world.objectAtXYZ(this.destination.x,this.destination.y,this.destination.z)){this.destination=!1;return}this.movePlaceholder=new de(this,{x:this.destination.x,y:this.destination.y,z:this.destination.z}),this.unWalkable=!0,delete e.world.walkable[this.position.x+":"+this.position.y],this.destDelta={x:this.destination.x-this.position.x,y:this.destination.y-this.position.y,z:this.destination.z-this.position.z},this.destDelta.x>0?this.facing="east":this.destDelta.x<0?this.facing="west":this.destDelta.y>0?this.facing="south":this.destDelta.y<0&&(this.facing="north"),this.destDelta.x!==0&&this.destDelta.y!==0&&d.warn("Actor diagonal movement detected",{actor:this.username,destDelta:this.destDelta,destination:this.destination,position:this.position}),this.frame=0,d.actorAnimationStarted({uid:this.uid,username:this.username,animationType:"hopping",state:"hopping",facing:this.facing,frame:this.frame,destination:this.destination});let n=this.sheet.map.hopping.animation,r=this.position.x+this.position.y+(this.destDelta.x+this.destDelta.y)/2;this.moveTick=this.tickRepeat(o=>{if(!this.exists){this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder);return}let h=!1;if(o.ticks>0&&o.ticks%3===0&&(this.frame++,h=!0),h&&this.frame===6)e.renderer.updateZBuffer(this.zDepth,this.sprite,r),this.zDepth=r;else if(h&&this.frame===8){let l=this.destination.x+this.destination.y;e.renderer.updateZBuffer(r,this.sprite,l),this.zDepth=l}this.preciseScreen=this.toScreenPrecise(),this.nametag&&this.nametag.updateScreen(),this.updateSprite(),this.frame>=n.frames&&(this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,d.actorAnimationFinished({uid:this.uid,username:this.username,animationType:"hopping",state:"hopping",facing:this.facing,finalFrame:this.frame,position:{x:this.destination.x,y:this.destination.y,z:this.destination.z}}),this.move(this.destination.x,this.destination.y,this.destination.z,!0),this.destination=!1,this.frame=0,delete this.moveStart,delete this.destDelta,this.updateSprite(),this.emit("movecomplete"),delete this.moveTick)},3*n.frames),this.updateSprite()}move(e,t,n,r){let o={x:this.position.x,y:this.position.y,z:this.position.z};if(isNaN(e)||isNaN(t)||typeof n<"u"&&isNaN(n)){d.error("Actor move: Invalid coordinates provided",{actor:this.username,parameters:{x:e,y:t,z:n,absolute:r},currentPosition:this.position});return}if(r){let h=this.game;h&&h.world&&h.world.moveObject?h.world.moveObject(this,e,t,n!==void 0?n:this.position.z):(this.position.x=e,this.position.y=t,typeof n<"u"&&(this.position.z=n))}else{typeof n<"u"?super.move(e,t,n):super.move(e,t,0),d.actorMoved({uid:this.uid,username:this.username,fromX:o.x,fromY:o.y,fromZ:o.z,toX:this.position.x,toY:this.position.y,toZ:this.position.z,movementType:"relative",facing:this.facing});return}if(d.actorMoved({uid:this.uid,username:this.username,fromX:o.x,fromY:o.y,fromZ:o.z,toX:this.position.x,toY:this.position.y,toZ:this.position.z,movementType:"absolute",facing:this.facing}),isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z)){d.error("Actor move: Final position contains NaN after movement",{actor:this.username,finalPosition:this.position,movement:{x:e,y:t,z:n,absolute:r}});return}this.zDepth=this.calcZDepth(),this.updateScreen(),this.preciseScreen=this.toScreenPrecise()}startTalking(e,t,n){this.talking=!0,this.lastMessage={channel:t,time:Date.now()},this.nametag&&(this.nametag.sprite.hidden=!0),this.messageBox=new re(this,e,!0),this.messageBox.addToGame(this.game),d.actorAnimationStarted({uid:this.uid,username:this.username,animationType:"talking",state:"online",facing:this.facing,frame:0});let r=this;this.messageBox.scrollMessage(function(){d.actorAnimationFinished({uid:r.uid,username:r.username,animationType:"talking",state:"online",facing:r.facing,finalFrame:0,position:{x:r.position.x,y:r.position.y,z:r.position.z}}),delete r.messageBox,r.talking=!1,r.updateSprite(),r.emit("donetalking"),n&&n()})}onMessage(e){let t=this.lastMessage||{time:0};if(e.channel!==t.channel||t.time<Date.now()-180*1e3||e.user===this||this.presence!=="online")return;let n=this;function r(){for(let o=0;o<n.behaviors.length;o++)n.behaviors[o].detach();n.behaviors=[new W(n,e.user)]}this.tickDelay(function(){k.getDistance(n.position,e.user.position)<3||n.underneath()||(n.destination?n.once("movecomplete",r):r())},y.randomIntRange(0,60))}goto(e,t){let n={position:{x:e,y:t,z:this.game.world.getHeight(e,t)}};for(let r=this.behaviors.length-1;r>=0;r--)this.behaviors[r]instanceof W&&(this.behaviors[r].detach(),this.behaviors.splice(r,1));d.actorGoto({username:this.username,targetX:e,targetY:t}),this.behaviors.push(new W(this,n))}stopGoTo(e){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof W&&(!e||this.behaviors[t]===e)&&(this.behaviors[t].detach(),this.behaviors.splice(t,1))}remove(){let e=this.game;e&&e.users&&e.users.off("message",this.boundOnMessage);for(let t of this.behaviors)t.detach&&t.detach();if(this.behaviors=[],this.movePlaceholder){try{this.movePlaceholder.remove()}catch(t){d.error("Actor remove: Error removing movePlaceholder",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.movePlaceholder}if(this.messageBox){try{this.messageBox.remove()}catch(t){d.error("Actor remove: Error removing messageBox",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.messageBox}if(this.talkBox){try{this.talkBox.remove()}catch(t){d.error("Actor remove: Error removing talkBox",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.talkBox}if(this.nametag){try{this.nametag.remove()}catch(t){d.error("Actor remove: Error removing nametag",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.nametag}if(this.placeholder){try{this.placeholder.remove()}catch(t){d.error("Actor remove: Error removing placeholder",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.placeholder}super.remove()}}});var ri={};H(ri,{default:()=>Be});var Be,oi=T(()=>{"use strict";oe();Be=class extends I{constructor(e,t,n,r){super({position:{x:t,y:n,z:r},pixelSize:{x:16,y:16,z:1},height:.5});a(this,"invisible",!0);a(this,"style");this.style=e}}});var ai={};H(ai,{default:()=>ae});var dn,ae,at=T(()=>{"use strict";dn={tile:{"G-G-G-G":{x:0,y:108,w:32,h:18,ox:-1,oy:-2},"S-S-S-S":{x:32,y:90,w:32,h:18,ox:-1,oy:-2},"G-S-G-S":{x:64,y:90,w:32,h:18,ox:-1,oy:-2},"S-G-S-G":{x:96,y:90,w:32,h:18,ox:-1,oy:-2},"G-G-G-S":{x:0,y:18,w:32,h:18,ox:-1,oy:-2},"S-G-G-G":{x:0,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-G-G":{x:0,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-G":{x:0,y:72,w:32,h:18,ox:-1,oy:-2},"S-G-G-S":{x:32,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-G-G":{x:32,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-G":{x:32,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-S":{x:32,y:72,w:32,h:18,ox:-1,oy:-2},"S-S-G-S":{x:64,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-G":{x:64,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-S":{x:64,y:54,w:32,h:18,ox:-1,oy:-2},"S-G-S-S":{x:64,y:72,w:32,h:18,ox:-1,oy:-2},"F-F-F-F":{x:64,y:198,w:32,h:18,ox:-1,oy:-2},"G-F-G-F":{x:0,y:198,w:32,h:18,ox:-1,oy:-2},"F-G-F-G":{x:32,y:198,w:32,h:18,ox:-1,oy:-2},"G-G-G-F":{x:0,y:126,w:32,h:18,ox:-1,oy:-2},"F-G-G-G":{x:0,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-G-G":{x:0,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-G":{x:0,y:180,w:32,h:18,ox:-1,oy:-2},"F-G-G-F":{x:32,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-G-G":{x:32,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-G":{x:32,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-F":{x:32,y:180,w:32,h:18,ox:-1,oy:-2},"F-F-G-F":{x:64,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-F-G":{x:64,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-F":{x:64,y:162,w:32,h:18,ox:-1,oy:-2},"F-G-F-F":{x:64,y:180,w:32,h:18,ox:-1,oy:-2},"E-E-S-E":{x:96,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-S-E":{x:96,y:36,w:32,h:18,ox:-1,oy:-2},"E-E-S-S":{x:96,y:54,w:32,h:18,ox:-1,oy:-2},"E-S-S-S":{x:96,y:72,w:32,h:18,ox:-1,oy:-2},"E-E-E-S":{x:128,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-E":{x:128,y:18,w:32,h:18,ox:-1,oy:-2},"S-E-E-E":{x:160,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-E-S":{x:160,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-E":{x:192,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-S":{x:192,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-S":{x:224,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-S-S":{x:224,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-E":{x:224,y:36,w:32,h:18,ox:-1,oy:-2},"S-E-S-E":{x:224,y:54,w:32,h:18,ox:-1,oy:-2}}},ae=class{constructor(i){a(this,"map");this.map=JSON.parse(JSON.stringify(dn[i]))}}});var hi={};H(hi,{default:()=>Ae});var Ae,ci=T(()=>{"use strict";P();at();Ae=class{constructor(i){a(this,"game");a(this,"grid");a(this,"tileCode");a(this,"position");a(this,"zDepth");a(this,"screen");a(this,"imageName");a(this,"sheet");a(this,"sprite");this.game=i.game,this.grid=i.grid,this.tileCode=i.tileCode,this.position=i.position,this.zDepth=this.position.x+this.position.y,this.screen={x:(this.position.x-this.position.y)*16-16,y:(this.position.x+this.position.y)*8-this.position.z*16-8},this.imageName="static-tiles",this.sheet=new ae("tile");let e=this.sheet.map[this.tileCode]||{x:0,y:0,w:16,h:16,ox:0,oy:0};if(this.sprite={metrics:{x:e.x||0,y:e.y||0,w:e.w||16,h:e.h||16,ox:e.ox||0,oy:e.oy||0},image:this.imageName,position:this.position,screen:this.screen},this.tileCode=="G-G-G-G"){let t=y.randomIntRange(0,2),n=Math.random();Math.random()>.98?t=8:Math.random()>.95?t=y.randomIntRange(5,7):n>.6&&(t=y.randomIntRange(3,4)),this.sprite.metrics.x+=t*this.sprite.metrics.w}}}});var gn,V,dt=T(()=>{"use strict";gn={beacon:{main:{x:0,y:0,w:31,h:56,ox:-1,oy:-1},light:{x:31,y:0,w:5,h:4,ox:13,oy:0}},seed:{plant:{x:36,y:0,w:16,h:22,ox:2,oy:2},orb:{x:36,y:22,w:8,h:8,ox:8,oy:4}}},V=class{constructor(i){a(this,"map");this.map=JSON.parse(JSON.stringify(gn[i]))}}});var li={};H(li,{default:()=>Ne});var Ne,di=T(()=>{"use strict";oe();X();dt();Ne=class extends I{constructor(e,t,n){super({position:{x:e,y:t,z:n},pixelSize:{x:15,y:16,z:45},height:2.5});a(this,"unWalkable",!0);a(this,"imageName","props");a(this,"sheet");a(this,"pinging",0);this.on("draw",o=>{this.exists&&o.drawEntity(this)}),this.sheet=new V("beacon"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.main)}addToGame(e){super.addToGame(e),e.on("update",this.onUpdate.bind(this)),this.drawSprite()}drawSprite(){if(!this.sheet?.map?.main||!this.game?.renderer?.images?.[this.imageName])return;let e=new C(this.sheet.map.main.w,this.sheet.map.main.h);e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.main.x,this.sheet.map.main.y,this.sheet.map.main.w,this.sheet.map.main.h,0,0,this.sheet.map.main.w,this.sheet.map.main.h),this.pinging&&this.sheet.map.light&&e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.light.x,this.sheet.map.light.y,this.sheet.map.light.w,this.sheet.map.light.h,this.sheet.map.light.ox,0,this.sheet.map.light.w,this.sheet.map.light.h,this.pinging/100),this.sprite&&(this.sprite.image=e.canvas)}onUpdate(){this.pinging&&(this.pinging=Math.max(0,this.pinging-1),this.drawSprite())}ping(){this.pinging=100}}});var mi={};H(mi,{default:()=>Re});var Re,gi=T(()=>{"use strict";P();oe();dt();Re=class extends I{constructor(e){let t={position:{x:e.destination.x,y:e.destination.y,z:e.destination.z},pixelSize:{x:12,y:12,z:16},height:1};super(t);a(this,"unwalkable",!0);a(this,"origin");a(this,"sheet");a(this,"boundGrow");a(this,"boundWither");a(this,"growTime",80);a(this,"growStage",0);a(this,"growthStage");this.origin=e.origin,this.on("draw",n=>{this.exists&&n.drawEntity(this)}),this.sprite&&(this.sprite.image="props"),this.boundGrow=this.grow.bind(this),this.boundWither=this.wither.bind(this),this.sheet=new V("seed"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.plant)}addToGame(e){super.addToGame(e),this.tickDelay(this.boundGrow,this.growTime+y.randomIntRange(this.growTime/-6,this.growTime/6))}grow(){this.growStage++;let e=JSON.parse(JSON.stringify(this.sheet.map.plant));e.x+=this.sprite.metrics.w*this.growStage,this.sprite.metrics=e;let t=this.growTime+y.randomIntRange(this.growTime/-6,this.growTime/6);this.growStage<5?this.tickDelay(this.boundGrow,t):this.tickDelay(this.boundWither,Math.floor(t/2))}wither(){let e=this.sheet.map.orb;this.sprite.metrics=JSON.parse(JSON.stringify(e)),this.tickRepeat(t=>{this.sprite.metrics.oy=Math.round(e.oy+t.ticks/2),t.percent>=1&&(this.growthStage=6)},26)}}});z();var $t=B(A(),1);z();var Pe,Qe=null,ge=class extends $t.EventEmitter{constructor(e,t){super();a(this,"game");a(this,"world");a(this,"actors",{});a(this,"messageQueue",{});this.setMaxListeners(0),this.game=e,this.game.once("destroy",this.destroy.bind(this)),this.game.users=this,this.world=t,this.actors={},this.messageQueue={},Qe=this.loadActor()}async loadActor(){try{Pe=(await Promise.resolve().then(()=>(Yt(),Xt))).default}catch(e){throw d.error("Failed to load Actor class",{error:e instanceof Error?e.message:String(e)}),e}}async addActor(e){if(!Pe&&Qe&&await Qe,!Pe){d.error("Actor class not loaded yet");return}let t=this.world.randomEmptyGrid(),n=new Pe({x:+t.split(":")[0],y:+t.split(":")[1],z:0,uid:e.uid,username:e.username,roleColor:e.roleColor,maxListeners:this.getMaxListeners()+3});this.actors[n.uid]=n,n.addToGame(this.game),n.updatePresence(e.status)}async updateActor(e){let t=this.actors[e.uid];t?e.delete?(t.updatePresence("offline"),this.removeActor(t)):t.updatePresence(e.status):await this.addActor(e)}removeActor(e){delete this.actors[e.uid],e.remove()}queueMessage(e){!e.message||!this.actors[e.uid]||(this.messageQueue[e.channel]||(this.messageQueue[e.channel]={busy:!1,messages:[]}),this.messageQueue[e.channel].messages.push({uid:e.uid,message:e.message}),this.onMessageAdded(e.channel))}onMessageAdded(e){let t=this.messageQueue[e];if(t.busy||t.messages.length<1)return;t.busy=!0;let n=t.messages[0],r=this;this.actors[n.uid].startTalking(n.message,e,function(){r.messageQueue[e].messages.shift(),r.messageQueue[e].busy=!1,r.onMessageAdded(e)}),this.emit("message",{user:this.actors[n.uid],channel:e})}getActorAtPosition(e,t,n){for(let r in this.actors)if(this.actors.hasOwnProperty(r)&&this.actors[r].position.x==e&&this.actors[r].position.y==t&&this.actors[r].position.z==n)return this.actors[r]}destroy(){this.actors={},this.messageQueue={}}};var Ht=B(A(),1);z();var et=class extends Ht.EventEmitter{constructor(e){super();a(this,"clientId");a(this,"redirectUri");a(this,"scopes");a(this,"state");a(this,"accessToken",null);a(this,"user",null);this.clientId=e.clientId,this.redirectUri=e.redirectUri||window.location.origin+"/discord-callback.html",this.scopes=e.scopes||["identify"],this.state=this.generateState(),this.loadStoredAuth()}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}getAuthUrl(){return"https://discord.com/api/oauth2/authorize?"+new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,response_type:"token",scope:this.scopes.join(" "),state:this.state}).toString()}login(){let e=this.getAuthUrl();d.info("Starting Discord OAuth login",{authUrl:e}),localStorage.setItem("discord_oauth_state",this.state);let t=window.open(e,"discord_oauth","width=500,height=700,scrollbars=yes");if(!t){d.error("Discord OAuth popup was blocked by browser"),this.emit("login-error","Popup was blocked by browser. Please allow popups for this site.");return}d.debug("Discord OAuth popup opened successfully");let n=this,r=h=>{if(d.debug("Received message from Discord OAuth popup",{type:h.data?.type,origin:h.origin}),h.origin!==window.location.origin){d.debug("Ignoring message from different origin",{expectedOrigin:window.location.origin,receivedOrigin:h.origin});return}let l=h.data;if(l.type==="discord-auth-success"){let c=l,u=c.accessToken,m=c.state,p=c.expiresIn;if(d.info("Discord OAuth success received",{accessTokenLength:u?u.length:0,state:m}),window.removeEventListener("message",r),m!==n.state){d.error("Discord OAuth state mismatch",{expected:n.state,received:m}),n.emit("login-error","Invalid state parameter");return}u?(n.accessToken=u,n.storeAuth({access_token:u,expires_in:p}),n.fetchUserInfo()):(d.error("No access token in Discord OAuth success message"),n.emit("login-error","No access token received"))}else if(l.type==="discord-auth-error"){let c=l;d.error("Discord OAuth error received",{error:c.error}),window.removeEventListener("message",r),n.emit("login-error",c.error)}};window.addEventListener("message",r);let o=setInterval(()=>{t.closed&&(d.info("Discord OAuth popup was closed by user"),clearInterval(o),window.removeEventListener("message",r),n.emit("login-cancelled"))},1e3)}fetchUserInfo(){let e=this;fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+this.accessToken}}).then(t=>t.json()).then(t=>{e.user=t,localStorage.setItem("discord_user",JSON.stringify(t)),e.emit("login-success",t)}).catch(t=>{e.emit("login-error",t.message)})}logout(){this.accessToken=null,this.user=null,localStorage.removeItem("discord_auth_token"),localStorage.removeItem("discord_auth_expires"),localStorage.removeItem("discord_user"),this.emit("logout")}storeAuth(e){if(localStorage.setItem("discord_auth_token",e.access_token),e.expires_in){let t=Date.now()+e.expires_in*1e3;localStorage.setItem("discord_auth_expires",t.toString())}}loadStoredAuth(){let e=localStorage.getItem("discord_auth_token"),t=localStorage.getItem("discord_auth_expires"),n=localStorage.getItem("discord_user");if(e&&(!t||Date.now()<parseInt(t))){if(this.accessToken=e,n)try{this.user=JSON.parse(n)}catch{}this.accessToken&&!this.user&&this.fetchUserInfo()}else this.logout()}isLoggedIn(){return!!(this.accessToken&&this.user)}getUser(){return this.user}getAvatarUrl(e=128){return!this.user||!this.user.avatar?null:`https://cdn.discordapp.com/avatars/${this.user.id}/${this.user.avatar}.png?size=${e}`}},tt=et;P();P();var Kt=B(A(),1);X();z();var it=class extends Kt.EventEmitter{constructor(e){super();a(this,"id");a(this,"game");a(this,"backgroundColor");a(this,"scale");a(this,"canvases",[]);a(this,"canvas");a(this,"context");a(this,"width");a(this,"height");a(this,"halfWidth");a(this,"halfHeight");a(this,"panning");a(this,"images");this.id=e.id,this.game=e.game,this.backgroundColor=e.backgroundColor,this.scale=e.initialScale;for(let n=1;n<5;n++){let r=new C(1,1);r.canvas.id=this.id+n,document.body.appendChild(r.canvas),r.canvas.style.transform=`scale(${n}, ${n})`;let o=r.context;o.mozImageSmoothingEnabled!==void 0&&(o.mozImageSmoothingEnabled=!1),o.imageSmoothingEnabled=!1,r.canvas.addEventListener("contextmenu",h=>{h.preventDefault()}),this.canvases.push(r)}this.onZoom(),this.onResize(),window.addEventListener("resize",this.onResize.bind(this)),this.panning={buttons:[],origin:{x:0,y:0},panned:{x:0,y:32}};let t=this;this.game.on("mousedown",n=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=n.x,t.panning.origin.y=n.y),t.panning.buttons.push(n.button))}),this.game.on("mouseup",n=>{Z.findAndRemove(n.button,t.panning.buttons)}),this.game.on("mousemove",n=>{let r=n.x-t.panning.origin.x,o=n.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=r,t.panning.panned.y+=o),t.panning.origin.x=n.x,t.panning.origin.y=n.y}),this.game.on("touchstart",n=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=n.x,t.panning.origin.y=n.y),t.panning.buttons.push(n.button))}),this.game.on("touchend",n=>{Z.findAndRemove(n.button,t.panning.buttons)}),this.game.on("touchmove",n=>{let r=n.x-t.panning.origin.x,o=n.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=r,t.panning.panned.y+=o),t.panning.origin.x=n.x,t.panning.origin.y=n.y}),this.game.on("mouseout",n=>{}),this.game.on("mouseover",n=>{t.panning.origin.x=n.x,t.panning.origin.y=n.y,n.button||(t.panning.buttons=[])}),this.game.on("mousewheel",n=>{let r=Z.clamp(t.scale+(n.direction==="up"?1:-1),1,4);r!==t.scale&&(t.scale=r,t.onZoom(),t.onResize())})}setRenderer(e){this.images=e.images}onResize(){this.width=this.canvas.canvas.width=Math.ceil(window.innerWidth/this.scale),this.height=this.canvas.canvas.height=Math.ceil(window.innerHeight/this.scale),this.halfWidth=Math.round(this.width/2),this.halfHeight=Math.round(this.height/2),this.emit("resize",{scale:this.scale,width:this.width,height:this.height})}onZoom(){for(let e=0;e<this.canvases.length;e++)e+1===this.scale?(this.canvases[e].canvas.style.zIndex="5",this.canvas=this.canvases[e],this.context=this.canvas.context):this.canvases[e].canvas.style.zIndex="1"}draw(){}drawStatic(e){this.context.drawImage(e,0,0)}drawBG(e){if(!e||!e.image){d.error("Canvas drawBG: No bgCanvas or bgCanvas.image");return}let t=e.x+this.halfWidth+this.panning.panned.x,n=e.y+this.halfHeight+this.panning.panned.y;if(t>=this.width||n>=this.height||t*-1>=e.image.width||n*-1>=e.image.height)return;let r={x:Math.max(0,t),y:Math.max(0,n)},o={w:Math.min(e.image.width,this.width,this.width-t),h:Math.min(e.image.height,this.height,this.height-n)},h={x:Math.max(0,t*-1),y:Math.max(0,n*-1)},l={x:Math.min(e.image.width,h.x+o.w),y:Math.min(e.image.height,h.y+o.h)},c={x:l.x-h.x,y:l.y-h.y};this.context.drawImage(e.image,h.x,h.y,c.x,c.y,r.x,r.y,c.x,c.y)}drawEntity(e){if(!e||!e.image||e.hidden||e.position&&e.position.z>this.game.hideZ)return;let t={x:e.screen.x+this.halfWidth+this.panning.panned.x+(e.metrics.ox||0),y:e.screen.y+this.halfHeight+this.panning.panned.y+(e.metrics.oy||0)};if(e.keepOnScreen&&(t.x=Math.min(this.width-e.metrics.w,Math.max(0,t.x)),t.y=Math.min(this.height-e.metrics.h,Math.max(0,t.y))),t.x>=this.width||t.y>=this.height||t.x+e.metrics.w<=0||t.y+e.metrics.h<=0)return;let n;if(Array.isArray(e.image)){let h=this.images[e.image[0]];if(!h){d.error("Canvas drawEntity: Color collection not found",{requestedCollection:e.image[0],availableImages:Object.keys(this.images)});return}if(n=h[e.image[1]],!n){d.error("Canvas drawEntity: Colored sprite not found",{requestedSprite:e.image,availableInCollection:Object.keys(h)});return}}else if(typeof e.image=="string"){if(n=this.images[e.image],!n){d.error("Canvas drawEntity: Image not found",{requestedImage:e.image,availableImages:Object.keys(this.images)});return}}else n=e.image;let r=e===this.game.mouseOver?.sprite;if(r&&(this.context.save(),this.context.shadowColor="rgba(255,255,255,1)",this.context.shadowBlur=3),!e.stay&&e.parent&&this.game.mouseOver!==e.parent)return;if(!isFinite(t.x)||!isFinite(t.y)||!isFinite(e.metrics.x)||!isFinite(e.metrics.y)||!isFinite(e.metrics.w)||!isFinite(e.metrics.h)){d.error("Canvas drawEntity: NaN detected in coordinates",{spriteType:e.constructor?.name||"unknown",spriteParent:e.parent?.constructor?.name||"no parent",spriteParentUsername:e.parent?.username||"no username",spriteParentPosition:e.parent?.position||"no position",spriteImage:typeof e.image=="string"?e.image:"canvas object",screen:{x:t.x,y:t.y},metrics:e.metrics,drawImageParams:[e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h]});return}this.canvas.drawImage(n,e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h),r&&this.context.restore(),this.game.showGrid&&e.grid&&(this.context.fillStyle="#bbbbbb",this.context.font="9px Arial",this.context.fillText(e.grid,Math.round(t.x)+5,Math.round(t.y)+9))}},Zt=it;var Qt=B(A(),1);z();P();var Jt=B(A(),1);var Ie=class extends Jt.EventEmitter{constructor(){super();a(this,"mouseX",0);a(this,"mouseY",0);a(this,"mouseLeft",!1);a(this,"mouseRight",!1);a(this,"mouseOut",!1);a(this,"keys",{});a(this,"canvas",null);a(this,"mouseScale",1);this.setMaxListeners(0),document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this))}bindCanvas(e){this.canvas=e.canvas.canvas,this.mouseScale=e.scale,window.addEventListener("mousemove",this.mousemove.bind(this)),window.addEventListener("mousedown",this.mousedown.bind(this)),window.addEventListener("mouseup",this.mouseup.bind(this)),window.addEventListener("touchmove",this.touchmove.bind(this)),window.addEventListener("touchstart",this.touchstart.bind(this)),window.addEventListener("touchend",this.touchend.bind(this)),window.addEventListener("touchcancel",this.touchend.bind(this)),document.addEventListener("mouseout",this.mouseout.bind(this)),document.addEventListener("mouseover",this.mouseover.bind(this));let t="onwheel"in document.createElement("div")?"wheel":"mousewheel";window.addEventListener(t,this.mousewheel.bind(this))}mousemove(e){let t=e;this.mouseOut||(this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mousemove",{x:this.mouseX,y:this.mouseY}))}touchstart(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchstart",{button:"touch",x:this.mouseX,y:this.mouseY})}touchend(e){let t=e.changedTouches[0];this.emit("touchend",{button:"touch",x:t.pageX,y:t.pageY})}touchmove(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchmove",{button:"touch",x:this.mouseX,y:this.mouseY})}mousedown(e){let n=De[e.button];switch(n){case"left":this.mouseLeft=!0;break;case"right":this.mouseRight=!0;break}this.emit("mousedown",{button:n,x:this.mouseX,y:this.mouseY})}mouseup(e){let n=De[e.button];switch(n){case"left":this.mouseLeft=!1;break;case"right":this.mouseRight=!1;break}this.emit("mouseup",{button:n,x:this.mouseX,y:this.mouseY})}mouseout(e){let t=e,n=De[t.button];this.mouseOut=!0,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseout",{x:this.mouseX,y:this.mouseY,button:n})}mouseover(e){let t=e,n=t.buttons&1?1:t.buttons&2?2:t.buttons&4?3:0,r=De[n-1];this.mouseOut=!1,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseover",{x:this.mouseX,y:this.mouseY,button:r})}mousewheel(e){let t=e;if(!t.deltaY)return;let n=t.deltaY>0?"down":"up";this.emit("mousewheel",{direction:n,x:this.mouseX,y:this.mouseY})}keydown(e){let t=e,n=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():qt[t.keyCode];n==="backspace"&&t.preventDefault(),!this.keys[n]&&(this.keys[n]=!0,this.emit("keydown",{key:n}))}keyup(e){let t=e,n=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():qt[t.keyCode];this.keys[n]&&(this.keys[n]=!1,this.emit("keyup",{key:n}))}},De=["left","middle","right"],qt={37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"};var Vt=typeof performance<"u"&&performance.now?()=>performance.now():()=>Date.now(),nt=class extends Qt.EventEmitter{constructor(e={}){super();a(this,"step");a(this,"lastUpdate",0);a(this,"dt",0);a(this,"ticks",0);a(this,"crashed");a(this,"paused");a(this,"input");a(this,"mouseButtons",[]);a(this,"centerMouseX",-999);a(this,"centerMouseY",-999);a(this,"mouseX");a(this,"mouseY");a(this,"mouseOut");a(this,"mouseOver");a(this,"entities",[]);a(this,"schedule",[]);a(this,"viewWidth");a(this,"viewHeight");a(this,"interval");a(this,"renderer");a(this,"ui");a(this,"users");a(this,"servers");a(this,"server");a(this,"world");a(this,"timeUpdates");a(this,"timeRenders");a(this,"showGrid");a(this,"helpPanel");a(this,"helpButton");a(this,"serverListPanel");a(this,"pendingServerJoin");a(this,"decorator");a(this,"hideZ");this.setMaxListeners(0),this.step=e.step||1e3/60,this.input=new Ie,this.input.on("keydown",this.keydown.bind(this)),this.input.on("keyup",this.keyup.bind(this));let t=this;this.interval=setInterval(function(){if(t.crashed)return;let n=Vt();if(t.dt+=n-t.lastUpdate,t.lastUpdate>0&&t.dt>6e4&&(d.error("Game engine: Too many updates missed, crashing",{deltaTime:t.dt,lastUpdate:t.lastUpdate,currentTime:n}),t.crashed=!0,t.paused=!0),t.dt>t.step)for(;t.dt>=t.step;)t.dt-=t.step,!t.paused&&(t.ticks++,t.update());t.lastUpdate=Vt()},this.step)}update(){let e=this.timeUpdates&&(this.ticks&255)===0;e&&console.time("update"),this.emit("update");for(let t=0;t<this.schedule.length;t++){let n=this.schedule[t],r;if(n.type==="repeat"){if(r=n.start+n.count,n.start<=this.ticks){let o=this.ticks-n.start,h=n.count>0?o/n.count:1;if(!isFinite(h)){d.error("Game update: Invalid progress calculation",{ticks:o,taskCount:n.count,taskStart:n.start,gameTicks:this.ticks,percent:h}),n.type="deleted";continue}n.cb({ticks:o,percent:h})}}else n.type==="once"&&(r=n.tick);(n.type==="deleted"||r!==void 0&&r<=this.ticks)&&(n.type==="once"?n.cb():n.type==="repeat"&&n.afterCB&&n.afterCB(),this.schedule.splice(t,1),t--)}this.emit("render"),e&&console.timeEnd("update")}bindCanvas(e){this.input.bindCanvas(e),this.viewWidth=e.width,this.viewHeight=e.height,this.input.on("mousemove",this.mousemove.bind(this)),this.input.on("mousedown",this.mousedown.bind(this)),this.input.on("mouseup",this.mouseup.bind(this)),this.input.on("mouseout",this.mouseout.bind(this)),this.input.on("mouseover",this.mouseover.bind(this)),this.input.on("mousewheel",this.mousewheel.bind(this)),this.input.on("touchmove",this.touchmove.bind(this)),this.input.on("touchstart",this.touchstart.bind(this)),this.input.on("touchend",this.touchend.bind(this)),this.input.on("touchcancel",this.touchcancel.bind(this)),e.on("resize",this.viewResize.bind(this))}viewResize(e){this.viewWidth=e.width,this.viewHeight=e.height,this.input.mouseScale=e.scale,d.canvasResize(e.width,e.height),this.emit("resize",e)}mousemove(e){this.mouseOut||(this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("mousemove",e))}mousedown(e){this.mouseOver&&(d.debug("Game mousedown: Target selected",{target:this.mouseOver.constructor?.name||"unknown",position:this.mouseOver.position||null}),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("mousedown",e)}touchend(e){Z.findAndRemove(e.button,this.mouseButtons),this.emit("touchend",e)}touchmove(e){this.mouseOut||(this.mouseOut=!1,this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("touchmove",e))}touchcancel(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("touchcancel",e)}touchstart(e){this.mouseOver&&(d.debug("Game touchstart: Target selected",{target:this.mouseOver.constructor?.name||"unknown",position:this.mouseOver.position||null}),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("touchstart",e)}mouseup(e){Z.findAndRemove(e.button,this.mouseButtons),this.emit("mouseup",e)}mouseout(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("mouseout",e)}mouseover(e){this.mouseOut=!1,this.emit("mouseover",e)}mousewheel(e){this.emit("mousewheel",e)}keydown(e){this.emit("keydown",e)}keyup(e){this.emit("keyup",e)}reset(){for(this.emit("destroy"),this.removeAllListeners("update"),this.schedule=[];this.entities.length>0;)this.entities[0].remove?this.entities[0].remove():this.entities.splice(0,1)}},ei=nt;X();var st=["actors","environment","static-tiles","props","font"],rt=class{constructor(i){a(this,"images",{});a(this,"imagesLoaded",0);a(this,"onComplete");this.onComplete=i;for(let e=0;e<st.length;e++){let t=st[e],n=t+".png",r=new Image;r.addEventListener("load",()=>this.onImageLoad(r,t)),r.src="./img/"+n}}onImageLoad(i,e){let t=new C(i.width,i.height);this.images[e]=t.canvas,t.drawImage(i,0,0,i.width,i.height,0,0,i.width,i.height),this.imagesLoaded++,this.imagesLoaded===st.length&&this.onComplete(this.images)}},ti=rt;var ni=B(A(),1);function ln(s,i){let e=document.createElement("canvas");e.width=s.width,e.height=s.height;let t=e.getContext("2d",{willReadFrequently:!0});t.drawImage(s,0,0);let n=t.getImageData(0,0,e.width,e.height),r=i.getContext("2d",{willReadFrequently:!0}),o=r.getImageData(0,0,i.width,i.height);for(let h=3;h<o.data.length;h+=4)o.data[h]=n.data[h];r.putImageData(o,0,0)}var ii={colorize:function(s){let i=document.createElement("canvas");i.width=s.image.width,i.height=s.image.height;let e=i.getContext("2d",{willReadFrequently:!0});e.drawImage(s.image,0,0,s.image.width,s.image.height,0,0,s.image.width,s.image.height),e.globalCompositeOperation="color";let t=document.createElement("canvas");t.width=s.image.width,t.height=s.image.height;let n=t.getContext("2d");if(n.fillStyle=s.color,n.globalAlpha=s.alpha,n.fillRect(0,0,s.image.width,s.image.height),s.regions)for(let r=0;r<s.regions.length;r++){let o=s.regions[r];n.clearRect(o.x,o.y,o.w,o.h),n.fillStyle=o.color?o.color:s.color,n.globalAlpha=o.alpha?o.alpha:s.alpha,n.fillRect(o.x,o.y,o.w,o.h)}return e.drawImage(t,0,0),ln(s.image,i),i},interpolateRGBA:function(s,i,e){let t=s.substring(5,s.length-2).split(","),n=+t[0],r=+t[1],o=+t[2],h=+t[3],l=i.substring(5,i.length-2).split(","),c=+l[0],u=+l[1],m=+l[2],p=+l[3];return"rgba("+[Math.round(n+(c-n)*e),Math.round(r+(u-r)*e),Math.round(o+(m-o)*e),h+(p-h)*e].join(",")+")"}};z();var ot=class extends ni.EventEmitter{constructor(e){super();a(this,"game");a(this,"images");a(this,"updateDrawn",!1);a(this,"zBuffer",{});a(this,"zBufferKeys",[]);a(this,"overlay",[]);a(this,"frames",0);a(this,"canvases");a(this,"bgCanvas");this.game=e.game,this.images=e.images;let t=this;this.game.on("render",function(){t.updateDrawn=!1});let n=()=>{if(t.updateDrawn===!1){if(t.canvases){let r=t.game.timeRenders&&(t.game.ticks&511)===0;r&&console.time("render");for(let o=0;o<t.canvases.length;o++){let h=t.canvases[o];h.canvas.fill(h.backgroundColor),t.bgCanvas&&h.drawBG(t.bgCanvas),t.game.servers||(h.context.fillStyle="#d4cfb6",h.context.font="14px Arial",h.context.textAlign="center",h.context.fillText("connecting...",Math.round(h.width/2),Math.round(h.height/2-4)));let l=0;for(let c=0;c<t.zBufferKeys.length;c++){let u=t.zBuffer[t.zBufferKeys[c]];for(let m=0;m<u.length;m++)h.drawEntity(u[m]),l++}for(let c=0;c<t.overlay.length;c++)h.drawEntity(t.overlay[c]),l++;t.game.ui&&t.game.ui.emit("draw",h)}r&&console.timeEnd("render")}t.updateDrawn=!0}requestAnimationFrame(n)};requestAnimationFrame(n)}addCanvas(e){e.setRenderer(this),this.canvases||(this.canvases=[]),this.canvases.push(e)}addToZBuffer(e,t){let n=this.zBuffer[t];n?(n.push(e),n.sort((r,o)=>{let h=(r.position?.z||0)+(r.position?.fakeZ||0),l=(o.position?.z||0)+(o.position?.fakeZ||0);return h-l})):this.zBuffer[t]=[e],this.zBufferKeys=Object.keys(this.zBuffer),this.zBufferKeys.sort((r,o)=>parseInt(r)-parseInt(o))}updateZBuffer(e,t,n){this.removeFromZBuffer(t,e),this.addToZBuffer(t,n)}removeFromZBuffer(e,t){let n=this.zBuffer[t];if(n){for(let r=0;r<n.length;r++)if(n[r]===e){n.splice(r,1);break}}}addColorSheet(e){if(this.images[e.color]||(this.images[e.color]={}),!this.images[e.color][e.sheet]){if(e.image=this.images[e.sheet],!e.image){d.error("Renderer addColorSheet: Base image not found",{requestedSheet:e.sheet,availableImages:Object.keys(this.images)});return}this.images[e.color][e.sheet]=ii.colorize(e)}}clear(){this.zBuffer={},this.zBufferKeys=[],this.overlay=[]}},si=ot;var ui=B(A(),1);z();X();te();P();var ht,ct,ut,lt,mn=new C(200,100),F,J=class extends ui.EventEmitter{constructor(e,t){super();a(this,"game");a(this,"worldSize");a(this,"worldRadius");a(this,"objects",{});a(this,"map",{});a(this,"walkable",{});a(this,"mapBounds",{xl:0,yl:0,xh:0,yh:0});a(this,"staticMap",[]);a(this,"islands",[]);a(this,"mainIsland",0);a(this,"tileMap",{});a(this,"initializationPromise");a(this,"debugOverlayRefreshScheduled",!1);this.game=e,this.game.world=this,this.worldSize=Math.max(24,Math.floor(t/2)*2),this.worldRadius=Math.floor(this.worldSize/2),this.initializationPromise=this.init()}async init(){try{let[e,t,n,r]=await Promise.all([Promise.resolve().then(()=>(oi(),ri)),Promise.resolve().then(()=>(ci(),hi)),Promise.resolve().then(()=>(at(),ai)),Promise.resolve().then(()=>(Ve(),_t))]);ht=e.default,ct=t.default,ut=n.default,lt=r.default,typeof window<"u"&&window.__E2E_TEST_MODE&&(window.__WorldDependencies={Slab:ht,Tile:ct,TileSheet:ut,Pathfinder:lt,geometry:k},console.log("\u2705 [E2E] World dependencies exposed"))}catch(e){throw d.error("World: Failed to load world dependencies",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}),e}}generateWorld(){k.generateClosestGrids(this.worldSize),mn.clear();let e=k.buildNoiseMap(this.worldRadius/3+1,this.worldRadius/3+1),t=k.buildNoiseMap(this.worldRadius/1.5+1,this.worldRadius/1.5+1),n=(e.length-1)/this.worldSize,r=(t.length-1)/this.worldSize;this.mapBounds={xl:0,yl:0,xh:0,yh:0};for(let h=0;h<this.worldSize;h++)for(let l=0;l<this.worldSize;l++){let c=k.getNoiseMapPoint(e,h*n,l*n),u=k.getNoiseMapPoint(t,h*r,l*r),m=(c+u*2)/3,p=h-this.worldRadius,f=l-this.worldRadius,M=(this.worldRadius-(Math.abs(p)+Math.abs(f))/2)/this.worldRadius;if(m/1.1<M){this.mapBounds.xl=Math.min(p,this.mapBounds.xl),this.mapBounds.yl=Math.min(f,this.mapBounds.yl),this.mapBounds.xh=Math.max(p,this.mapBounds.xh),this.mapBounds.yh=Math.max(f,this.mapBounds.yh);let b=new ht("grass",p,f,-.5);b.grid=p+":"+f,this.map[p+":"+f]=b,b.addToGame(this.game)}}d.info("World: Generated slab tiles",{tileCount:Object.keys(this.map).length}),this.staticMap=[],this.crawlMap(),this.createTiles(),this.createBackground(),d.isDebugMode()&&this.createDebugOverlay(),lt.loadMap(this.walkable),F=Object.keys(this.map);let o=F.indexOf("0:0");o>-1&&F.splice(o,1),d.worldGenerated({totalTiles:Object.keys(this.map).length,spawnablePositions:F.length,worldSize:this.worldSize,worldRadius:this.worldRadius,mapBounds:this.mapBounds,mainIslandSize:this.islands[this.mainIsland]?.length||0,totalIslands:this.islands.length,spawnPositions:F.slice(0,10)}),d.info("World: Created world",{tileCount:Object.keys(this.map).length})}createBackground(){d.debug("World: Creating background",{staticMapCount:this.staticMap.length});let e=0,t=0,n=0,r=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y};u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,e=e<u.x?e:u.x,t=t<u.y?t:u.y,n=n>u.x?n:u.x,r=r>u.y?r:u.y}d.debug("World: Calculated screen bounds",{lowestScreenX:e,lowestScreenY:t,highestScreenX:n,highestScreenY:r});let o=new C(n-e+32+1,r-t+32+9),h=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y},m=!isFinite(c.screen.x)||!isFinite(c.screen.y)||!isFinite(c.sprite.metrics.ox||0)||!isFinite(c.sprite.metrics.oy||0);if((l<3||m)&&d.debug("World: Background tile data",{tileIndex:l,tileScreen:c.screen,spriteMetrics:c.sprite.metrics,screenBeforeOffset:{x:u.x,y:u.y},hasNaN:m}),u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,u.x-=e,u.y-=t,!isFinite(u.x)||!isFinite(u.y)){d.error("World: NaN detected in background tile",{tileIndex:l,originalScreen:{x:c.screen.x,y:c.screen.y},spriteOffsetX:c.sprite.metrics.ox,spriteOffsetY:c.sprite.metrics.oy,lowestScreenX:e,lowestScreenY:t,finalScreen:u});continue}let p=this.game.renderer.images[c.sprite.image];if(!p){d.error("World: Missing image for background tile",{tileImage:c.sprite.image,tileIndex:l});continue}o.drawImage(p,c.sprite.metrics.x,c.sprite.metrics.y,c.sprite.metrics.w,c.sprite.metrics.h,Math.round(u.x),Math.round(u.y),c.sprite.metrics.w,c.sprite.metrics.h),h++,l<5&&d.debug("World: Drew background tile",{tileIndex:l,image:c.sprite.image,sourceRect:`${c.sprite.metrics.x},${c.sprite.metrics.y} ${c.sprite.metrics.w}x${c.sprite.metrics.h}`,destPos:`${Math.round(u.x)},${Math.round(u.y)}`})}this.game.renderer.bgCanvas={x:e,y:t,image:o.canvas}}scheduleDebugOverlayRefresh(){if(!d.isDebugMode()||this.debugOverlayRefreshScheduled)return;this.debugOverlayRefreshScheduled=!0;let e=()=>{try{this.createBackground(),this.createDebugOverlay()}catch(t){d.warn("Debug: Overlay refresh failed",{error:t?.message})}finally{this.debugOverlayRefreshScheduled=!1}};typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(e):setTimeout(e,0)}createDebugOverlay(){if(!this.game.renderer.bgCanvas){d.warn("Debug: Cannot create debug overlay - no background canvas available");return}d.info("Debug: Creating walkable tile overlay");let e=this.game.renderer.bgCanvas,n=e.image.getContext("2d");if(!n){d.error("Debug: Cannot get canvas context for debug overlay");return}n.strokeStyle="#FF0000",n.lineWidth=2,n.globalAlpha=.8;let r=0,o=0,h=0;for(let l in this.map){if(!this.map.hasOwnProperty(l))continue;let c=this.map[l],u=c.position.x,m=c.position.y;h++;let p=!1,f=this.objects[u]?.[m];if(f)for(let E in f){if(!f.hasOwnProperty(E))continue;let L=f[E];if(L&&L.constructor&&L.constructor.name==="Actor"){p=!0;break}}let M=c.position.z,w=(u-m)*16-8+8-e.x,v=(u+m)*8-M*16-8-e.y,S=4;p?(o++,n.strokeStyle="#007BFF",n.beginPath(),n.moveTo(w-S,v-S),n.lineTo(w+S,v+S),n.moveTo(w+S,v-S),n.lineTo(w-S,v+S),n.stroke(),n.strokeStyle="#FF0000"):this.canWalk(u,m)&&(r++,n.beginPath(),n.moveTo(w-S,v-S),n.lineTo(w+S,v+S),n.moveTo(w+S,v-S),n.lineTo(w-S,v+S),n.stroke())}try{n.save(),n.globalAlpha=.95,n.lineWidth=2,n.strokeStyle="#00AAFF",n.fillStyle="#00AAFF",n.font="12px sans-serif";let m=(v,S,E,L)=>{n.beginPath(),n.moveTo(v,S),n.lineTo(E,L),n.stroke();let $=Math.atan2(L-S,E-v),G=6;n.beginPath(),n.moveTo(E,L),n.lineTo(E-G*Math.cos($-Math.PI/6),L-G*Math.sin($-Math.PI/6)),n.lineTo(E-G*Math.cos($+Math.PI/6),L-G*Math.sin($+Math.PI/6)),n.lineTo(E,L),n.fill()},p={N:{dx:16,dy:-8},E:{dx:16,dy:8},S:{dx:-16,dy:8},W:{dx:-16,dy:-8}};n.beginPath(),n.arc(40,40,2,0,Math.PI*2),n.fill();let f={x:40+p.N.dx*3,y:40+p.N.dy*3},M={x:40+p.E.dx*3,y:40+p.E.dy*3},b={x:40+p.S.dx*3,y:40+p.S.dy*3},w={x:40+p.W.dx*3,y:40+p.W.dy*3};m(40,40,f.x,f.y),m(40,40,M.x,M.y),m(40,40,b.x,b.y),m(40,40,w.x,w.y),n.fillText("N",f.x+6,f.y-2),n.fillText("E",M.x+6,M.y+12),n.fillText("S",b.x-14,b.y+12),n.fillText("W",w.x-14,w.y-2),n.restore()}catch(l){d.warn("Debug: Failed to draw compass overlay",{error:l?.message})}n.globalAlpha=1,d.info("Debug: Walkable tile overlay complete",{totalTiles:h,walkableTiles:r,unwalkableTiles:h-r,actorTiles:o})}crawlMap(){this.islands=[];let e={},t=0;for(let n=this.mapBounds.xl;n<=this.mapBounds.xh;n++)for(let r=this.mapBounds.yl;r<=this.mapBounds.yh;r++){let o=this.map[n+":"+r];if(!o||e[o.grid])continue;let h=[];for(;;){e[o.grid]=o,this.islands[t]?this.islands[t].push(o):this.islands.push([o]);let l=k.getNeighbors(o.grid);for(let c in l){if(!l.hasOwnProperty(c))continue;let u=this.map[l[c]];if(!u){o.border=!0;continue}e[u.grid]||h.push(u)}if(h.length>0)o=h.pop();else{t++;break}}}this.mainIsland=0;for(let n=1;n<this.islands.length;n++)this.mainIsland=this.islands[n].length>this.islands[this.mainIsland].length?n:this.mainIsland;for(let n=0;n<this.islands.length;n++)if(n!=this.mainIsland)for(let r=0;r<this.islands[n].length;r++)delete this.map[this.islands[n][r].grid],this.islands[n][r].remove();for(let n in this.map){if(!this.map.hasOwnProperty(n))continue;let r=this.map[n];if(r.border)r.style="plain";else{let o=k.get8Neighbors(r.grid);for(let h in o)if(o.hasOwnProperty(h)&&!this.map[o[h]]){r.style="plain";break}}}this.map["0:0"]&&(this.map["0:0"].style="plain"),this.map["1:0"]&&(this.map["1:0"].style="plain"),this.map["-1:0"]&&(this.map["-1:0"].style="plain"),this.map["0:1"]&&(this.map["0:1"].style="plain"),this.map["0:-1"]&&(this.map["0:-1"].style="plain"),this.createFlowerPatches()}createFlowerPatches(){for(let e=0;e<Math.ceil(Math.pow(this.worldRadius,2)/80);e++){let t=0,n,r;do{if(r=!0,n=this.map[y.pickInObject(this.map)],!n)continue;let h=k.get8Neighbors(n.grid);for(let l in h){if(!h.hasOwnProperty(l))continue;let c=this.map[h[l]];if(!c||c.style!="grass"){r=!1;break}}t++}while(t<1e3&&(n.style!="grass"||!r));if(t==1e3)continue;n.style="flowers";let o=y.randomIntRange(1,4);for(let h=0;h<o;h++){let l=!0,c=n.position.x+y.randomIntRange(-1,1),u=n.position.y+y.randomIntRange(-1,1),m=this.map[c+":"+u];if(!m)continue;let p=k.get8Neighbors(m.grid);for(let f in p){if(!p.hasOwnProperty(f))continue;let M=this.map[p[f]];if(!M||M.style!="grass"&&M.style!="flowers"){l=!1;break}}l&&(m.style="flowers")}}}createTiles(){this.tileMap={};let e=this;function t(o){return e.map[o].style[0].replace(/p/,"s").toUpperCase()}function n(o,h){return o==h?t(o):e.map[h]?t(h):"E"}function r(o,h,l,c){let u=h.grids,m=n(o,u[0])+"-"+n(o,u[1])+"-"+n(o,u[2])+"-"+n(o,u[3]);return new ut("tile").map[m]||d.error("World: Unknown tile code",{tileCode:m,neighborGrids:u,originalGrid:o}),{tileCode:m,position:h,grid:l,game:c}}for(let o in this.map){if(!this.map.hasOwnProperty(o))continue;let h=+o.split(":")[0],l=+o.split(":")[1],c=this.map[o].position.z,u=k.get8Neighbors(o),m={x:h-.5,y:l-.5,z:c,grids:[u.nw,u.n,o,u.w]},p={x:h+.5,y:l-.5,z:c,grids:[u.n,u.ne,u.e,o]},f={x:h+.5,y:l+.5,z:c,grids:[o,u.e,u.se,u.s]},M={x:h-.5,y:l+.5,z:c,grids:[u.w,o,u.s,u.sw]},b=[m,p,f,M];for(let w=0;w<b.length;w++){let v=c+":"+b[w].x+":"+b[w].y;this.tileMap[v]||(this.tileMap[v]=new ct(r(o,b[w],v,this.game)),this.staticMap.push(this.tileMap[v]))}}this.staticMap.sort(function(o,h){return o.zDepth-h.zDepth}),this.logTileMap(),this.logValidSpawnPositions()}logTileMap(){let e={},t={};for(let r in this.tileMap){if(!this.tileMap.hasOwnProperty(r))continue;let o=this.tileMap[r],h=o.tileCode||"UNKNOWN",l=o.position;e[r]={tileCode:h,x:l.x,y:l.y,z:l.z,grid:r},t[h]=(t[h]||0)+1}let n={};for(let r in this.map){if(!this.map.hasOwnProperty(r))continue;let o=this.map[r];n[r]=o.style}d.worldTileMap({totalTiles:Object.keys(this.tileMap).length,uniqueTileCodes:Object.keys(t).length,tilesByCode:t,gridTileTypes:n,tileMap:e})}logValidSpawnPositions(){let e=[],t=[];for(let n in this.map){if(!this.map.hasOwnProperty(n))continue;let r=this.map[n],o=r.position.x,h=r.position.y;if(o===0&&h===0){t.push(`${o}:${h} (beacon)`);continue}r.style==="grass"||r.style==="plain"||r.style==="flowers"?e.push(`${o}:${h}`):t.push(`${o}:${h} (${r.style})`)}d.worldSpawnAnalysis({totalPositions:Object.keys(this.map).length,validSpawnPositions:e.length,invalidSpawnPositions:t.length,validPositions:e,invalidPositions:t})}addToWorld(e){if(this.objects[e.position.x])if(this.objects[e.position.x][e.position.y]){if(this.objects[e.position.x][e.position.y][e.position.z])return d.error("World: Position occupied",{position:e.position,newObject:e.constructor?.name||"unknown",existingObject:this.objects[e.position.x][e.position.y][e.position.z].constructor?.name||"unknown"}),!1}else this.objects[e.position.x][e.position.y]={};else this.objects[e.position.x]={},this.objects[e.position.x][e.position.y]={};return this.objects[e.position.x][e.position.y][e.position.z]=e,this.updateWalkable(e.position.x,e.position.y),e?.constructor?.name==="Actor"&&this.scheduleDebugOverlayRefresh(),!0}removeFromWorld(e){this.objects[e.position.x]?.[e.position.y]?.[e.position.z]&&(delete this.objects[e.position.x][e.position.y][e.position.z],this.updateWalkable(e.position.x,e.position.y),e?.constructor?.name==="Actor"&&this.scheduleDebugOverlayRefresh())}moveObject(e,t,n,r){this.removeFromWorld(e),e.position.x=t,e.position.y=n,e.position.z=r,this.addToWorld(e)}updateWalkable(e,t){let n=this.objects[e]?.[t];if(!n||Object.keys(n).length==0){delete this.walkable[e+":"+t];return}let r=Object.keys(n).sort(function(h,l){return+h-+l}),o=n[+r[r.length-1]];if(o.unWalkable)delete this.walkable[e+":"+t];else{let h=o.position.z+o.height;this.walkable[e+":"+t]=h}}canWalk(e,t){if(!this.map[e+":"+t])return!1;let r=this.walkable[e+":"+t],o=this.objects[e]?.[t];if(!o||Object.keys(o).length===0)return!0;let h=Object.keys(o).sort((u,m)=>+u-+m);return!o[+h[h.length-1]].unWalkable}getHeight(e,t){let n=this.walkable[e+":"+t];if(n!==void 0)return n;let r=this.map[e+":"+t];return r?r.position.z+r.height:-.5}randomEmptyGrid(){return F.splice(y.randomIntRange(0,F.length-1),1)[0]}objectAtXYZ(e,t,n){return this.objects[e]?.[t]?.[n]||null}objectUnderXYZ(e,t,n){let r=this.objects[e]?.[t];if(!r)return null;let o=-1e3;for(let h in r)r.hasOwnProperty(h)&&(+h>n||(o=+h>o?+h:o));return r[o]||null}findObject(e){for(let t in this.objects){if(!this.objects.hasOwnProperty(t))continue;let n=this.objects[t];for(let r in n){if(!n.hasOwnProperty(r))continue;let o=n[r];for(let h in o)if(o.hasOwnProperty(h)&&e===o[h])return[t,r,h]}}return null}};typeof window<"u"&&window.__E2E_TEST_MODE&&(window.__WorldClass=J,window.__unoccupiedGrids=()=>F,window.__setUnoccupiedGrids=s=>{F=s},console.log("\u2705 [E2E] World class exposed on window.__WorldClass"),typeof window<"u"&&window.dispatchEvent(new CustomEvent("__worldClassReady",{detail:{World:J}})));var fi=B(A(),1);z();te();var mt,gt,fe=class extends fi.EventEmitter{constructor(e,t){super();a(this,"game");a(this,"world");a(this,"beacon");this.game=e,this.world=t,this.game.decorator=this,this.init()}async init(){try{let[e,t]=await Promise.all([Promise.resolve().then(()=>(di(),li)),Promise.resolve().then(()=>(gi(),mi))]);mt=e.default,gt=t.default,this.createBeacon()}catch(e){throw d.error("Decorator: Failed to load dependencies",{error:e instanceof Error?e.message:String(e)}),e}}sewSeed(e){if(!gt){d.error("Decorator: Seed class not loaded yet");return}let t;for(let r=0;r<k.closestGrids.length;r++){let o=k.closestGrids[r],h=this.world.map[e.origin.x+o[0]+":"+(e.origin.y+o[1])];if(!(!h||h.style=="plain")&&!this.world.objectAtXYZ(h.position.x,h.position.y,h.position.z+h.height)){t=h.position;break}}if(!t)return;new gt({origin:e.origin,destination:{x:t.x,y:t.y,z:t.z+.5}}).addToGame(this.game)}createBeacon(){if(!mt){d.error("Decorator: Beacon class not loaded yet");return}this.beacon=new mt(0,0,0),this.beacon.addToGame(this.game)}};var bi=B(A(),1);X();ne();var pi=B(A(),1);X();P();var R=class extends pi.EventEmitter{constructor(e){super();a(this,"ui");a(this,"parent");a(this,"elements");a(this,"w");a(this,"h");a(this,"autosize");a(this,"top");a(this,"bottom");a(this,"left");a(this,"right");a(this,"x",0);a(this,"y",0);a(this,"canvas");this.ui=e.ui,this.parent=e.parent,this.elements=[],this.w=1,this.h=1,e.w!==void 0?this.w=e.w:this.autosize=!0,e.h!==void 0?this.h=e.h:this.autosize=!0,e.top!==void 0&&(this.top=e.top),e.bottom!==void 0&&(this.bottom=e.bottom),e.left!==void 0&&(this.left=e.left),e.right!==void 0&&(this.right=e.right),this.canvas=new C(this.w||1,this.h||1),this.reposition()}reposition(){if(!(!this.parent||typeof this.parent.x!="number"||typeof this.parent.y!="number"||typeof this.parent.w!="number"||typeof this.parent.h!="number")&&(this.top!==void 0&&(this.top=="auto"?this.y=Math.round(this.parent.y+this.parent.h/2-this.h/2):this.y=this.parent.y+this.top),this.bottom!==void 0&&(this.y=this.parent.y+this.parent.h-this.h-this.bottom),this.left!==void 0&&(this.left=="auto"?this.x=Math.round(this.parent.x+this.parent.w/2-this.w/2):this.x=this.parent.x+this.left),this.right!==void 0&&(this.x=this.parent.x+this.parent.w-this.w-this.right),this.elements))for(let e=0;e<this.elements.length;e++)this.elements[e].reposition()}redraw(e){e.drawImage(this.canvas.canvas||this.canvas,0,0,this.w,this.h,this.x,this.y,this.w,this.h)}remove(){if(this.ui.mouseOnElement===this&&(this.ui.mouseOnElement=!1),this.removeAllListeners("redraw"),this.removeAllListeners("mouse-on-element"),this.removeAllListeners("mouse-off-element"),y.findAndRemove(this,this.ui.elements),this.elements)for(let e=0;e<this.elements.length;e++)this.elements[e].remove();this.ui.redraw()}resize(e,t){this.w=this.canvas.canvas.width=e,this.h=this.canvas.canvas.height=t,this.draw&&this.draw()}resizeChildren(e,t){if(this.elements)for(let n=0;n<this.elements.length;n++)this.elements[n].resize(e,t)}};ne();var pe=class extends R{constructor(e){super(e);a(this,"text");a(this,"textCanvas");a(this,"onPress");a(this,"disabled");a(this,"mouseOn");a(this,"pressed");a(this,"onMouseOnBound");a(this,"onMouseOffBound");a(this,"onMouseDownBound");a(this,"onMouseUpBound");e.text&&this.changeText(e.text),e.onPress&&(this.onPress=e.onPress),e.disabled&&(this.disabled=!0),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=D.blot({text:this.text}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2);let e="rgba("+(this.mouseOn?"77,102,184,0.9)":this.disabled?"245,240,213,0.3)":"0,0,0,0.8)");if(this.canvas.fillRect(e,1,1,this.w-2,this.h-2),this.textCanvas){let t=Math.floor((this.canvas.canvas.width-this.textCanvas.width)/2);this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,t,1,this.textCanvas.width,this.textCanvas.height)}this.emit("redraw")}onMouseOn(e){this.disabled||this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.disabled||!this.mouseOn||(this.mouseOn=!1,this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.disabled||!this.mouseOn||(this.pressed=!0,this.draw())}onMouseUp(e){this.disabled||!this.mouseOn||(this.pressed=!1,this.onPress&&this.onPress(),this.draw())}};var be=class extends R{constructor(i){super(i),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.emit("redraw")}};ne();P();var ve=class extends R{constructor(e){super(e);a(this,"text","");a(this,"textCanvas");a(this,"onSubmit");a(this,"focused");a(this,"mouseOn");a(this,"onMouseOnBound");a(this,"onMouseOffBound");a(this,"onMouseDownBound");a(this,"onMouseUpBound");a(this,"onKeyDownBound");this.changeText(e.text||""),e.onSubmit&&(this.onSubmit=e.onSubmit),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound),this.onKeyDownBound=this.onKeyDown.bind(this),this.on("key-down",this.onKeyDownBound)}changeText(e){this.text=e;let t=e+(this.focused?"_":"");this.textCanvas=D.blot({text:t}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear();let e=this.mouseOn?"rgba(220,220,220,0.8)":"rgba(255,255,255,0.8)";e=this.focused?"rgba(115,138,215,0.8)":e,this.canvas.fillRect(e,0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,1,1,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}focus(e){this.focused=e!==!1,this.changeText(this.text)}submit(){this.onSubmit&&this.onSubmit(this.text)}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn||this.focus(!1)}onMouseUp(e){this.mouseOn&&this.focus()}onKeyDown(e){if(!this.focused)return;e.key=="enter"&&this.submit();let t=e.key;if(e.key=="backspace")this.changeText(this.text.substring(0,Math.max(0,this.text.length-1)));else{if(e.key=="period"&&(t="."),e.key=="dash"&&(t="-"),t!="."&&t!="-"&&y.alphabet.indexOf(t)<0&&y.hex.indexOf(t)<0)return;this.changeText(this.text+(this.ui.game.input.keys.shift?t.toUpperCase():t))}}};ne();var ye=class extends R{constructor(e){super(e);a(this,"text");a(this,"textCanvas");a(this,"onPress");a(this,"hyperlink");a(this,"maxWidth");a(this,"mouseOn");a(this,"pressed");a(this,"onMouseOnBound");a(this,"onMouseOffBound");a(this,"onMouseDownBound");a(this,"onMouseUpBound");e.onPress&&(this.onPress=e.onPress),e.hyperlink&&(this.hyperlink=e.hyperlink),e.maxWidth&&(this.maxWidth=e.maxWidth),e.text&&this.changeText(e.text),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=D.blot({text:this.text,maxWidth:this.maxWidth}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width,this.h=this.canvas.canvas.height=this.textCanvas.height),this.reposition(),this.draw()}draw(){this.canvas.clear(),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,0,0,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.hyperlink&&(document.body.style.cursor="pointer"),this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.hyperlink&&(document.body.style.cursor="default"),this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn&&(this.pressed=!0,this.draw())}onMouseUp(e){this.mouseOn&&(this.pressed=!1,this.onPress&&this.onPress(),this.hyperlink&&this.hyperlink!=="#"&&this.hyperlink!=="javascript:void(0)"&&window.open(this.hyperlink),this.draw())}};var we=class extends bi.EventEmitter{constructor(e){super();a(this,"game");a(this,"elements",[]);a(this,"x",0);a(this,"y",0);a(this,"w");a(this,"h");a(this,"canvas");a(this,"mouseOnElement",!1);a(this,"boundRedraw");a(this,"boundOnMouseOnElement");a(this,"boundOnMouseOffElement");this.game=e,this.game.renderer?.images?.font&&D.loadImage(this.game.renderer.images.font),this.game.on("resize",this.onResize.bind(this)),this.game.on("mousemove",this.onMouseMove.bind(this)),this.game.on("mousedown",this.onMouseDown.bind(this)),this.game.on("mouseup",this.onMouseUp.bind(this)),this.game.on("keydown",this.onKeyDown.bind(this)),this.game.on("keyup",this.onKeyUp.bind(this)),this.elements=[],this.x=0,this.y=0,this.w=1,this.h=1,this.canvas=new C(1,1);let t=this;this.on("draw",function(n){n.drawStatic(t.canvas.canvas)}),this.boundRedraw=this.redraw.bind(this),this.boundOnMouseOnElement=this.onMouseOnElement.bind(this),this.boundOnMouseOffElement=this.onMouseOffElement.bind(this)}addButton(e){e.parent||(e.parent=this),e.ui=this;let t=new pe(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addPanel(e){e.parent||(e.parent=this),e.ui=this;let t=new be(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t}addInput(e){e.parent||(e.parent=this),e.ui=this;let t=new ve(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addLabel(e){e.parent||(e.parent=this),e.ui=this;let t=new ye(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}redraw(){this.canvas.clear();for(let e=0;e<this.elements.length;e++)this.elements[e].redraw(this.canvas)}onMouseMove(e){if(!(this.game.mouseButtons.length>0))for(let t=0;t<this.elements.length;t++){let n=this.elements[t];e.x>=n.x&&e.x<n.x+n.w&&e.y>=n.y&&e.y<n.y+n.h?n.emit("mouse-on",e):n.emit("mouse-off",e)}}onMouseDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-down",e)}onMouseUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-up",e)}onKeyDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-down",e)}onKeyUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-up",e)}onMouseOnElement(e){this.mouseOnElement=e,this.game.mouseOver=!1}onMouseOffElement(e){this.mouseOnElement=this.mouseOnElement===e?!1:this.mouseOnElement}onResize(e){this.w=e.width,this.h=e.height,this.canvas.canvas.width=this.w,this.canvas.canvas.height=this.h;for(let t=0;t<this.elements.length;t++)this.elements[t].reposition();this.redraw()}};var he={name:"d-zone",version:"0.1.0",description:"An ambient life simulation driven by the user activity within a Discord server",type:"module",main:"index.ts",exports:{".":"./index.ts"},dependencies:{express:"^5.1.0",inherits:"^2.0.4",pino:"^10.0.0",raf:"^3.4.1",ws:"^8.13.0"},devDependencies:{"@playwright/test":"^1.40.0","@types/express":"^4.17.23","@types/node":"^20.19.17","@types/pino":"^7.0.4","@types/ws":"^8.18.1","@vitest/ui":"^1.6.0","allure-commandline":"^2.24.1","allure-playwright":"^2.9.2","allure-vitest":"^2.15.1",concurrently:"^9.2.1",esbuild:"^0.25.10",events:"^3.3.0",jsdom:"^24.0.0",msw:"^2.0.0","ts-node":"^10.9.2",typescript:"^5.9.2",vitest:"^1.6.0"},scripts:{"build:dev":"node esbuild.config.mjs","build:prod":"NODE_ENV=production node esbuild.config.mjs",dev:'concurrently "npm run watch" "npm start"',prestart:"npm run build:dev",start:"node server.mjs","start:ts":"ts-node --esm index.ts",test:"vitest run && playwright test","test:unit":"vitest run","test:unit:watch":"vitest","test:unit:ui":"vitest --ui","test:e2e":"playwright test","test:e2e:headed":"playwright test --headed","test:e2e:debug":"playwright test --debug","test:ci":"npm run test -- --project=ci","test:report":"allure generate --clean && allure open","test:report:generate":"allure generate --clean","type-check":"tsc --noEmit",watch:"node esbuild.config.mjs --watch"},repository:{type:"git",url:"git+https://github.com/NNTin/d-zone.git"},keywords:["discord","Discord","isometric","canvas"],author:"Tin Nguyen",contributors:["Devin Spikowski (https://github.com/vegeta897)"],license:"ISC",bugs:{url:"https://github.com/NNTin/d-zone/issues"},homepage:"https://nntin.github.io/d-zone"};var yi,pn,g,ce,x;function bn(s){d.info("Initializing game with images",{imageCount:Object.keys(s).length,imageNames:Object.keys(s)}),g=new ei({step:1e3/60}),g.renderer=new si({game:g,images:s});let i=new Zt({id:"main",game:g,initialScale:2,backgroundColor:"#181213"});g.renderer.addCanvas(i),g.bindCanvas(i),g.ui=new we(g),vn(),yn(),g.renderer.canvases[0].onResize(),wn(),window.pause=function(){g.paused=!0},window.unpause=function(){g.paused=!1},window.game=g;let e=!1;g.on("render",()=>{e||(e=!0,d.initialDraw())}),d.gameInitialized({width:i.width,height:i.height,version:he.version})}function vi(s){d.info("Reinitializing Discord OAuth with new client ID",{newClientId:s});let i=x&&x.isLoggedIn(),e=x?x.getUser():null,t=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";x=new tt({clientId:s,redirectUri:t,scopes:["identify"]}),wi(),i&&e&&d.warn("Discord OAuth client ID updated - user may need to re-authenticate",{currentUser:e?.username}),d.info("Discord OAuth reinitialized successfully")}function wi(){let s=x.login;x.login=function(){let i=this.getAuthUrl();return d.debug("Discord OAuth URL generated",{authUrl:i}),d.discordLoginAttempt(),s.call(this)},x.on("login-success",function(i){d.discordLoginSuccess(i.username),localStorage.setItem("discord_user",JSON.stringify(i)),g.pendingServerJoin&&(ue(g.pendingServerJoin),delete g.pendingServerJoin),g.helpPanel&&(g.helpPanel.remove(),delete g.helpPanel,setTimeout(function(){g.helpButton&&g.helpButton.onPress&&g.helpButton.onPress()},100))}),x.on("login-error",function(i){d.discordLoginError(i),window.alert("Discord login failed: "+i)}),x.on("login-cancelled",function(){d.info("Discord login cancelled by user")}),x.on("logout",function(){d.discordLogout(),g.helpPanel&&(g.helpPanel.remove(),delete g.helpPanel,setTimeout(function(){g.helpButton&&g.helpButton.onPress&&g.helpButton.onPress()},100))})}function vn(){let s=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";d.debug("Discord OAuth initialization",{redirectUri:s,currentLocation:window.location.href,origin:window.location.origin,pathname:window.location.pathname}),fetch(s).then(function(i){d.debug("Discord callback page test",{status:i.status,accessible:i.ok}),i.ok?d.debug("\u2713 Discord callback page is accessible"):d.error("\u2717 Discord callback page not accessible",{status:i.status})}).catch(function(i){d.error("\u2717 Discord callback page test failed",{error:i.message})}),x=new tt({clientId:"506432803173433344",redirectUri:s,scopes:["identify"]}),wi()}function yn(){g.helpButton=g.ui.addButton({text:"?",bottom:3,right:3,w:18,h:18,onPress:function(){if(g.serverListPanel&&(g.serverListPanel.remove(),delete g.serverListPanel),g.helpPanel){g.helpPanel.remove(),delete g.helpPanel;return}g.helpPanel=g.ui.addPanel({left:"auto",top:"auto",w:200,h:130}),g.ui.addLabel({text:"D-Zone (fork) "+(yi||he.version),top:5,left:"auto",parent:g.helpPanel}),g.ui.addLabel({text:he.description,top:20,left:2,maxWidth:196,parent:g.helpPanel}),g.ui.addLabel({text:"This is a fork of D-Zone (originally by Vegeta897). It follows its own versioning and is not published on npm.",top:50,left:2,maxWidth:196,parent:g.helpPanel}),g.ui.addLabel({text:":icon-npm: View on npm",hyperlink:"https://www.npmjs.com/package/d-zone",top:90,left:8,parent:g.helpPanel}),g.ui.addLabel({text:"View original :icon-github:",hyperlink:"https://github.com/d-zone-org/d-zone",top:90,right:8,parent:g.helpPanel}),g.ui.addLabel({text:"View fork :icon-github:",hyperlink:"https://github.com/nntin/d-zone",top:110,right:8,parent:g.helpPanel});let s=x&&x.isLoggedIn(),i=x&&x.getUser();s&&i?(g.ui.addLabel({text:`Logged in as: ${i.username}`,top:130,left:2,parent:g.helpPanel}),g.ui.addButton({text:"Logout Discord",top:150,left:2,w:80,h:16,parent:g.helpPanel,onPress:function(){x.logout()}})):(g.ui.addButton({text:"Login Discord",top:130,left:2,w:80,h:16,parent:g.helpPanel,onPress:function(){x.login()}}),g.ui.addLabel({text:"Login required for private servers",top:150,left:2,maxWidth:196,parent:g.helpPanel})),g.helpPanel.resize(200,170)}})}function wn(){let s,i,e;function t(){s&&s.removeAllListeners&&s.removeAllListeners(),i&&i.removeAllListeners&&i.removeAllListeners(),e&&e.removeAllListeners&&e.removeAllListeners()}let n=[],r=y.getURLParameter("socketURL");r&&n.push({url:r,description:"URL parameter"});let o="wss://"+window.location.hostname+window.location.pathname;o=o.replace(/\/$/,"")+"/ws",n.push({url:o,description:"current hostname and pathname"}),n.push({url:"wss://hermes.nntin.xyz/dzone",description:"Hermes fallback server"});let h=0;function l(){if(h>=n.length){d.error("All websocket connection strategies failed",{totalStrategies:n.length,attemptedStrategies:n.map(u=>u.description)});return}let c=n[h];d.info("Attempting websocket connection",{strategyIndex:h+1,totalStrategies:n.length,description:c.description,url:c.url}),ce=new WebSocket(c.url),ce.addEventListener("message",async function(u){let m=JSON.parse(u.data);if(d.websocketMessageReceived(m),e&&e.beacon.ping(),m.type==="server-list"){g.servers=m.data,d.info("Received server list",{serverCount:g.servers?Object.keys(g.servers).length:0,servers:g.servers}),g.ui.addButton({text:"Server",top:3,right:3,onPress:function(){if(g.helpPanel&&(g.helpPanel.remove(),delete g.helpPanel),g.serverListPanel){g.serverListPanel.remove(),delete g.serverListPanel;return}let M=function(S){return function(){if(S.passworded&&(!x||!x.isLoggedIn())){g.pendingServerJoin=S,window.alert("This server requires Discord authentication. Please login with Discord first.");return}let E="?s="+S.id;window.location.protocol!=="file:"&&window.history.pushState({server:S.id},S.id,window.location.pathname+E),ue(S),g.serverListPanel.remove(),delete g.serverListPanel}};g.serverListPanel=g.ui.addPanel({left:"auto",top:"auto",w:146,h:28+21*(Object.keys(g.servers||{}).length-1)});let b=136,w=0,v;for(let S in g.servers){if(!g.servers||!g.servers.hasOwnProperty(S))continue;let E=g.servers[S],L=E.passworded?":icon-lock-small: ":"";v=g.ui.addButton({text:L+g.servers[S].name,left:5,top:5+w*21,w:136,h:18,parent:g.serverListPanel,onPress:M(E),disabled:g.server===E.id}),b=Math.max(b,v.textCanvas.width+2),w++}g.serverListPanel.resize(b+10,g.serverListPanel.h),g.serverListPanel.resizeChildren(b,v.h),g.serverListPanel.reposition()}});let p=xn(),f=g.servers?.[p.id];!f||!f.passworded||x&&x.isLoggedIn()?ue(p):g.pendingServerJoin=p}else if(m.type==="server-join"){let p=m.data.request.server;localStorage.setItem("dzone-default-server",JSON.stringify({id:p})),d.serverJoined(p,m.data.serverName),m.data.clientId&&x&&(d.info("Setting Discord OAuth client ID from server-join",{clientId:m.data.clientId}),vi(m.data.clientId)),t(),g.reset(),g.renderer.clear();let f=m.data.users;g.server=p,i=new J(g,Math.round(3.3*Math.sqrt(Object.keys(f).length))),await i.initializationPromise,i.generateWorld(),e=new fe(g,i),g.decorator=e,s=new ge(g,i);let M="?s="+m.data.request.server;window.location.protocol!=="file:"&&window.history.replaceState(m.data.request,p,window.location.pathname+M);let b=Object.keys(f).length;g.setMaxListeners(b+100),s.setMaxListeners(b+50),i&&i.setMaxListeners&&i.setMaxListeners(b+50),e&&e.setMaxListeners&&e.setMaxListeners(b+50);for(let v in f)f.hasOwnProperty(v)&&f[v].username&&s&&s.addActor(f[v]);let w=s?Object.keys(s.actors).length:0;d.info("Actors initialized",{totalUsers:b,createdActors:w,skippedUsers:b-w}),g.renderer.canvases[0].onResize()}else if(m.type==="presence")d.debug("Actor presence update",{uid:m.data.uid,presence:m.data.presence}),s&&s.updateActor(m.data);else if(m.type==="message")d.debug("Message received",{channel:m.data.channel,user:m.data.user?.username,messageLength:m.data.content?.length}),s.queueMessage(m.data);else if(m.type==="error")d.error("Server error received",{message:m.data.message}),window.alert(m.data.message),g.world||ue({id:"default"});else if(m.type==="update-clientid"&&(d.info("Received client ID update",{clientId:m.data.clientId}),m.data.clientId&&x&&(vi(m.data.clientId),g&&g.ui))){let p=g.ui.addPanel({left:"auto",top:50,w:250,h:60,backgroundColor:"#2c3e50"});g.ui.addLabel({text:"\u{1F504} Discord OAuth Updated",top:5,left:"auto",parent:p,color:"#ecf0f1"}),g.ui.addLabel({text:"Discord login configuration has been updated.",top:25,left:5,maxWidth:240,parent:p,color:"#bdc3c7"}),setTimeout(function(){p&&p.remove&&p.remove()},5e3)}}),ce.addEventListener("open",function(){d.websocketConnected(c.url)}),ce.addEventListener("close",function(){d.websocketDisconnected(`Strategy: ${c.description}`),t(),h===n.indexOf(c)&&(h++,setTimeout(l,1e3))}),ce.addEventListener("error",function(u){d.warn("Websocket connection error",{strategy:c.description,strategyIndex:h+1,totalStrategies:n.length,error:u}),h===n.indexOf(c)&&(h++,setTimeout(l,1e3))})}l()}window.onpopstate=function(s){let i={id:s.state?.server};ue(i)};function ue(s){let i={type:"connect",data:{server:s.id}},e=null;if(g.servers){for(let t in g.servers)if(g.servers.hasOwnProperty(t)&&g.servers[t].id===s.id){e=g.servers[t];break}}d.debug("Server lookup for connection",{requestedServerId:s.id,foundServerData:e?{id:e.id,passworded:e.passworded}:null,serverCount:g.servers?Object.keys(g.servers).length:0}),e&&e.passworded&&x&&x.isLoggedIn()?(i.data.discordToken=x.accessToken,i.data.discordUser=x.getUser(),d.info("Sending Discord OAuth data for passworded server",{tokenLength:x.accessToken?x.accessToken.length:0,hasUser:!!x.getUser(),serverId:s.id})):d.debug("Not sending Discord OAuth data",{serverFound:!!e,serverPassworded:e?e.passworded:"unknown",discordAuthExists:!!x,discordLoggedIn:x?x.isLoggedIn():!1}),d.info("Requesting to join server",{serverId:s.id,hasDiscordAuth:!!i.data.discordToken}),ce.send(JSON.stringify(i))}function xn(){let s={id:y.getURLParameter("s")};if(!s.id){let i=localStorage.getItem("dzone-default-server");i&&(s=JSON.parse(i))}return s||(s={id:"default"}),s}function Mn(){d.info("Starting D-Zone application",{version:he.version}),yi=he.version,pn=new ti(bn)}typeof window<"u"&&typeof document<"u"&&(Mn(),window.joinServer=ue);})();
//# sourceMappingURL=bundle.js.map
