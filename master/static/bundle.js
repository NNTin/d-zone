"use strict";(()=>{var wi=Object.create;var xe=Object.defineProperty;var xi=Object.getOwnPropertyDescriptor;var Mi=Object.getOwnPropertyNames;var Si=Object.getPrototypeOf,Oi=Object.prototype.hasOwnProperty;var ki=(n,i,e)=>i in n?xe(n,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[i]=e;var k=(n,i)=>()=>(n&&(i=n(n=0)),i);var Ae=(n,i)=>()=>(i||n((i={exports:{}}).exports,i),i.exports),U=(n,i)=>{for(var e in i)xe(n,e,{get:i[e],enumerable:!0})},Ei=(n,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of Mi(i))!Oi.call(n,s)&&s!==e&&xe(n,s,{get:()=>i[s],enumerable:!(t=xi(i,s))||t.enumerable});return n};var D=(n,i,e)=>(e=n!=null?wi(Si(n)):{},Ei(i||!n||!n.__esModule?xe(e,"default",{value:n,enumerable:!0}):e,n));var o=(n,i,e)=>ki(n,typeof i!="symbol"?i+"":i,e);var lt=Ae((Ms,ut)=>{"use strict";function Li(n){try{return JSON.stringify(n)}catch{return'"[Circular]"'}}ut.exports=Ci;function Ci(n,i,e){var t=e&&e.stringify||Li,s=1;if(typeof n=="object"&&n!==null){var r=i.length+s;if(r===1)return n;var a=new Array(r);a[0]=t(n);for(var h=1;h<r;h++)a[h]=t(i[h]);return a.join(" ")}if(typeof n!="string")return n;var l=i.length;if(l===0)return n;for(var c="",u=1-s,d=-1,p=n&&n.length||0,g=0;g<p;){if(n.charCodeAt(g)===37&&g+1<p){switch(d=d>-1?d:0,n.charCodeAt(g+1)){case 100:case 102:if(u>=l||i[u]==null)break;d<g&&(c+=n.slice(d,g)),c+=Number(i[u]),d=g+2,g++;break;case 105:if(u>=l||i[u]==null)break;d<g&&(c+=n.slice(d,g)),c+=Math.floor(Number(i[u])),d=g+2,g++;break;case 79:case 111:case 106:if(u>=l||i[u]===void 0)break;d<g&&(c+=n.slice(d,g));var M=typeof i[u];if(M==="string"){c+="'"+i[u]+"'",d=g+2,g++;break}if(M==="function"){c+=i[u].name||"<anonymous>",d=g+2,g++;break}c+=t(i[u]),d=g+2,g++;break;case 115:if(u>=l)break;d<g&&(c+=n.slice(d,g)),c+=String(i[u]),d=g+2,g++;break;case 37:d<g&&(c+=n.slice(d,g)),c+="%",d=g+2,g++,u--;break}++u}++g}return d===-1?n:(d<p&&(c+=n.slice(d)),c)}});var bt=Ae((Ss,Se)=>{"use strict";var dt=lt();Se.exports=R;var he=Ui().console||{},zi={mapHttpRequest:Me,mapHttpResponse:Me,wrapRequestSerializer:Re,wrapResponseSerializer:Re,wrapErrorSerializer:Re,req:Me,res:Me,err:ft,errWithCause:ft};function j(n,i){return n==="silent"?1/0:i.levels.values[n]}var We=Symbol("pino.logFuncs"),Ge=Symbol("pino.hierarchy"),Ti={error:"log",fatal:"error",warn:"error",info:"log",debug:"log",trace:"log"};function mt(n,i){let e={logger:i,parent:n[Ge]};i[Ge]=e}function Pi(n,i,e){let t={};i.forEach(s=>{t[s]=e[s]?e[s]:he[s]||he[Ti[s]||"log"]||Z}),n[We]=t}function Di(n,i){return Array.isArray(n)?n.filter(function(t){return t!=="!stdSerializers.err"}):n===!0?Object.keys(i):!1}function R(n){n=n||{},n.browser=n.browser||{};let i=n.browser.transmit;if(i&&typeof i.send!="function")throw Error("pino: transmit option must have a send function");let e=n.browser.write||he;n.browser.write&&(n.browser.asObject=!0);let t=n.serializers||{},s=Di(n.browser.serialize,t),r=n.browser.serialize;Array.isArray(n.browser.serialize)&&n.browser.serialize.indexOf("!stdSerializers.err")>-1&&(r=!1);let a=Object.keys(n.customLevels||{}),h=["error","fatal","warn","info","debug","trace"].concat(a);typeof e=="function"&&h.forEach(function(v){e[v]=e}),(n.enabled===!1||n.browser.disabled)&&(n.level="silent");let l=n.level||"info",c=Object.create(e);c.log||(c.log=Z),Pi(c,h,e),mt({},c),Object.defineProperty(c,"levelVal",{get:d}),Object.defineProperty(c,"level",{get:p,set:g});let u={transmit:i,serialize:s,asObject:n.browser.asObject,asObjectBindingsOnly:n.browser.asObjectBindingsOnly,formatters:n.browser.formatters,levels:h,timestamp:Wi(n),messageKey:n.messageKey||"msg",onChild:n.onChild||Z};c.levels=Ii(n),c.level=l,c.isLevelEnabled=function(v){return this.levels.values[v]?this.levels.values[v]>=this.levels.values[this.level]:!1},c.setMaxListeners=c.getMaxListeners=c.emit=c.addListener=c.on=c.prependListener=c.once=c.prependOnceListener=c.removeListener=c.removeAllListeners=c.listeners=c.listenerCount=c.eventNames=c.write=c.flush=Z,c.serializers=t,c._serialize=s,c._stdErrSerialize=r,c.child=function(...v){return M.call(this,u,...v)},i&&(c._logEvent=je());function d(){return j(this.level,this)}function p(){return this._level}function g(v){if(v!=="silent"&&!this.levels.values[v])throw Error("unknown level "+v);this._level=v,X(this,u,c,"error"),X(this,u,c,"fatal"),X(this,u,c,"warn"),X(this,u,c,"info"),X(this,u,c,"debug"),X(this,u,c,"trace"),a.forEach(S=>{X(this,u,c,S)})}function M(v,S,w){if(!S)throw new Error("missing bindings for child Pino");w=w||{},s&&S.serializers&&(w.serializers=S.serializers);let z=w.serializers;if(s&&z){var A=Object.assign({},t,z),ye=n.browser.serialize===!0?Object.keys(A):s;delete S.serializers,_e([S],ye,A,this._stdErrSerialize)}function ct(we){this._childLevel=(we._childLevel|0)+1,this.bindings=S,A&&(this.serializers=A,this._serialize=ye),i&&(this._logEvent=je([].concat(we._logEvent.bindings,S)))}ct.prototype=this;let ae=new ct(this);return mt(this,ae),ae.child=function(...we){return M.call(this,v,...we)},ae.level=w.level||this.level,v.onChild(ae),ae}return c}function Ii(n){let i=n.customLevels||{},e=Object.assign({},R.levels.values,i),t=Object.assign({},R.levels.labels,Bi(i));return{values:e,labels:t}}function Bi(n){let i={};return Object.keys(n).forEach(function(e){i[n[e]]=e}),i}R.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}};R.stdSerializers=zi;R.stdTimeFunctions=Object.assign({},{nullTime:gt,epochTime:pt,unixTime:_i,isoTime:Fi});function Ni(n){let i=[];n.bindings&&i.push(n.bindings);let e=n[Ge];for(;e.parent;)e=e.parent,e.logger.bindings&&i.push(e.logger.bindings);return i.reverse()}function X(n,i,e,t){if(Object.defineProperty(n,t,{value:j(n.level,e)>j(t,e)?Z:e[We][t],writable:!0,enumerable:!0,configurable:!0}),n[t]===Z){if(!i.transmit)return;let r=i.transmit.level||n.level,a=j(r,e);if(j(t,e)<a)return}n[t]=Ri(n,i,e,t);let s=Ni(n);s.length!==0&&(n[t]=Ai(s,n[t]))}function Ai(n,i){return function(){return i.apply(this,[...n,...arguments])}}function Ri(n,i,e,t){return(function(s){return function(){let a=i.timestamp(),h=new Array(arguments.length),l=Object.getPrototypeOf&&Object.getPrototypeOf(this)===he?he:this;for(var c=0;c<h.length;c++)h[c]=arguments[c];var u=!1;if(i.serialize&&(_e(h,this._serialize,this.serializers,this._stdErrSerialize),u=!0),i.asObject||i.formatters?s.call(l,...Gi(this,t,h,a,i)):s.apply(l,h),i.transmit){let d=i.transmit.level||n._level,p=j(d,e),g=j(t,e);if(g<p)return;ji(this,{ts:a,methodLevel:t,methodValue:g,transmitLevel:d,transmitValue:e.levels.values[i.transmit.level||n._level],send:i.transmit.send,val:j(n._level,e)},h,u)}}})(n[We][t])}function Gi(n,i,e,t,s){let{level:r,log:a=d=>d}=s.formatters||{},h=e.slice(),l=h[0],c={},u=(n._childLevel|0)+1;if(u<1&&(u=1),t&&(c.time=t),r){let d=r(i,n.levels.values[i]);Object.assign(c,d)}else c.level=n.levels.values[i];if(s.asObjectBindingsOnly){if(l!==null&&typeof l=="object")for(;u--&&typeof h[0]=="object";)Object.assign(c,h.shift());return[a(c),...h]}else{if(l!==null&&typeof l=="object"){for(;u--&&typeof h[0]=="object";)Object.assign(c,h.shift());l=h.length?dt(h.shift(),h):void 0}else typeof l=="string"&&(l=dt(h.shift(),h));return l!==void 0&&(c[s.messageKey]=l),[a(c)]}}function _e(n,i,e,t){for(let s in n)if(t&&n[s]instanceof Error)n[s]=R.stdSerializers.err(n[s]);else if(typeof n[s]=="object"&&!Array.isArray(n[s])&&i)for(let r in n[s])i.indexOf(r)>-1&&r in e&&(n[s][r]=e[r](n[s][r]))}function ji(n,i,e,t=!1){let s=i.send,r=i.ts,a=i.methodLevel,h=i.methodValue,l=i.val,c=n._logEvent.bindings;t||_e(e,n._serialize||Object.keys(n.serializers),n.serializers,n._stdErrSerialize===void 0?!0:n._stdErrSerialize),n._logEvent.ts=r,n._logEvent.messages=e.filter(function(u){return c.indexOf(u)===-1}),n._logEvent.level.label=a,n._logEvent.level.value=h,s(a,n._logEvent,l),n._logEvent=je(c)}function je(n){return{ts:0,messages:[],bindings:n||[],level:{label:"",value:0}}}function ft(n){let i={type:n.constructor.name,msg:n.message,stack:n.stack};for(let e in n)i[e]===void 0&&(i[e]=n[e]);return i}function Wi(n){return typeof n.timestamp=="function"?n.timestamp:n.timestamp===!1?gt:pt}function Me(){return{}}function Re(n){return n}function Z(){}function gt(){return!1}function pt(){return Date.now()}function _i(){return Math.round(Date.now()/1e3)}function Fi(){return new Date(Date.now()).toISOString()}function Ui(){function n(i){return typeof i<"u"&&i}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return n(self)||n(window)||n(this)||{}}}Se.exports.default=R;Se.exports.pino=R});var vt,yt,Xi,Hi,$i,Fe,m,L=k(()=>{"use strict";vt=D(bt(),1),yt=typeof process<"u"&&!0,Xi=typeof process<"u"&&process.env.CI==="true",Hi=typeof window<"u"&&window.location.search.includes("e2e-test=true"),$i=(0,vt.default)({level:yt?"warn":"debug",browser:{serialize:!0,transmit:{level:"debug",send:function(n,i){typeof window<"u"&&(Xi||Hi)&&console.log(`[GAME_LOG] ${JSON.stringify(i)}`)}}},formatters:{level:n=>({level:n})}}),Fe=class{constructor(i){this.baseLogger=i;o(this,"enabled",!yt)}setEnabled(i){this.enabled=i}isEnabled(){return this.enabled}gameInitialized(i){this.enabled&&this.baseLogger.info({category:"game",event:"initialized",timestamp:Date.now(),...i},"Game initialized")}initialDraw(){this.enabled&&this.baseLogger.info({category:"game",event:"initial_draw",timestamp:Date.now()},"Initial draw complete")}gameReset(){this.enabled&&this.baseLogger.info({category:"game",event:"reset",timestamp:Date.now()},"Game reset")}worldGenerated(i){this.enabled&&this.baseLogger.info({category:"world",event:"generated",timestamp:Date.now(),...i},`World generated: ${i.totalTiles} tiles, ${i.spawnablePositions} spawn positions`)}worldSpawnAnalysis(i){this.enabled&&this.baseLogger.info({category:"world",event:"spawn_analysis",timestamp:Date.now(),...i},`Spawn analysis: ${i.validSpawnPositions} valid, ${i.invalidSpawnPositions} invalid positions`)}actorSpawned(i){this.enabled&&this.baseLogger.info({category:"actor",event:"spawned",timestamp:Date.now(),...i},`Actor spawned: ${i.username} at (${i.x}, ${i.y})`)}actorMoved(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"moved",timestamp:Date.now(),...i},`Actor moved: ${i.username||i.uid} to (${i.x}, ${i.y})`)}actorRemoved(i){this.enabled&&this.baseLogger.info({category:"actor",event:"removed",timestamp:Date.now(),...i},`Actor removed: ${i.username||i.uid}`)}actorUpdated(i){this.enabled&&this.baseLogger.debug({category:"actor",event:"updated",timestamp:Date.now(),...i},`Actor updated: ${i.username||i.uid}`)}nametagShow(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"show",timestamp:Date.now(),actorUid:i,username:e},`Nametag shown: ${e||i}`)}nametagHide(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"hide",timestamp:Date.now(),actorUid:i,username:e},`Nametag hidden: ${e||i}`)}nametagResolved(i,e){this.enabled&&this.baseLogger.debug({category:"nametag",event:"resolved",timestamp:Date.now(),visibleActorUid:i,hiddenActorUids:e,totalCount:e.length+1},`Nametag conflict resolved: showing ${i}, hiding ${e.length} others`)}websocketConnected(i){this.enabled&&this.baseLogger.info({category:"websocket",event:"connected",timestamp:Date.now(),url:i},`WebSocket connected: ${i||"unknown"}`)}websocketDisconnected(i){this.enabled&&this.baseLogger.warn({category:"websocket",event:"disconnected",timestamp:Date.now(),reason:i},`WebSocket disconnected: ${i||"unknown"}`)}websocketMessageReceived(i){this.enabled&&this.baseLogger.debug({category:"websocket",event:"message_received",timestamp:Date.now(),messageType:i.type,dataSize:JSON.stringify(i).length},`WebSocket message: ${i.type}`)}websocketMessageSent(i){this.enabled&&this.baseLogger.debug({category:"websocket",event:"message_sent",timestamp:Date.now(),messageType:i.type,dataSize:JSON.stringify(i).length},`WebSocket sent: ${i.type}`)}serverJoined(i,e){this.enabled&&this.baseLogger.info({category:"websocket",event:"server_joined",timestamp:Date.now(),serverId:i,serverName:e},`Joined server: ${e||i}`)}uiPanelOpened(i){this.enabled&&this.baseLogger.debug({category:"ui",event:"panel_opened",timestamp:Date.now(),panelType:i},`UI panel opened: ${i}`)}uiPanelClosed(i){this.enabled&&this.baseLogger.debug({category:"ui",event:"panel_closed",timestamp:Date.now(),panelType:i},`UI panel closed: ${i}`)}buttonClicked(i,e){this.enabled&&this.baseLogger.debug({category:"ui",event:"button_clicked",timestamp:Date.now(),buttonType:i,buttonText:e},`Button clicked: ${i} (${e||"no text"})`)}canvasHover(i,e,t){this.enabled&&this.baseLogger.debug({category:"canvas",event:"hover",timestamp:Date.now(),x:i,y:e,actorUid:t},`Canvas hover: (${i}, ${e}) ${t?`on actor ${t}`:""}`)}canvasClick(i,e,t){this.enabled&&this.baseLogger.debug({category:"canvas",event:"click",timestamp:Date.now(),x:i,y:e,actorUid:t},`Canvas click: (${i}, ${e}) ${t?`on actor ${t}`:""}`)}canvasResize(i,e){this.enabled&&this.baseLogger.debug({category:"canvas",event:"resize",timestamp:Date.now(),width:i,height:e},`Canvas resized: ${i}x${e}`)}discordLoginAttempt(){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_login_attempt",timestamp:Date.now()},"Discord login attempt started")}discordLoginSuccess(i){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_login_success",timestamp:Date.now(),username:i},`Discord login successful: ${i}`)}discordLoginError(i){this.enabled&&this.baseLogger.error({category:"auth",event:"discord_login_error",timestamp:Date.now(),error:i},`Discord login failed: ${i}`)}discordLogout(){this.enabled&&this.baseLogger.info({category:"auth",event:"discord_logout",timestamp:Date.now()},"Discord logout")}performanceMetric(i,e,t="ms"){this.enabled&&this.baseLogger.debug({category:"performance",event:"metric",timestamp:Date.now(),metric:i,value:e,unit:t},`Performance: ${i} = ${e}${t}`)}frameRate(i){this.enabled&&this.baseLogger.debug({category:"performance",event:"frame_rate",timestamp:Date.now(),fps:i},`FPS: ${i}`)}info(i,e){this.enabled&&this.baseLogger.info(e||{},i)}debug(i,e){this.enabled&&this.baseLogger.debug(e||{},i)}warn(i,e){this.enabled&&this.baseLogger.warn(e||{},i)}error(i,e){this.enabled&&this.baseLogger.error(e||{},i)}},m=new Fe($i)});var I=Ae((Es,Ue)=>{"use strict";var J=typeof Reflect=="object"?Reflect:null,wt=J&&typeof J.apply=="function"?J.apply:function(i,e,t){return Function.prototype.apply.call(i,e,t)},Oe;J&&typeof J.ownKeys=="function"?Oe=J.ownKeys:Object.getOwnPropertySymbols?Oe=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:Oe=function(i){return Object.getOwnPropertyNames(i)};function Yi(n){console&&console.warn&&console.warn(n)}var Mt=Number.isNaN||function(i){return i!==i};function x(){x.init.call(this)}Ue.exports=x;Ue.exports.once=qi;x.EventEmitter=x;x.prototype._events=void 0;x.prototype._eventsCount=0;x.prototype._maxListeners=void 0;var xt=10;function ke(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(x,"defaultMaxListeners",{enumerable:!0,get:function(){return xt},set:function(n){if(typeof n!="number"||n<0||Mt(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");xt=n}});x.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};x.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||Mt(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function St(n){return n._maxListeners===void 0?x.defaultMaxListeners:n._maxListeners}x.prototype.getMaxListeners=function(){return St(this)};x.prototype.emit=function(i){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var s=i==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var h=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw h.context=a,h}var l=r[i];if(l===void 0)return!1;if(typeof l=="function")wt(l,this,e);else for(var c=l.length,u=Ct(l,c),t=0;t<c;++t)wt(u[t],this,e);return!0};function Ot(n,i,e,t){var s,r,a;if(ke(e),r=n._events,r===void 0?(r=n._events=Object.create(null),n._eventsCount=0):(r.newListener!==void 0&&(n.emit("newListener",i,e.listener?e.listener:e),r=n._events),a=r[i]),a===void 0)a=r[i]=e,++n._eventsCount;else if(typeof a=="function"?a=r[i]=t?[e,a]:[a,e]:t?a.unshift(e):a.push(e),s=St(n),s>0&&a.length>s&&!a.warned){a.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(i)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=n,h.type=i,h.count=a.length,Yi(h)}return n}x.prototype.addListener=function(i,e){return Ot(this,i,e,!1)};x.prototype.on=x.prototype.addListener;x.prototype.prependListener=function(i,e){return Ot(this,i,e,!0)};function Ki(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function kt(n,i,e){var t={fired:!1,wrapFn:void 0,target:n,type:i,listener:e},s=Ki.bind(t);return s.listener=e,t.wrapFn=s,s}x.prototype.once=function(i,e){return ke(e),this.on(i,kt(this,i,e)),this};x.prototype.prependOnceListener=function(i,e){return ke(e),this.prependListener(i,kt(this,i,e)),this};x.prototype.removeListener=function(i,e){var t,s,r,a,h;if(ke(e),s=this._events,s===void 0)return this;if(t=s[i],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete s[i],s.removeListener&&this.emit("removeListener",i,t.listener||e));else if(typeof t!="function"){for(r=-1,a=t.length-1;a>=0;a--)if(t[a]===e||t[a].listener===e){h=t[a].listener,r=a;break}if(r<0)return this;r===0?t.shift():Zi(t,r),t.length===1&&(s[i]=t[0]),s.removeListener!==void 0&&this.emit("removeListener",i,h||e)}return this};x.prototype.off=x.prototype.removeListener;x.prototype.removeAllListeners=function(i){var e,t,s;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[i]),this;if(arguments.length===0){var r=Object.keys(t),a;for(s=0;s<r.length;++s)a=r[s],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[i],typeof e=="function")this.removeListener(i,e);else if(e!==void 0)for(s=e.length-1;s>=0;s--)this.removeListener(i,e[s]);return this};function Et(n,i,e){var t=n._events;if(t===void 0)return[];var s=t[i];return s===void 0?[]:typeof s=="function"?e?[s.listener||s]:[s]:e?Ji(s):Ct(s,s.length)}x.prototype.listeners=function(i){return Et(this,i,!0)};x.prototype.rawListeners=function(i){return Et(this,i,!1)};x.listenerCount=function(n,i){return typeof n.listenerCount=="function"?n.listenerCount(i):Lt.call(n,i)};x.prototype.listenerCount=Lt;function Lt(n){var i=this._events;if(i!==void 0){var e=i[n];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}x.prototype.eventNames=function(){return this._eventsCount>0?Oe(this._events):[]};function Ct(n,i){for(var e=new Array(i),t=0;t<i;++t)e[t]=n[t];return e}function Zi(n,i){for(;i+1<n.length;i++)n[i]=n[i+1];n.pop()}function Ji(n){for(var i=new Array(n.length),e=0;e<i.length;++e)i[e]=n[e].listener||n[e];return i}function qi(n,i){return new Promise(function(e,t){function s(a){n.removeListener(i,r),t(a)}function r(){typeof n.removeListener=="function"&&n.removeListener("error",s),e([].slice.call(arguments))}zt(n,i,r,{once:!0}),i!=="error"&&Vi(n,s,{once:!0})})}function Vi(n,i,e){typeof n.on=="function"&&zt(n,"error",i,e)}function zt(n,i,e,t){if(typeof n.on=="function")t.once?n.once(i,e):n.on(i,e);else if(typeof n.addEventListener=="function")n.addEventListener(i,function s(r){t.once&&n.removeEventListener(i,s),e(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}});var b,H,C=k(()=>{"use strict";b={randomIntRange(n,i){return Math.floor(Math.random()*(+i-+n+1))+ +n},pickInArray(n){return n[this.randomIntRange(0,n.length-1)]},pickInObject(n){return this.pickInArray(Object.keys(n))},findAndRemove(n,i){for(let e=0;e<i.length;e++)i[e]===n&&(i.splice(e,1),e--)},right(n,i){return n.substring(n.length-i,n.length)},clamp(n,i,e){return Math.min(e,Math.max(i,n))},clampWrap(n,i,e){let t=(n-i)%(e+1-i);return t>=0?i+t:e+1+t},fractionalArrayIndex(n,i){let e=Math.floor(i),t=n[e];if(e===i)return t;let s=n[Math.ceil(i)],r=i-Math.floor(i);return t+(s-t)*r},getURLParameter(n){return decodeURIComponent((new RegExp("[?|&]"+n+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},abbreviate(n,i){let e=n.split(" "),t=/[a-z0-9]/i,s="";for(let r=0;r<e.length;r++)for(let a=0;a<e[r].length;a++)if(t.test(e[r][a])){s+=e[r][a];break}if(s.trim()===""&&(s="1"),i&&i.indexOf(s)>=0){let r=0;s+=r;do r++,s=s.substring(0,s.length-1)+r;while(i.indexOf(s)>=0)}return s},alphabet:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],vowels:["a","e","i","o","u"],consonants:["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],hex:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"]},H=b});var Xe,O,q=k(()=>{"use strict";C();Xe=[],O={generateClosestGrids:function(n){for(let i=n*-1;i<=n;i++)for(let e=n*-1;e<=n;e++)Xe.push([i,e]);Xe.sort(function(i,e){return Math.abs(i[0])+Math.abs(i[1])-(Math.abs(e[0])+Math.abs(e[1]))})},closestGrids:Xe,DIRECTIONS:{north:{x:0,y:-1},east:{x:1,y:0},south:{x:0,y:1},west:{x:-1,y:0}},randomDirection:function(){return this.DIRECTIONS[b.pickInObject(this.DIRECTIONS)]},getNeighbors:function(n){let i=+n.split(":")[0],e=+n.split(":")[1];return{n:i+":"+(e-1),e:i+1+":"+e,s:i+":"+(e+1),w:i-1+":"+e}},get8Neighbors:function(n){let i=+n.split(":")[0],e=+n.split(":")[1];return{n:i+":"+(e-1),e:i+1+":"+e,s:i+":"+(e+1),w:i-1+":"+e,nw:i-1+":"+(e-1),ne:i+1+":"+(e-1),sw:i-1+":"+(e+1),se:i+1+":"+(e+1)}},getDistance:function(n,i){return Math.abs(n.x-i.x)+Math.abs(n.y-i.y)},intervalOverlaps:function(n,i,e,t){return n>=e&&n<t||e>=n&&e<i},buildNoiseMap:function(n,i){let e=[];for(let t=0;t<n;t++){e.push([]);for(let s=0;s<i;s++)e[t].push(Math.random())}return e},getNoiseMapPoint:function(n,i,e){let t=Math.floor(i),s=n[t];if(t==i)return b.fractionalArrayIndex(s,e);let r=Math.ceil(i),a=n[r],h=Math.floor(e);if(h==e)return b.fractionalArrayIndex([s[h],a[h]],i-t);let l=b.fractionalArrayIndex(s,e),c=b.fractionalArrayIndex(a,e);return b.fractionalArrayIndex([l,c],i-t)}}});var Tt,$,He=k(()=>{"use strict";Tt=D(I(),1);C();L();$=class extends Tt.EventEmitter{constructor(){super();o(this,"sprite",{});o(this,"game");o(this,"position");o(this,"zDepth");o(this,"invisible");o(this,"exists");this.sprite={}}addToGame(e){this.game=e,this.game.entities.push(this),this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(this.game.world.addToWorld(this),this.invisible||this.game.renderer.addToZBuffer(this.sprite,this.zDepth)):this.game.renderer.overlay.push(this.sprite),this.exists=!0}remove(){this.exists=!1,this.position&&typeof this.position.x=="number"&&typeof this.position.y=="number"&&typeof this.position.z=="number"?(!this.invisible&&this.game&&this.game.renderer.removeFromZBuffer(this.sprite,this.zDepth),this.game&&this.game.world.removeFromWorld(this)):this.game&&b.findAndRemove(this,this.game.renderer.overlay),this.game&&b.findAndRemove(this,this.game.entities)}tickDelay(e,t){this.game&&this.game.schedule.push({type:"once",tick:this.game.ticks+t,cb:e,entity:this})}tickRepeat(e,t,s){if(this.game){if(!isFinite(t)||t<=0){m.error("Entity tickRepeat: Invalid ticks parameter",{ticks:t,entity:this.constructor.name,isFinite:isFinite(t),isPositive:t>0});return}this.game.schedule.push({type:"repeat",start:this.game.ticks,count:t,cb:e,afterCB:s,entity:this})}}removeFromSchedule(e){if(this.game){for(let t=0;t<this.game.schedule.length;t++)if(this.game.schedule[t].entity===this&&this.game.schedule[t].cb===e){this.game.schedule[t].type="deleted";break}}}}});function B(n){return!isNaN(parseFloat(n))&&isFinite(n)}var $e,E,W=k(()=>{"use strict";L();$e=class{constructor(i,e){o(this,"canvas");o(this,"context");(!B(i)||!B(e))&&m.error("BetterCanvas: Invalid canvas size",{width:i,height:e}),this.canvas=document.createElement("canvas"),this.canvas.width=i,this.canvas.height=e;let t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get 2D context from canvas");this.context=t}drawImage(i,e,t,s,r,a,h,l,c,u){(!i||!(e>=0)||!(t>=0)||!(s>=0)||!(r>=0)||!B(a)||!B(h)||!(l>=0)||!(c>=0))&&(m.error("BetterCanvas drawImage: Invalid parameters",{hasImg:!!i,sx:e,sy:t,sw:s,sh:r,dx:a,dy:h,dw:l,dh:c}),window.pause&&window.pause()),u!==void 0&&(this.context.save(),this.context.globalAlpha=u),this.context.drawImage(i,e,t,s,r,a,h,l,c),u!==void 0&&this.context.restore()}fill(i){this.context.fillStyle=i,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}fillRect(i,e,t,s,r){(!B(e)||!B(t)||!B(s)||!B(r))&&(m.error("BetterCanvas fillRect: Invalid parameters",{color:i,x:e,y:t,w:s,h:r}),window.pause&&window.pause()),this.context.fillStyle=i,this.context.fillRect(Math.round(e),Math.round(t),Math.round(s),Math.round(r))}clearRect(i,e,t,s){(!B(i)||!B(e)||!B(t)||!B(s))&&(m.error("BetterCanvas clearRect: Invalid parameters",{x:i,y:e,w:t,h:s}),window.pause&&window.pause()),this.context.clearRect(Math.round(i),Math.round(e),Math.round(t),Math.round(s))}},E=$e});var Ye,G,V,Qi,Pt,T,Q=k(()=>{"use strict";W();Ye={upper:{y:0,height:8,xSpacing:1,chars:[["A",5],["B",5],["C",5],["D",5],["E",4],["F",4],["G",5],["H",5],["I",3],["J",5],["K",5],["L",4],["M",5],["N",5],["O",5],["P",5],["Q",5],["R",5],["S",5],["T",5],["U",5],["V",5],["W",5],["X",5],["Y",5],["Z",5]]},lower:{y:8,height:11,xSpacing:1,chars:[["a",5],["b",4],["c",4],["d",4],["e",4],["f",4],["g",4],["h",4],["i",1],["j",2],["k",4],["l",1],["m",5],["n",4],["o",4],["p",4],["q",4],["r",4],["s",4],["t",4],["u",4],["v",5],["w",5],["x",4],["y",4],["z",4],[" ",4]]},numsAndSymbols:{y:19,xSpacing:1,height:8,chars:[["0",4],["1",3],["2",4],["3",4],["4",4],["5",4],["6",4],["7",4],["8",4],["9",4],["`",2],["~",6],["!",1],["@",7],["#",7],["$",4],["%",5],["^",5],["&",6],["*",3],["(",2],[")",2],["_",5],["=",5],["-",5],["+",5],["|",1],[",",2],[".",1],["<",5],[">",5],["?",4],["/",3],["\\",3],[";",1],[":",1],["'",1],['"',3],["[",2],["]",2],["{",3],["}",3]]},icons:{count:4,y:27,height:12,chars:[[":icon-npm:",12],[":icon-github:",12],[":icon-lock:",12],[":icon-lock-small:",12]]},accented1:{y:39,xSpacing:1,height:13,oy:-2,chars:[["\xE1",5],["\xC1",5],["\xE0",5],["\xC0",5],["\xE2",5],["\xC2",5],["\xE4",5],["\xC4",5],["\xE3",5],["\xC3",5],["\xE5",5],["\xC5",5],["\xE6",7],["\xC6",7],["\xE7",4],["\xC7",5],["\xE9",4],["\xC9",4],["\xE8",4],["\xC8",4],["\xEA",4],["\xCA",4],["\xEB",4],["\xCB",4],["\xED",2],["\xCD",3],["\xEC",2],["\xCC",3],["\xEE",3],["\xCE",3],["\xEF",3],["\xCF",3]]},accented2:{y:52,xSpacing:1,height:10,oy:-2,chars:[["\xF1",4],["\xD1",5],["\xF3",4],["\xD3",5],["\xF2",4],["\xD2",5],["\xF4",4],["\xD4",5],["\xF6",4],["\xD6",5],["\xF5",4],["\xD5",5],["\xF8",4],["\xD8",5],["\u0153",7],["\u0152",8],["\xDF",5],["\xFA",4],["\xDA",5],["\xF9",4],["\xD9",5],["\xFB",4],["\xDB",5],["\xFC",4],["\xDC",5]]}},G={};for(let n in Ye){if(!Ye.hasOwnProperty(n))continue;let i=Ye[n],e=0;for(let t=0;t<i.chars.length;t++){let s=i.chars[t][0],r=i.chars[t][1]+(i.xSpacing||0);G[s]={x:e,y:i.y,w:r,h:i.height,char:s,oy:i.oy},e+=r}}V={x:4,y:3},Qi=1,T={loadImage:function(n){Pt=n},blot:function(n){let i=n.x||0,e=n.y||0,t=n.metrics||this.calculateMetrics(n),s=n.lineStart?n.lineStart:0,r=n.lineCount?Math.min(t.lines.length,n.lineCount):t.lines.length,a=n.canvas||new E(V.x*2+i+t.w-1,V.y*2+e+r*10);n.bg&&a.fill(n.bg);let h=0;for(let l=s;l<Math.min(t.lines.length,s+r);l++){let c=t.lines[l].chars.length;n.maxChars&&(c=Math.min(c,n.maxChars-h));for(let u=0;u<c;u++){let d=t.lines[l].chars[u];d.char.char!=" "&&a.drawImage(Pt,d.char.x,d.char.y,d.w,d.char.h,V.x+i+d.x,V.y+e+(l-s)*10+(d.oy||0)+Qi,d.w,d.char.h)}h+=t.lines[l].chars.length}return a.canvas},transition:function(n){let i=n.metrics||(n.text?this.calculateMetrics(n):{lines:[],text:"",w:0}),e=n.canvas||new E(i.w+V.x*2,(n.lineCount||i.lines.length)*10+V.y*2),t=Math.max(2,Math.max(0,n.progress-.25)/.75*e.canvas.width),s=Math.min(1,n.progress*4)*e.canvas.height*-1;return e.fillRect(n.bg,(e.canvas.width-t)/2,e.canvas.height,t,s),e.canvas},calculateMetrics:function(n){let i=n.text,e=[],t=i.split(" "),s=G[" "],r=0,a=[],h=0;for(let l=0;l<t.length;l++){let c=t[l];if(c=="")continue;let u=0,d=[];if(a.length>0&&(d.push({x:r,char:s,w:s.w}),u+=s.w),c.length>1&&G[c])d.push({x:r+u,char:G[c],w:G[c].w,oy:-2}),u+=G[c].w;else for(let p=0;p<c.length;p++){let g=G[c[p]]||s;d.push({x:r+u,char:g,w:g.w,oy:g.oy}),u+=g.w}if(n.maxWidth&&r+u>n.maxWidth){if(u>n.maxWidth){r>0&&(e.push({w:r,chars:a}),h=Math.max(r,h),r=0,a=[]),d=[],u=0;for(let p=0;p<c.length;p++){let g=G[c[p]]||s;if(r+u+g.w<n.maxWidth)d.push({x:r+u,char:g,w:g.w,oy:g.oy}),u+=g.w;else{let M=r+u+g.w-n.maxWidth;d.push({x:r+u,char:g,w:g.w-M,oy:g.oy}),u+=g.w-M;break}}r+=u,a=a.concat(d)}else l--;e.push({w:r,chars:a}),h=Math.max(r,h),r=0,a=[]}else r+=u,a=a.concat(d),l==t.length-1&&(e.push({w:r,chars:a}),h=Math.max(r,h))}return{lines:e,text:i,w:h}},fontMap:G}});function rs(n){let i=1;for(let e=0;e<Ee.length;e++)if(n.length>=Ee[e][0])i=Ee[e][1];else if(n.length<Ee[e][0])break;return i}var es,ee,Ee,ts,is,ss,ns,Ke,te,Dt=k(()=>{"use strict";L();He();Q();es=96,ee=4,Ee=[[0,3],[75,2],[150,1]],ts=5,is=60,ss=10,ns=8,Ke="rgba(0, 0, 0, 0.7)";te=class extends ${constructor(e,t,s){super();o(this,"parent");o(this,"text");o(this,"screen");o(this,"sprite");o(this,"canvas");o(this,"textMetrics");this.parent=e,this.text=t,this.screen={x:0,y:0},this.sprite={keepOnScreen:!0,screen:this.screen,parent:this.parent,stay:s,metrics:{x:0,y:0,w:0,h:0}}}updateScreen(){if(!this.canvas)return;if(!this.parent||!this.parent.preciseScreen){m.warn("TextBox updateScreen: Parent or preciseScreen missing",{hasParent:!!this.parent,hasPreciseScreen:this.parent&&!!this.parent.preciseScreen,textboxText:this.text}),this.screen.x=0,this.screen.y=0,this.sprite&&(this.sprite.screen=this.screen,this.sprite.hidden=!0),this.remove();return}let e=isFinite(this.parent.preciseScreen.x)?this.parent.preciseScreen.x:0,t=isFinite(this.parent.preciseScreen.y)?this.parent.preciseScreen.y:0;(e!==this.parent.preciseScreen.x||t!==this.parent.preciseScreen.y)&&m.warn("TextBox updateScreen: NaN detected in parent preciseScreen",{originalX:this.parent.preciseScreen.x,originalY:this.parent.preciseScreen.y,fallbackX:e,fallbackY:t,parentType:this.parent.constructor?.name||"unknown"}),this.screen.x=e-this.canvas.width/2+this.parent.pixelSize.x,this.screen.y=t-this.canvas.height+2,this.sprite&&(this.sprite.screen=this.screen)}updateSprite(){this.sprite.image=this.canvas,this.sprite.image&&(this.sprite.metrics.w=this.sprite.image.width,this.sprite.metrics.h=this.sprite.image.height)}blotText(e){e||(e={}),e.bg=e.bg||Ke,e.text=e.text||this.text,e.text&&(this.canvas=T.blot(e),this.updateScreen(),this.updateSprite())}scrollMessage(e){let t=this;function s(){t.remove(),e()}if(!this.parent||!this.parent.preciseScreen){m.warn("TextBox scrollMessage: Parent invalid at start"),s();return}if(this.textMetrics=T.calculateMetrics({text:this.text,maxWidth:es}),this.text.trim()===""||this.textMetrics.lines.length===0||this.textMetrics.lines[0].chars.length===0){s();return}let r=rs(this.text),a=0,h=0,l=t.textMetrics.lines[a].chars.length;for(let u=1;u<ee;u++){let d=t.textMetrics.lines[a+u];if(d)l+=d.chars.length;else break}let c=function(){if(!t.parent||!t.parent.preciseScreen){m.warn("TextBox scrollMessage: Parent became invalid during animation"),s();return}if(h++,t.blotText({text:t.text,metrics:t.textMetrics,maxChars:h,lineStart:a,lineCount:ee}),h===l)if(a+=ee,a>=t.textMetrics.lines.length)t.tickDelay(function(){t.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){m.warn("TextBox scrollMessage: Parent became invalid during closing animation"),s();return}t.canvas=T.transition({bg:Ke,metrics:t.textMetrics,progress:1-u.percent,lineCount:Math.min(t.textMetrics.lines.length,ee)}),t.updateScreen(),t.updateSprite()},ns,s)},r*is);else{h=0,l=t.textMetrics.lines[a].chars.length;for(let u=1;u<ee;u++){let d=t.textMetrics.lines[a+u];if(d)l+=d.chars.length;else break}t.tickDelay(c,r*ts)}else t.tickDelay(c,r)};this.tickRepeat(function(u){if(!t.parent||!t.parent.preciseScreen){m.warn("TextBox scrollMessage: Parent became invalid during opening animation"),s();return}t.canvas=T.transition({bg:Ke,metrics:t.textMetrics,progress:u.percent,lineCount:Math.min(t.textMetrics.lines.length,ee)}),t.updateScreen(),t.updateSprite()},ss,function(){t.tickDelay(c,r)})}remove(){if(this.game&&this.game.schedule)for(let e=this.game.schedule.length-1;e>=0;e--){let t=this.game.schedule[e];t.entity===this&&(t.type="deleted")}super.remove()}}});var P,ie=k(()=>{"use strict";He();P=class extends ${constructor(e){super();o(this,"height");o(this,"zDepth");o(this,"pixelSize");o(this,"screen");this.position={x:e.position.x,y:e.position.y,z:e.position.z,fakeZ:0},this.height=e.height,this.zDepth=this.calcZDepth(),this.pixelSize={x:e.pixelSize.x,y:e.pixelSize.y,z:e.pixelSize.z},this.screen={x:0,y:0},this.updateScreen(),this.sprite.screen=this.screen,this.sprite.position=this.position}move(e,t,s){let r=this.position.x+e,a=this.position.y+t,h=this.position.z+s;this.game.world.moveObject(this,r,a,h),this.updateScreen();let l=this.calcZDepth();l!=this.zDepth&&(this.game.renderer.updateZBuffer(this.zDepth,this.sprite,l),this.zDepth=l)}underneath(){return this.game.world.objectAtXYZ(this.position.x,this.position.y,this.position.z+this.height)}calcZDepth(){return this.position.x+this.position.y}updateScreen(){this.screen.x=(this.position.x-this.position.y)*16-this.pixelSize.x,this.screen.y=(this.position.x+this.position.y)*8-(this.position.z+this.height)*16}}});var Bt={};U(Bt,{default:()=>Ze});var Le,It,os,as,Ze,Je=k(()=>{"use strict";It=(n,i)=>{let e=Math.abs(n.x-i.x),t=Math.abs(n.y-i.y);return e>t?8*t+5*e:8*e+5*t},os=n=>{let i;for(let e in n)n.hasOwnProperty(e)&&(!i||i.f>n[e].f)&&(i=n[e]);return i},as=(n,i,e)=>{let t=[],s=i;for(;!(s.x==n.x&&s.y==n.y);)t.push({x:s.x,y:s.y,z:Le[s.x+":"+s.y]}),s=e[s.parent];return t.reverse()},Ze={loadMap:function(n){Le=n},findPath:function(n){let i=n.start,e=n.end;if(i.x==e.x&&i.y==e.y||!(Le[e.x+":"+e.y]>=0))return[];let t=It(e,i),s={x:i.x,y:i.y,grid:i.x+":"+i.y,g:0,h:t,f:t},r=!0,a=0,h={},l={};for(h[s.grid]=s,a++;a>0;){if(l[s.grid]=s,delete h[s.grid],a--,s.x==e.x&&s.y==e.y)return as(i,s,l);for(let u=-1;u<=1;u++)for(let d=-1;d<=1;d++){if(u==0&&d==0)continue;let p=s.x+u,g=s.y+d,M=p+":"+g;if(!(Le[M]>=0)||l[M])continue;let v=u==0||d==0?5:8,S=s.g+v;if(h[M]){let w=h[M];S<w.g&&(w.g=S,w.f=w.g+w.h,w.parent=s.grid)}else{let w={x:p,y:g,grid:M,g:S,h:It(e,{x:p,y:g}),f:0,parent:s.grid};w.f=w.g+w.h,h[w.grid]=w,a++}}let c=os(h);if(!c)break;s=c,r=!1}return[]}}});var _,Nt=k(()=>{"use strict";L();q();C();Je();_=class{constructor(i,e){o(this,"actor");o(this,"target");o(this,"attempt");o(this,"boundResetAttempt");o(this,"boundStartGoTo");o(this,"destination");o(this,"path");this.actor=i,this.target=e,this.attempt=b.randomIntRange(1,4),this.boundResetAttempt=this.resetAttempt.bind(this),this.target.on("movecomplete",this.boundResetAttempt),this.boundStartGoTo=this.startGoTo.bind(this),this.actor.destination?this.actor.once("movecomplete",this.boundStartGoTo):this.startGoTo()}startGoTo(){!this.actor||this.actor.presence!="online"||this.actor.underneath()||this.actor.tickDelay(()=>{this.performMove()},2)}performMove(){if(!this.actor||this.actor.presence!="online"||this.actor.underneath())return;let i=O.closestGrids[this.attempt];if(O.getDistance(this.actor.position,this.target.position)<=Math.abs(i[0])+Math.abs(i[1])){this.actor.stopGoTo(this);return}this.destination={x:this.target.position.x+i[0],y:this.target.position.y+i[1]};let t={x:this.destination.x-this.actor.position.x,y:this.destination.y-this.actor.position.y};var s={x:0,y:0};let r=Math.abs(t.x),a=Math.abs(t.y);r>a?(s.x=Math.max(-1,Math.min(1,t.x)),s.y=0):a>r?(s.x=0,s.y=Math.max(-1,Math.min(1,t.y))):r===a&&r>0&&(s.x=Math.max(-1,Math.min(1,t.x)),s.y=0);var h=this.actor.tryMove(s.x,s.y);if(h)this.actor.destination=h,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo);else if(this.path=Ze.findPath({start:this.actor.position,end:this.destination}),this.path[0]){let l={x:this.path[0].x-this.actor.position.x,y:this.path[0].y-this.actor.position.y},c={x:this.path[0].x,y:this.path[0].y,z:this.path[0].z};Math.abs(l.x)>0&&Math.abs(l.y)>0&&(Math.abs(l.x)>=Math.abs(l.y)?c={x:this.actor.position.x+Math.sign(l.x),y:this.actor.position.y,z:this.path[0].z}:c={x:this.actor.position.x,y:this.actor.position.y+Math.sign(l.y),z:this.path[0].z}),this.actor.destination=c,this.actor.startMove(),this.actor.once("movecomplete",this.boundStartGoTo)}else{if(this.attempt++,this.attempt>8){m.info("GoTo behavior giving up after maximum attempts",{actor:this.actor.username,attempts:this.attempt,target:this.target}),this.actor.stopGoTo(this);return}this.startGoTo()}}resetAttempt(){this.attempt=b.randomIntRange(1,4)}detach(){this.actor&&this.actor.removeListener("movecomplete",this.boundStartGoTo),this.target&&this.target.removeListener("movecomplete",this.boundResetAttempt),delete this.actor,delete this.target}}});var F,At=k(()=>{"use strict";L();q();C();F=class{constructor(i){o(this,"actor");o(this,"state","idle");o(this,"impulseCompleteBound");o(this,"impulseInterval",300);o(this,"impulseBound");this.actor=i,this.impulseCompleteBound=this.impulseComplete.bind(this),this.impulseBound=this.impulse.bind(this),this.wait()}wait(){this.actor&&this.actor.tickDelay(this.impulseBound,20+Math.round(Math.random()*this.impulseInterval))}impulse(){if(!(!this.actor||this.actor.presence!="online"))if(this.actor.destination)this.wait();else{let i=b.pickInObject(O.DIRECTIONS),e=O.DIRECTIONS[i],t=this.actor.tryMove(e.x,e.y);if(t){if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)){m.error("Wander behavior: tryMove returned NaN destination",{actor:this.actor.username,canMove:t,direction:i,moveXY:e,currentPosition:this.actor.position}),this.wait();return}this.actor.destination=t,this.actor.startMove(),this.actor.once("movecomplete",this.impulseCompleteBound)}else this.wait()}}impulseComplete(){this.wait()}detach(){this.actor.removeListener("movecomplete",this.impulseCompleteBound),this.actor.removeFromSchedule(this.impulseBound),delete this.actor}}});var ce,Rt=k(()=>{"use strict";ie();ce=class extends P{constructor(e,t){let s={position:{x:t.x,y:t.y,z:t.z},pixelSize:{x:0,y:0,z:0},height:.5};super(s);o(this,"parent");o(this,"invisible",!0);o(this,"unWalkable",!0);this.parent=e,this.addToGame(this.parent.game)}}});var hs,ue,Gt=k(()=>{"use strict";hs={actor:{online:{north:{x:28,y:0,w:14,h:14,ox:0,oy:5},south:{x:0,y:0,w:14,h:14,ox:0,oy:5},east:{x:14,y:0,w:14,h:14,ox:0,oy:5},west:{x:28,y:0,w:14,h:14,ox:0,oy:5}},idle:{north:{x:56,y:0,w:14,h:14,ox:0,oy:5},south:{x:42,y:0,w:14,h:14,ox:0,oy:5},east:{x:56,y:0,w:14,h:14,ox:0,oy:5},west:{x:42,y:0,w:14,h:14,ox:0,oy:5}},offline:{north:{x:84,y:0,w:14,h:14,ox:0,oy:5},south:{x:70,y:0,w:14,h:14,ox:0,oy:5},east:{x:84,y:0,w:14,h:14,ox:0,oy:5},west:{x:70,y:0,w:14,h:14,ox:0,oy:5}},hopping:{animation:{frames:13,zStartFrame:3},north:{x:0,y:83,w:35,h:27,ox:-2,oy:-6},south:{x:0,y:137,w:35,h:27,ox:-19,oy:3},east:{x:0,y:56,w:35,h:27,ox:-2,oy:3},west:{x:0,y:110,w:35,h:27,ox:-19,oy:-6}}}},ue=class{constructor(i){o(this,"map");this.map=JSON.parse(JSON.stringify(hs[i]))}}});var jt={};U(jt,{default:()=>Ce});var Ce,Wt=k(()=>{"use strict";L();q();Dt();C();ie();Nt();At();Rt();Gt();Ce=class extends P{constructor(e){(isNaN(e.x)||isNaN(e.y)||isNaN(e.z))&&(m.error("Actor constructor: Invalid coordinates provided",{username:e.username,uid:e.uid,coordinates:{x:e.x,y:e.y,z:e.z}}),e.x=isNaN(e.x)?0:e.x,e.y=isNaN(e.y)?0:e.y,e.z=isNaN(e.z)?0:e.z);let t={position:{x:e.x,y:e.y,z:e.z},pixelSize:{x:7,y:7,z:8},height:.5};super(t);o(this,"preciseScreen");o(this,"uid");o(this,"username");o(this,"nametag");o(this,"sheet");o(this,"presence","online");o(this,"talking",!1);o(this,"destination",!1);o(this,"facing");o(this,"behaviors",[]);o(this,"boundOnMessage");o(this,"roleColor");o(this,"placeholder");o(this,"moveTick");o(this,"talkBox");o(this,"talkTimeLeft");o(this,"frame",0);o(this,"lastMessage");o(this,"messageBox");o(this,"moveStart");o(this,"movePlaceholder");o(this,"destDelta");o(this,"unWalkable");this.preciseScreen=this.toScreenPrecise(),e.maxListeners&&this.setMaxListeners(e.maxListeners),this.uid=e.uid,this.username=e.username,this.nametag=new te(this,this.username,!0),this.nametag.blotText(),this.sheet=new ue("actor"),this.frame=0,this.sprite&&(this.sprite.image="actors",this.sprite.screen=this.screen),this.facing=b.pickInObject(O.DIRECTIONS),this.boundOnMessage=this.onMessage.bind(this),this.roleColor=e.roleColor,this.updateSprite()}onUpdate(){this.talking&&this.updateSprite();let e=this.game;if(e.mouseOut||e.mouseOver&&(e.mouseOver.zDepth>this.zDepth||e.mouseOver.position.z>this.position.z)||e.ui.mouseOnElement)return;let t={x:e.centerMouseX-e.renderer.canvases[0].panning.panned.x,y:e.centerMouseY-e.renderer.canvases[0].panning.panned.y},s=this.sheet.map.online.north;t.x>=this.preciseScreen.x+s.ox&&t.x<this.preciseScreen.x+s.w+s.ox&&t.y>=this.preciseScreen.y+s.oy&&t.y<this.preciseScreen.y+s.h+s.oy?(e.mouseOver=this,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!1)):e.mouseOver===this&&(e.mouseOver=!1,this.nametag&&!this.talking&&(this.nametag.sprite.hidden=!0))}addToGame(e){super.addToGame(e),m.actorSpawned({uid:this.uid,username:this.username,x:this.position.x,y:this.position.y,z:this.position.z,roleColor:this.roleColor,presence:this.presence}),this.roleColor&&e.renderer.addColorSheet({sheet:"actors",color:this.roleColor,alpha:.8,regions:[{alpha:.4,x:70,y:0,w:28,h:14}]}),this.nametag&&(this.nametag.addToGame(e),this.nametag.sprite.hidden=!0),e.on("update",this.onUpdate.bind(this)),e.users&&e.users.on("message",this.boundOnMessage),this.behaviors.push(new F(this))}updatePresence(e){if(this.presence=e,this.updateSprite(),e!="online"){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof F&&(this.behaviors[t].detach(),this.behaviors.splice(t,1));this.destination&&(this.moveTick&&(m.info("Actor cancelling movement due to presence change",{username:this.username,newPresence:e}),this.removeFromSchedule(this.moveTick),delete this.moveTick,this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,delete this.moveStart,delete this.destDelta),this.destination=!1)}else{let t=!1;for(let s of this.behaviors)if(s instanceof F){t=!0;break}t||this.behaviors.push(new F(this))}}toScreenPrecise(){if(isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z))return m.error("Actor toScreenPrecise: Position coordinates contain NaN",{actor:this.username,position:this.position,uid:this.uid}),{x:0,y:0};if(this.destination&&this.moveStart!==void 0){let t=this.game;if(t&&t.ticks!==void 0){let s=this.destination.x-this.position.x,r=this.destination.y-this.position.y,a=this.destination.z-this.position.z,h=t.ticks-this.moveStart,c=3*this.sheet.map.hopping.animation.frames,u=Math.min(h/c,1),d={x:(s-r)*16*u,y:(s+r)*8-a*16*u};return{x:this.screen.x+d.x,y:this.screen.y+d.y}}}let e={x:(this.position.x-this.position.y)*16-8,y:(this.position.x+this.position.y)*8-this.position.z*16-8};return isNaN(e.x)||isNaN(e.y)?(m.error("Actor toScreenPrecise: Calculated screen coordinates are NaN",{actor:this.username,position:this.position,screen:e,uid:this.uid}),{x:0,y:0}):e}updateSprite(){if(!this.sprite)return;let e=this.facing,t=this.destination?"hopping":this.presence;if(!this.destination&&this.talking&&(t="online",e=e==="north"?"east":e==="west"?"south":e),!this.sheet.map[t]||!this.sheet.map[t][e]){if(!this.sheet.map[t])switch(t){case"dnd":case"busy":t="idle";break;case"away":case"invisible":t="offline";break;default:t="online";break}if(!this.sheet.map[t]||!this.sheet.map[t][e]){m.error("Actor sprite not found",{actor:this.username,state:t,facing:e,availableStates:Object.keys(this.sheet.map),availableFacingsForState:this.sheet.map[t]?Object.keys(this.sheet.map[t]):null});return}}let s=this.sheet.map[t][e],r={x:s.x,y:s.y,w:s.w,h:s.h,ox:s.ox||0,oy:s.oy||0};if(!this.destination&&this.talking){let a=this.game;a&&a.ticks!==void 0&&(r.y+=Math.floor(a.ticks/4)%4*r.h)}else if(this.destination){let a=r.x,h=r.y;r.x+=(this.frame||0)*r.w;let l=this.sheet.map.hopping.animation;if(this.frame>=l.zStartFrame){let c=this.destination.z-this.position.z;c>0?r.oy-=Math.min(8,this.frame-l.zStartFrame):c<0&&(r.oy+=Math.min(8,this.frame-l.zStartFrame))}}if(this.talking&&this.messageBox&&this.messageBox.updateScreen(),this.sprite.metrics=r,this.roleColor){let a=this.game;a&&a.renderer&&a.renderer.addColorSheet?(a.renderer.addColorSheet({color:this.roleColor,sheet:"actors",alpha:1}),this.sprite.image=[this.roleColor,"actors"]):this.sprite.image="actors"}else this.sprite.image="actors"}tryMove(e,t){let s=this.game;if(!s.world||!s.world.canWalk)return!1;if(this.underneath())return m.debug("Actor movement blocked: object on top",{actor:this.username}),this.emit("getoffme"),!1;if(isNaN(e)||isNaN(t))return m.error("Actor tryMove: Movement deltas contain NaN",{actor:this.username,deltaX:e,deltaY:t,currentPosition:this.position}),!1;if(isNaN(this.position.x)||isNaN(this.position.y))return m.error("Actor tryMove: Current position contains NaN",{actor:this.username,position:this.position,movementDeltas:{x:e,y:t}}),!1;let r={x:this.position.x+e,y:this.position.y+t};if(isNaN(r.x)||isNaN(r.y))return m.error("Actor tryMove: Calculated destination contains NaN",{actor:this.username,destination:r,currentPosition:this.position,movementDeltas:{x:e,y:t}}),!1;if(s.world.canWalk(r.x,r.y)){let a=s.world.getHeight(r.x,r.y);if(a>=0&&Math.abs(this.position.z-a)<=.5)return{x:r.x,y:r.y,z:a};m.error("Actor tryMove: Destination not walkable or invalid height",{actor:this.username,destination:r,walkable:a,currentPosition:this.position,movementDeltas:{x:e,y:t}})}return!1}startMove(){if(!this.destination)return;if(this.moveTick){m.warn("Actor startMove: Movement already in progress",{actor:this.username,currentDestination:this.destination,frame:this.frame,moveStart:this.moveStart});return}let e=this.game;if(!e||!e.world){m.error("Actor startMove: Game or world not available",{actor:this.username});return}if(this.moveStart=e.ticks,e.world.objectAtXYZ(this.destination.x,this.destination.y,this.destination.z)){this.destination=!1;return}this.movePlaceholder=new ce(this,{x:this.destination.x,y:this.destination.y,z:this.destination.z}),this.unWalkable=!0,delete e.world.walkable[this.position.x+":"+this.position.y],this.destDelta={x:this.destination.x-this.position.x,y:this.destination.y-this.position.y,z:this.destination.z-this.position.z},this.destDelta.x>0?this.facing="east":this.destDelta.x<0?this.facing="west":this.destDelta.y>0?this.facing="south":this.destDelta.y<0&&(this.facing="north"),this.destDelta.x!==0&&this.destDelta.y!==0&&m.warn("Actor diagonal movement detected",{actor:this.username,destDelta:this.destDelta,destination:this.destination,position:this.position}),this.frame=0;let s=this.sheet.map.hopping.animation,r=this.position.x+this.position.y+(this.destDelta.x+this.destDelta.y)/2;this.moveTick=this.tickRepeat(a=>{if(!this.exists){this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder);return}let h=!1;if(a.ticks>0&&a.ticks%3===0&&(this.frame++,h=!0),h&&this.frame===6)e.renderer.updateZBuffer(this.zDepth,this.sprite,r),this.zDepth=r;else if(h&&this.frame===8){let l=this.destination.x+this.destination.y;e.renderer.updateZBuffer(r,this.sprite,l),this.zDepth=l}this.preciseScreen=this.toScreenPrecise(),this.nametag&&this.nametag.updateScreen(),this.updateSprite(),this.frame>=s.frames&&(this.movePlaceholder&&(this.movePlaceholder.remove(),delete this.movePlaceholder),this.unWalkable=!1,this.move(this.destination.x,this.destination.y,this.destination.z,!0),this.destination=!1,this.frame=0,delete this.moveStart,delete this.destDelta,this.updateSprite(),this.emit("movecomplete"),delete this.moveTick)},3*s.frames),this.updateSprite()}move(e,t,s,r){if(isNaN(e)||isNaN(t)||typeof s<"u"&&isNaN(s)){m.error("Actor move: Invalid coordinates provided",{actor:this.username,parameters:{x:e,y:t,z:s,absolute:r},currentPosition:this.position});return}if(r){let a=this.game;a&&a.world&&a.world.moveObject?a.world.moveObject(this,e,t,s!==void 0?s:this.position.z):(this.position.x=e,this.position.y=t,typeof s<"u"&&(this.position.z=s))}else{typeof s<"u"?super.move(e,t,s):super.move(e,t,0);return}if(isNaN(this.position.x)||isNaN(this.position.y)||isNaN(this.position.z)){m.error("Actor move: Final position contains NaN after movement",{actor:this.username,finalPosition:this.position,movement:{x:e,y:t,z:s,absolute:r}});return}this.zDepth=this.calcZDepth(),this.updateScreen(),this.preciseScreen=this.toScreenPrecise()}startTalking(e,t,s){this.talking=!0,this.lastMessage={channel:t,time:Date.now()},this.nametag&&(this.nametag.sprite.hidden=!0),this.messageBox=new te(this,e,!0),this.messageBox.addToGame(this.game);let r=this;this.messageBox.scrollMessage(function(){delete r.messageBox,r.talking=!1,r.updateSprite(),r.emit("donetalking"),s&&s()})}onMessage(e){let t=this.lastMessage||{time:0};if(e.channel!==t.channel||t.time<Date.now()-180*1e3||e.user===this||this.presence!=="online")return;let s=this;function r(){for(let a=0;a<s.behaviors.length;a++)s.behaviors[a].detach();s.behaviors=[new _(s,e.user)]}this.tickDelay(function(){O.getDistance(s.position,e.user.position)<3||s.underneath()||(s.destination?s.once("movecomplete",r):r())},b.randomIntRange(0,60))}goto(e,t){m.debug("Actor goto command",{actor:this.username,targetX:e,targetY:t});let s={position:{x:e,y:t,z:this.game.world.getHeight(e,t)}};for(let r=this.behaviors.length-1;r>=0;r--)this.behaviors[r]instanceof _&&(this.behaviors[r].detach(),this.behaviors.splice(r,1));this.behaviors.push(new _(this,s))}stopGoTo(e){for(let t=this.behaviors.length-1;t>=0;t--)this.behaviors[t]instanceof _&&(!e||this.behaviors[t]===e)&&(this.behaviors[t].detach(),this.behaviors.splice(t,1))}remove(){let e=this.game;e&&e.users&&e.users.off("message",this.boundOnMessage);for(let t of this.behaviors)t.detach&&t.detach();if(this.behaviors=[],this.movePlaceholder){try{this.movePlaceholder.remove()}catch(t){m.error("Actor remove: Error removing movePlaceholder",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.movePlaceholder}if(this.messageBox){try{this.messageBox.remove()}catch(t){m.error("Actor remove: Error removing messageBox",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.messageBox}if(this.talkBox){try{this.talkBox.remove()}catch(t){m.error("Actor remove: Error removing talkBox",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.talkBox}if(this.nametag){try{this.nametag.remove()}catch(t){m.error("Actor remove: Error removing nametag",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.nametag}if(this.placeholder){try{this.placeholder.remove()}catch(t){m.error("Actor remove: Error removing placeholder",{actor:this.username,error:t instanceof Error?t.message:String(t)})}delete this.placeholder}super.remove()}}});var ei={};U(ei,{default:()=>De});var De,ti=k(()=>{"use strict";ie();De=class extends P{constructor(e,t,s,r){super({position:{x:t,y:s,z:r},pixelSize:{x:16,y:16,z:1},height:.5});o(this,"invisible",!0);o(this,"style");this.style=e}}});var ii={};U(ii,{default:()=>se});var us,se,rt=k(()=>{"use strict";us={tile:{"G-G-G-G":{x:0,y:108,w:32,h:18,ox:-1,oy:-2},"S-S-S-S":{x:32,y:90,w:32,h:18,ox:-1,oy:-2},"G-S-G-S":{x:64,y:90,w:32,h:18,ox:-1,oy:-2},"S-G-S-G":{x:96,y:90,w:32,h:18,ox:-1,oy:-2},"G-G-G-S":{x:0,y:18,w:32,h:18,ox:-1,oy:-2},"S-G-G-G":{x:0,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-G-G":{x:0,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-G":{x:0,y:72,w:32,h:18,ox:-1,oy:-2},"S-G-G-S":{x:32,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-G-G":{x:32,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-G":{x:32,y:54,w:32,h:18,ox:-1,oy:-2},"G-G-S-S":{x:32,y:72,w:32,h:18,ox:-1,oy:-2},"S-S-G-S":{x:64,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-G":{x:64,y:36,w:32,h:18,ox:-1,oy:-2},"G-S-S-S":{x:64,y:54,w:32,h:18,ox:-1,oy:-2},"S-G-S-S":{x:64,y:72,w:32,h:18,ox:-1,oy:-2},"F-F-F-F":{x:64,y:198,w:32,h:18,ox:-1,oy:-2},"G-F-G-F":{x:0,y:198,w:32,h:18,ox:-1,oy:-2},"F-G-F-G":{x:32,y:198,w:32,h:18,ox:-1,oy:-2},"G-G-G-F":{x:0,y:126,w:32,h:18,ox:-1,oy:-2},"F-G-G-G":{x:0,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-G-G":{x:0,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-G":{x:0,y:180,w:32,h:18,ox:-1,oy:-2},"F-G-G-F":{x:32,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-G-G":{x:32,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-G":{x:32,y:162,w:32,h:18,ox:-1,oy:-2},"G-G-F-F":{x:32,y:180,w:32,h:18,ox:-1,oy:-2},"F-F-G-F":{x:64,y:126,w:32,h:18,ox:-1,oy:-2},"F-F-F-G":{x:64,y:144,w:32,h:18,ox:-1,oy:-2},"G-F-F-F":{x:64,y:162,w:32,h:18,ox:-1,oy:-2},"F-G-F-F":{x:64,y:180,w:32,h:18,ox:-1,oy:-2},"E-E-S-E":{x:96,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-S-E":{x:96,y:36,w:32,h:18,ox:-1,oy:-2},"E-E-S-S":{x:96,y:54,w:32,h:18,ox:-1,oy:-2},"E-S-S-S":{x:96,y:72,w:32,h:18,ox:-1,oy:-2},"E-E-E-S":{x:128,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-E":{x:128,y:18,w:32,h:18,ox:-1,oy:-2},"S-E-E-E":{x:160,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-E-S":{x:160,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-E":{x:192,y:0,w:32,h:18,ox:-1,oy:-2},"S-S-E-S":{x:192,y:18,w:32,h:18,ox:-1,oy:-2},"E-S-E-S":{x:224,y:0,w:32,h:18,ox:-1,oy:-2},"S-E-S-S":{x:224,y:18,w:32,h:18,ox:-1,oy:-2},"S-S-S-E":{x:224,y:36,w:32,h:18,ox:-1,oy:-2},"S-E-S-E":{x:224,y:54,w:32,h:18,ox:-1,oy:-2}}},se=class{constructor(i){o(this,"map");this.map=JSON.parse(JSON.stringify(us[i]))}}});var si={};U(si,{default:()=>Ie});var Ie,ni=k(()=>{"use strict";C();rt();Ie=class{constructor(i){o(this,"game");o(this,"grid");o(this,"tileCode");o(this,"position");o(this,"zDepth");o(this,"screen");o(this,"imageName");o(this,"sheet");o(this,"sprite");this.game=i.game,this.grid=i.grid,this.tileCode=i.tileCode,this.position=i.position,this.zDepth=this.position.x+this.position.y,this.screen={x:(this.position.x-this.position.y)*16-16,y:(this.position.x+this.position.y)*8-this.position.z*16-8},this.imageName="static-tiles",this.sheet=new se("tile");let e=this.sheet.map[this.tileCode]||{x:0,y:0,w:16,h:16,ox:0,oy:0};if(this.sprite={metrics:{x:e.x||0,y:e.y||0,w:e.w||16,h:e.h||16,ox:e.ox||0,oy:e.oy||0},image:this.imageName,position:this.position,screen:this.screen},this.tileCode=="G-G-G-G"){let t=b.randomIntRange(0,2),s=Math.random();Math.random()>.98?t=8:Math.random()>.95?t=b.randomIntRange(5,7):s>.6&&(t=b.randomIntRange(3,4)),this.sprite.metrics.x+=t*this.sprite.metrics.w}}}});var ds,K,ot=k(()=>{"use strict";ds={beacon:{main:{x:0,y:0,w:31,h:56,ox:-1,oy:-1},light:{x:31,y:0,w:5,h:4,ox:13,oy:0}},seed:{plant:{x:36,y:0,w:16,h:22,ox:2,oy:2},orb:{x:36,y:22,w:8,h:8,ox:8,oy:4}}},K=class{constructor(i){o(this,"map");this.map=JSON.parse(JSON.stringify(ds[i]))}}});var ui={};U(ui,{default:()=>Be});var Be,li=k(()=>{"use strict";ie();W();ot();Be=class extends P{constructor(e,t,s){super({position:{x:e,y:t,z:s},pixelSize:{x:15,y:16,z:45},height:2.5});o(this,"unWalkable",!0);o(this,"imageName","props");o(this,"sheet");o(this,"pinging",0);this.on("draw",a=>{this.exists&&a.drawEntity(this)}),this.sheet=new K("beacon"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.main)}addToGame(e){super.addToGame(e),e.on("update",this.onUpdate.bind(this)),this.drawSprite()}drawSprite(){if(!this.sheet?.map?.main||!this.game?.renderer?.images?.[this.imageName])return;let e=new E(this.sheet.map.main.w,this.sheet.map.main.h);e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.main.x,this.sheet.map.main.y,this.sheet.map.main.w,this.sheet.map.main.h,0,0,this.sheet.map.main.w,this.sheet.map.main.h),this.pinging&&this.sheet.map.light&&e.drawImage(this.game.renderer.images[this.imageName],this.sheet.map.light.x,this.sheet.map.light.y,this.sheet.map.light.w,this.sheet.map.light.h,this.sheet.map.light.ox,0,this.sheet.map.light.w,this.sheet.map.light.h,this.pinging/100),this.sprite&&(this.sprite.image=e.canvas)}onUpdate(){this.pinging&&(this.pinging=Math.max(0,this.pinging-1),this.drawSprite())}ping(){this.pinging=100}}});var di={};U(di,{default:()=>Ne});var Ne,mi=k(()=>{"use strict";C();ie();ot();Ne=class extends P{constructor(e){let t={position:{x:e.destination.x,y:e.destination.y,z:e.destination.z},pixelSize:{x:12,y:12,z:16},height:1};super(t);o(this,"unwalkable",!0);o(this,"origin");o(this,"sheet");o(this,"boundGrow");o(this,"boundWither");o(this,"growTime",80);o(this,"growStage",0);o(this,"growthStage");this.origin=e.origin,this.on("draw",s=>{this.exists&&s.drawEntity(this)}),this.sprite&&(this.sprite.image="props"),this.boundGrow=this.grow.bind(this),this.boundWither=this.wither.bind(this),this.sheet=new K("seed"),this.sprite&&this.sheet.map&&(this.sprite.metrics=this.sheet.map.plant)}addToGame(e){super.addToGame(e),this.tickDelay(this.boundGrow,this.growTime+b.randomIntRange(this.growTime/-6,this.growTime/6))}grow(){this.growStage++;let e=JSON.parse(JSON.stringify(this.sheet.map.plant));e.x+=this.sprite.metrics.w*this.growStage,this.sprite.metrics=e;let t=this.growTime+b.randomIntRange(this.growTime/-6,this.growTime/6);this.growStage<5?this.tickDelay(this.boundGrow,t):this.tickDelay(this.boundWither,Math.floor(t/2))}wither(){let e=this.sheet.map.orb;this.sprite.metrics=JSON.parse(JSON.stringify(e)),this.tickRepeat(t=>{this.sprite.metrics.oy=Math.round(e.oy+t.ticks/2),t.percent>=1&&(this.growthStage=6)},26)}}});L();var _t=D(I(),1);L();var ze,qe=null,le=class extends _t.EventEmitter{constructor(e,t){super();o(this,"game");o(this,"world");o(this,"actors",{});o(this,"messageQueue",{});this.setMaxListeners(0),this.game=e,this.game.once("destroy",this.destroy.bind(this)),this.game.users=this,this.world=t,this.actors={},this.messageQueue={},qe=this.loadActor()}async loadActor(){try{ze=(await Promise.resolve().then(()=>(Wt(),jt))).default}catch(e){throw m.error("Failed to load Actor class",{error:e instanceof Error?e.message:String(e)}),e}}async addActor(e){if(!ze&&qe&&await qe,!ze){m.error("Actor class not loaded yet");return}let t=this.world.randomEmptyGrid(),s=new ze({x:+t.split(":")[0],y:+t.split(":")[1],z:0,uid:e.uid,username:e.username,roleColor:e.roleColor,maxListeners:this.getMaxListeners()+3});this.actors[s.uid]=s,s.addToGame(this.game),s.updatePresence(e.status)}async updateActor(e){let t=this.actors[e.uid];t?e.delete?(t.updatePresence("offline"),this.removeActor(t)):t.updatePresence(e.status):await this.addActor(e)}removeActor(e){delete this.actors[e.uid],e.remove()}queueMessage(e){!e.message||!this.actors[e.uid]||(this.messageQueue[e.channel]||(this.messageQueue[e.channel]={busy:!1,messages:[]}),this.messageQueue[e.channel].messages.push({uid:e.uid,message:e.message}),this.onMessageAdded(e.channel))}onMessageAdded(e){let t=this.messageQueue[e];if(t.busy||t.messages.length<1)return;t.busy=!0;let s=t.messages[0],r=this;this.actors[s.uid].startTalking(s.message,e,function(){r.messageQueue[e].messages.shift(),r.messageQueue[e].busy=!1,r.onMessageAdded(e)}),this.emit("message",{user:this.actors[s.uid],channel:e})}getActorAtPosition(e,t,s){for(let r in this.actors)if(this.actors.hasOwnProperty(r)&&this.actors[r].position.x==e&&this.actors[r].position.y==t&&this.actors[r].position.z==s)return this.actors[r]}destroy(){this.actors={},this.messageQueue={}}};var Ft=D(I(),1);L();var Ve=class extends Ft.EventEmitter{constructor(e){super();o(this,"clientId");o(this,"redirectUri");o(this,"scopes");o(this,"state");o(this,"accessToken",null);o(this,"user",null);this.clientId=e.clientId,this.redirectUri=e.redirectUri||window.location.origin+"/discord-callback.html",this.scopes=e.scopes||["identify"],this.state=this.generateState(),this.loadStoredAuth()}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}getAuthUrl(){return"https://discord.com/api/oauth2/authorize?"+new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,response_type:"token",scope:this.scopes.join(" "),state:this.state}).toString()}login(){let e=this.getAuthUrl();m.info("Starting Discord OAuth login",{authUrl:e}),localStorage.setItem("discord_oauth_state",this.state);let t=window.open(e,"discord_oauth","width=500,height=700,scrollbars=yes");if(!t){m.error("Discord OAuth popup was blocked by browser"),this.emit("login-error","Popup was blocked by browser. Please allow popups for this site.");return}m.debug("Discord OAuth popup opened successfully");let s=this,r=h=>{if(m.debug("Received message from Discord OAuth popup",{type:h.data?.type,origin:h.origin}),h.origin!==window.location.origin){m.debug("Ignoring message from different origin",{expectedOrigin:window.location.origin,receivedOrigin:h.origin});return}let l=h.data;if(l.type==="discord-auth-success"){let c=l,u=c.accessToken,d=c.state,p=c.expiresIn;if(m.info("Discord OAuth success received",{accessTokenLength:u?u.length:0,state:d}),window.removeEventListener("message",r),d!==s.state){m.error("Discord OAuth state mismatch",{expected:s.state,received:d}),s.emit("login-error","Invalid state parameter");return}u?(s.accessToken=u,s.storeAuth({access_token:u,expires_in:p}),s.fetchUserInfo()):(m.error("No access token in Discord OAuth success message"),s.emit("login-error","No access token received"))}else if(l.type==="discord-auth-error"){let c=l;m.error("Discord OAuth error received",{error:c.error}),window.removeEventListener("message",r),s.emit("login-error",c.error)}};window.addEventListener("message",r);let a=setInterval(()=>{t.closed&&(m.info("Discord OAuth popup was closed by user"),clearInterval(a),window.removeEventListener("message",r),s.emit("login-cancelled"))},1e3)}fetchUserInfo(){let e=this;fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+this.accessToken}}).then(t=>t.json()).then(t=>{e.user=t,localStorage.setItem("discord_user",JSON.stringify(t)),e.emit("login-success",t)}).catch(t=>{e.emit("login-error",t.message)})}logout(){this.accessToken=null,this.user=null,localStorage.removeItem("discord_auth_token"),localStorage.removeItem("discord_auth_expires"),localStorage.removeItem("discord_user"),this.emit("logout")}storeAuth(e){if(localStorage.setItem("discord_auth_token",e.access_token),e.expires_in){let t=Date.now()+e.expires_in*1e3;localStorage.setItem("discord_auth_expires",t.toString())}}loadStoredAuth(){let e=localStorage.getItem("discord_auth_token"),t=localStorage.getItem("discord_auth_expires"),s=localStorage.getItem("discord_user");if(e&&(!t||Date.now()<parseInt(t))){if(this.accessToken=e,s)try{this.user=JSON.parse(s)}catch{}this.accessToken&&!this.user&&this.fetchUserInfo()}else this.logout()}isLoggedIn(){return!!(this.accessToken&&this.user)}getUser(){return this.user}getAvatarUrl(e=128){return!this.user||!this.user.avatar?null:`https://cdn.discordapp.com/avatars/${this.user.id}/${this.user.avatar}.png?size=${e}`}},Qe=Ve;C();C();var Ut=D(I(),1);W();L();var et=class extends Ut.EventEmitter{constructor(e){super();o(this,"id");o(this,"game");o(this,"backgroundColor");o(this,"scale");o(this,"canvases",[]);o(this,"canvas");o(this,"context");o(this,"width");o(this,"height");o(this,"halfWidth");o(this,"halfHeight");o(this,"panning");o(this,"images");this.id=e.id,this.game=e.game,this.backgroundColor=e.backgroundColor,this.scale=e.initialScale;for(let s=1;s<5;s++){let r=new E(1,1);r.canvas.id=this.id+s,document.body.appendChild(r.canvas),r.canvas.style.transform=`scale(${s}, ${s})`;let a=r.context;a.mozImageSmoothingEnabled!==void 0&&(a.mozImageSmoothingEnabled=!1),a.imageSmoothingEnabled=!1,r.canvas.addEventListener("contextmenu",h=>{h.preventDefault()}),this.canvases.push(r)}this.onZoom(),this.onResize(),window.addEventListener("resize",this.onResize.bind(this)),this.panning={buttons:[],origin:{x:0,y:0},panned:{x:0,y:32}};let t=this;this.game.on("mousedown",s=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=s.x,t.panning.origin.y=s.y),t.panning.buttons.push(s.button))}),this.game.on("mouseup",s=>{H.findAndRemove(s.button,t.panning.buttons)}),this.game.on("mousemove",s=>{let r=s.x-t.panning.origin.x,a=s.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=r,t.panning.panned.y+=a),t.panning.origin.x=s.x,t.panning.origin.y=s.y}),this.game.on("touchstart",s=>{t.game.ui.mouseOnElement||(t.panning.buttons.length===0&&(t.panning.origin.x=s.x,t.panning.origin.y=s.y),t.panning.buttons.push(s.button))}),this.game.on("touchend",s=>{H.findAndRemove(s.button,t.panning.buttons)}),this.game.on("touchmove",s=>{let r=s.x-t.panning.origin.x,a=s.y-t.panning.origin.y;t.panning.buttons.length>0&&(t.panning.panned.x+=r,t.panning.panned.y+=a),t.panning.origin.x=s.x,t.panning.origin.y=s.y}),this.game.on("mouseout",s=>{}),this.game.on("mouseover",s=>{t.panning.origin.x=s.x,t.panning.origin.y=s.y,s.button||(t.panning.buttons=[])}),this.game.on("mousewheel",s=>{let r=H.clamp(t.scale+(s.direction==="up"?1:-1),1,4);r!==t.scale&&(t.scale=r,t.onZoom(),t.onResize())})}setRenderer(e){this.images=e.images}onResize(){this.width=this.canvas.canvas.width=Math.ceil(window.innerWidth/this.scale),this.height=this.canvas.canvas.height=Math.ceil(window.innerHeight/this.scale),this.halfWidth=Math.round(this.width/2),this.halfHeight=Math.round(this.height/2),this.emit("resize",{scale:this.scale,width:this.width,height:this.height})}onZoom(){for(let e=0;e<this.canvases.length;e++)e+1===this.scale?(this.canvases[e].canvas.style.zIndex="5",this.canvas=this.canvases[e],this.context=this.canvas.context):this.canvases[e].canvas.style.zIndex="1"}draw(){}drawStatic(e){this.context.drawImage(e,0,0)}drawBG(e){if(!e||!e.image){m.error("Canvas drawBG: No bgCanvas or bgCanvas.image");return}let t=e.x+this.halfWidth+this.panning.panned.x,s=e.y+this.halfHeight+this.panning.panned.y;if(t>=this.width||s>=this.height||t*-1>=e.image.width||s*-1>=e.image.height)return;let r={x:Math.max(0,t),y:Math.max(0,s)},a={w:Math.min(e.image.width,this.width,this.width-t),h:Math.min(e.image.height,this.height,this.height-s)},h={x:Math.max(0,t*-1),y:Math.max(0,s*-1)},l={x:Math.min(e.image.width,h.x+a.w),y:Math.min(e.image.height,h.y+a.h)},c={x:l.x-h.x,y:l.y-h.y};this.context.drawImage(e.image,h.x,h.y,c.x,c.y,r.x,r.y,c.x,c.y)}drawEntity(e){if(!e||!e.image||e.hidden||e.position&&e.position.z>this.game.hideZ)return;let t={x:e.screen.x+this.halfWidth+this.panning.panned.x+(e.metrics.ox||0),y:e.screen.y+this.halfHeight+this.panning.panned.y+(e.metrics.oy||0)};if(e.keepOnScreen&&(t.x=Math.min(this.width-e.metrics.w,Math.max(0,t.x)),t.y=Math.min(this.height-e.metrics.h,Math.max(0,t.y))),t.x>=this.width||t.y>=this.height||t.x+e.metrics.w<=0||t.y+e.metrics.h<=0)return;let s;if(Array.isArray(e.image)){let h=this.images[e.image[0]];if(!h){m.error("Canvas drawEntity: Color collection not found",{requestedCollection:e.image[0],availableImages:Object.keys(this.images)});return}if(s=h[e.image[1]],!s){m.error("Canvas drawEntity: Colored sprite not found",{requestedSprite:e.image,availableInCollection:Object.keys(h)});return}}else if(typeof e.image=="string"){if(s=this.images[e.image],!s){m.error("Canvas drawEntity: Image not found",{requestedImage:e.image,availableImages:Object.keys(this.images)});return}}else s=e.image;let r=e===this.game.mouseOver?.sprite;if(r&&(this.context.save(),this.context.shadowColor="rgba(255,255,255,1)",this.context.shadowBlur=3),!e.stay&&e.parent&&this.game.mouseOver!==e.parent)return;if(!isFinite(t.x)||!isFinite(t.y)||!isFinite(e.metrics.x)||!isFinite(e.metrics.y)||!isFinite(e.metrics.w)||!isFinite(e.metrics.h)){m.error("Canvas drawEntity: NaN detected in coordinates",{spriteType:e.constructor?.name||"unknown",spriteParent:e.parent?.constructor?.name||"no parent",spriteParentUsername:e.parent?.username||"no username",spriteParentPosition:e.parent?.position||"no position",spriteImage:typeof e.image=="string"?e.image:"canvas object",screen:{x:t.x,y:t.y},metrics:e.metrics,drawImageParams:[e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h]});return}this.canvas.drawImage(s,e.metrics.x,e.metrics.y,e.metrics.w,e.metrics.h,Math.round(t.x),Math.round(t.y),e.metrics.w,e.metrics.h),r&&this.context.restore(),this.game.showGrid&&e.grid&&(this.context.fillStyle="#bbbbbb",this.context.font="9px Arial",this.context.fillText(e.grid,Math.round(t.x)+5,Math.round(t.y)+9))}},Xt=et;var Kt=D(I(),1);L();C();var $t=D(I(),1);var Pe=class extends $t.EventEmitter{constructor(){super();o(this,"mouseX",0);o(this,"mouseY",0);o(this,"mouseLeft",!1);o(this,"mouseRight",!1);o(this,"mouseOut",!1);o(this,"keys",{});o(this,"canvas",null);o(this,"mouseScale",1);this.setMaxListeners(0),document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this))}bindCanvas(e){this.canvas=e.canvas.canvas,this.mouseScale=e.scale,window.addEventListener("mousemove",this.mousemove.bind(this)),window.addEventListener("mousedown",this.mousedown.bind(this)),window.addEventListener("mouseup",this.mouseup.bind(this)),window.addEventListener("touchmove",this.touchmove.bind(this)),window.addEventListener("touchstart",this.touchstart.bind(this)),window.addEventListener("touchend",this.touchend.bind(this)),window.addEventListener("touchcancel",this.touchend.bind(this)),document.addEventListener("mouseout",this.mouseout.bind(this)),document.addEventListener("mouseover",this.mouseover.bind(this));let t="onwheel"in document.createElement("div")?"wheel":"mousewheel";window.addEventListener(t,this.mousewheel.bind(this))}mousemove(e){let t=e;this.mouseOut||(this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mousemove",{x:this.mouseX,y:this.mouseY}))}touchstart(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchstart",{button:"touch",x:this.mouseX,y:this.mouseY})}touchend(e){let t=e.changedTouches[0];this.emit("touchend",{button:"touch",x:t.pageX,y:t.pageY})}touchmove(e){let t=e.changedTouches[0];this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("touchmove",{button:"touch",x:this.mouseX,y:this.mouseY})}mousedown(e){let s=Te[e.button];switch(s){case"left":this.mouseLeft=!0;break;case"right":this.mouseRight=!0;break}this.emit("mousedown",{button:s,x:this.mouseX,y:this.mouseY})}mouseup(e){let s=Te[e.button];switch(s){case"left":this.mouseLeft=!1;break;case"right":this.mouseRight=!1;break}this.emit("mouseup",{button:s,x:this.mouseX,y:this.mouseY})}mouseout(e){let t=e,s=Te[t.button];this.mouseOut=!0,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseout",{x:this.mouseX,y:this.mouseY,button:s})}mouseover(e){let t=e,s=t.buttons&1?1:t.buttons&2?2:t.buttons&4?3:0,r=Te[s-1];this.mouseOut=!1,this.mouseX=Math.floor(t.pageX/this.mouseScale),this.mouseY=Math.floor(t.pageY/this.mouseScale),this.emit("mouseover",{x:this.mouseX,y:this.mouseY,button:r})}mousewheel(e){let t=e;if(!t.deltaY)return;let s=t.deltaY>0?"down":"up";this.emit("mousewheel",{direction:s,x:this.mouseX,y:this.mouseY})}keydown(e){let t=e,s=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():Ht[t.keyCode];s==="backspace"&&t.preventDefault(),!this.keys[s]&&(this.keys[s]=!0,this.emit("keydown",{key:s}))}keyup(e){let t=e,s=t.keyCode>=48&&t.keyCode<=90?String.fromCharCode(t.keyCode).toLowerCase():Ht[t.keyCode];this.keys[s]&&(this.keys[s]=!1,this.emit("keyup",{key:s}))}},Te=["left","middle","right"],Ht={37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"};var Yt=typeof performance<"u"&&performance.now?()=>performance.now():()=>Date.now(),tt=class extends Kt.EventEmitter{constructor(e={}){super();o(this,"step");o(this,"lastUpdate",0);o(this,"dt",0);o(this,"ticks",0);o(this,"crashed");o(this,"paused");o(this,"input");o(this,"mouseButtons",[]);o(this,"centerMouseX",-999);o(this,"centerMouseY",-999);o(this,"mouseX");o(this,"mouseY");o(this,"mouseOut");o(this,"mouseOver");o(this,"entities",[]);o(this,"schedule",[]);o(this,"viewWidth");o(this,"viewHeight");o(this,"interval");o(this,"renderer");o(this,"ui");o(this,"users");o(this,"servers");o(this,"server");o(this,"world");o(this,"timeUpdates");o(this,"timeRenders");o(this,"showGrid");o(this,"helpPanel");o(this,"helpButton");o(this,"serverListPanel");o(this,"pendingServerJoin");o(this,"decorator");o(this,"hideZ");this.setMaxListeners(0),this.step=e.step||1e3/60,this.input=new Pe,this.input.on("keydown",this.keydown.bind(this)),this.input.on("keyup",this.keyup.bind(this));let t=this;this.interval=setInterval(function(){if(t.crashed)return;let s=Yt();if(t.dt+=s-t.lastUpdate,t.lastUpdate>0&&t.dt>6e4&&(m.error("Game engine: Too many updates missed, crashing",{deltaTime:t.dt,lastUpdate:t.lastUpdate,currentTime:s}),t.crashed=!0,t.paused=!0),t.dt>t.step)for(;t.dt>=t.step;)t.dt-=t.step,!t.paused&&(t.ticks++,t.update());t.lastUpdate=Yt()},this.step)}update(){let e=this.timeUpdates&&(this.ticks&255)===0;e&&console.time("update"),this.emit("update");for(let t=0;t<this.schedule.length;t++){let s=this.schedule[t],r;if(s.type==="repeat"){if(r=s.start+s.count,s.start<=this.ticks){let a=this.ticks-s.start,h=s.count>0?a/s.count:1;if(!isFinite(h)){m.error("Game update: Invalid progress calculation",{ticks:a,taskCount:s.count,taskStart:s.start,gameTicks:this.ticks,percent:h}),s.type="deleted";continue}s.cb({ticks:a,percent:h})}}else s.type==="once"&&(r=s.tick);(s.type==="deleted"||r!==void 0&&r<=this.ticks)&&(s.type==="once"?s.cb():s.type==="repeat"&&s.afterCB&&s.afterCB(),this.schedule.splice(t,1),t--)}this.emit("render"),e&&console.timeEnd("update")}bindCanvas(e){this.input.bindCanvas(e),this.viewWidth=e.width,this.viewHeight=e.height,this.input.on("mousemove",this.mousemove.bind(this)),this.input.on("mousedown",this.mousedown.bind(this)),this.input.on("mouseup",this.mouseup.bind(this)),this.input.on("mouseout",this.mouseout.bind(this)),this.input.on("mouseover",this.mouseover.bind(this)),this.input.on("mousewheel",this.mousewheel.bind(this)),this.input.on("touchmove",this.touchmove.bind(this)),this.input.on("touchstart",this.touchstart.bind(this)),this.input.on("touchend",this.touchend.bind(this)),this.input.on("touchcancel",this.touchcancel.bind(this)),e.on("resize",this.viewResize.bind(this))}viewResize(e){this.viewWidth=e.width,this.viewHeight=e.height,this.input.mouseScale=e.scale,m.canvasResize(e.width,e.height),this.emit("resize",e)}mousemove(e){this.mouseOut||(this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("mousemove",e))}mousedown(e){this.mouseOver&&(m.debug("Game mousedown: Target selected",{target:this.mouseOver.constructor?.name||"unknown",position:this.mouseOver.position||null}),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("mousedown",e)}touchend(e){H.findAndRemove(e.button,this.mouseButtons),this.emit("touchend",e)}touchmove(e){this.mouseOut||(this.mouseOut=!1,this.mouseX=e.x,this.mouseY=e.y,this.centerMouseX=Math.floor(e.x-(this.viewWidth||0)/2),this.centerMouseY=Math.floor(e.y-(this.viewHeight||0)/2),e.centerMouseX=this.centerMouseX,e.centerMouseY=this.centerMouseY,this.emit("touchmove",e))}touchcancel(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("touchcancel",e)}touchstart(e){this.mouseOver&&(m.debug("Game touchstart: Target selected",{target:this.mouseOver.constructor?.name||"unknown",position:this.mouseOver.position||null}),window.actor=this.mouseOver),this.mouseButtons.push(e.button),this.emit("touchstart",e)}mouseup(e){H.findAndRemove(e.button,this.mouseButtons),this.emit("mouseup",e)}mouseout(e){this.mouseOut=!0,this.mouseOver=!1,this.emit("mouseout",e)}mouseover(e){this.mouseOut=!1,this.emit("mouseover",e)}mousewheel(e){this.emit("mousewheel",e)}keydown(e){this.emit("keydown",e)}keyup(e){this.emit("keyup",e)}reset(){for(this.emit("destroy"),this.removeAllListeners("update"),this.schedule=[];this.entities.length>0;)this.entities[0].remove?this.entities[0].remove():this.entities.splice(0,1)}},Zt=tt;W();var it=["actors","environment","static-tiles","props","font"],st=class{constructor(i){o(this,"images",{});o(this,"imagesLoaded",0);o(this,"onComplete");this.onComplete=i;for(let e=0;e<it.length;e++){let t=it[e],s=t+".png",r=new Image;r.addEventListener("load",()=>this.onImageLoad(r,t)),r.src="./img/"+s}}onImageLoad(i,e){let t=new E(i.width,i.height);this.images[e]=t.canvas,t.drawImage(i,0,0,i.width,i.height,0,0,i.width,i.height),this.imagesLoaded++,this.imagesLoaded===it.length&&this.onComplete(this.images)}},Jt=st;var Vt=D(I(),1);function cs(n,i){let e=document.createElement("canvas");e.width=n.width,e.height=n.height;let t=e.getContext("2d",{willReadFrequently:!0});t.drawImage(n,0,0);let s=t.getImageData(0,0,e.width,e.height),r=i.getContext("2d",{willReadFrequently:!0}),a=r.getImageData(0,0,i.width,i.height);for(let h=3;h<a.data.length;h+=4)a.data[h]=s.data[h];r.putImageData(a,0,0)}var qt={colorize:function(n){let i=document.createElement("canvas");i.width=n.image.width,i.height=n.image.height;let e=i.getContext("2d",{willReadFrequently:!0});e.drawImage(n.image,0,0,n.image.width,n.image.height,0,0,n.image.width,n.image.height),e.globalCompositeOperation="color";let t=document.createElement("canvas");t.width=n.image.width,t.height=n.image.height;let s=t.getContext("2d");if(s.fillStyle=n.color,s.globalAlpha=n.alpha,s.fillRect(0,0,n.image.width,n.image.height),n.regions)for(let r=0;r<n.regions.length;r++){let a=n.regions[r];s.clearRect(a.x,a.y,a.w,a.h),s.fillStyle=a.color?a.color:n.color,s.globalAlpha=a.alpha?a.alpha:n.alpha,s.fillRect(a.x,a.y,a.w,a.h)}return e.drawImage(t,0,0),cs(n.image,i),i},interpolateRGBA:function(n,i,e){let t=n.substring(5,n.length-2).split(","),s=+t[0],r=+t[1],a=+t[2],h=+t[3],l=i.substring(5,i.length-2).split(","),c=+l[0],u=+l[1],d=+l[2],p=+l[3];return"rgba("+[Math.round(s+(c-s)*e),Math.round(r+(u-r)*e),Math.round(a+(d-a)*e),h+(p-h)*e].join(",")+")"}};L();var nt=class extends Vt.EventEmitter{constructor(e){super();o(this,"game");o(this,"images");o(this,"updateDrawn",!1);o(this,"zBuffer",{});o(this,"zBufferKeys",[]);o(this,"overlay",[]);o(this,"frames",0);o(this,"canvases");o(this,"bgCanvas");this.game=e.game,this.images=e.images;let t=this;this.game.on("render",function(){t.updateDrawn=!1});let s=()=>{if(t.updateDrawn===!1){if(t.canvases){let r=t.game.timeRenders&&(t.game.ticks&511)===0;r&&console.time("render");for(let a=0;a<t.canvases.length;a++){let h=t.canvases[a];h.canvas.fill(h.backgroundColor),t.bgCanvas&&h.drawBG(t.bgCanvas),t.game.servers||(h.context.fillStyle="#d4cfb6",h.context.font="14px Arial",h.context.textAlign="center",h.context.fillText("connecting...",Math.round(h.width/2),Math.round(h.height/2-4)));let l=0;for(let c=0;c<t.zBufferKeys.length;c++){let u=t.zBuffer[t.zBufferKeys[c]];for(let d=0;d<u.length;d++)h.drawEntity(u[d]),l++}for(let c=0;c<t.overlay.length;c++)h.drawEntity(t.overlay[c]),l++;t.game.ui&&t.game.ui.emit("draw",h)}r&&console.timeEnd("render")}t.updateDrawn=!0}requestAnimationFrame(s)};requestAnimationFrame(s)}addCanvas(e){e.setRenderer(this),this.canvases||(this.canvases=[]),this.canvases.push(e)}addToZBuffer(e,t){let s=this.zBuffer[t];s?(s.push(e),s.sort((r,a)=>{let h=(r.position?.z||0)+(r.position?.fakeZ||0),l=(a.position?.z||0)+(a.position?.fakeZ||0);return h-l})):this.zBuffer[t]=[e],this.zBufferKeys=Object.keys(this.zBuffer),this.zBufferKeys.sort((r,a)=>parseInt(r)-parseInt(a))}updateZBuffer(e,t,s){this.removeFromZBuffer(t,e),this.addToZBuffer(t,s)}removeFromZBuffer(e,t){let s=this.zBuffer[t];if(s){for(let r=0;r<s.length;r++)if(s[r]===e){s.splice(r,1);break}}}addColorSheet(e){if(this.images[e.color]||(this.images[e.color]={}),!this.images[e.color][e.sheet]){if(e.image=this.images[e.sheet],!e.image){m.error("Renderer addColorSheet: Base image not found",{requestedSheet:e.sheet,availableImages:Object.keys(this.images)});return}this.images[e.color][e.sheet]=qt.colorize(e)}}clear(){this.zBuffer={},this.zBufferKeys=[],this.overlay=[]}},Qt=nt;var ci=D(I(),1);L();W();q();C();var ri,oi,ai,hi,ls=new E(200,100),Y,de=class extends ci.EventEmitter{constructor(e,t){super();o(this,"game");o(this,"worldSize");o(this,"worldRadius");o(this,"objects",{});o(this,"map",{});o(this,"walkable",{});o(this,"mapBounds",{xl:0,yl:0,xh:0,yh:0});o(this,"staticMap",[]);o(this,"islands",[]);o(this,"mainIsland",0);o(this,"tileMap",{});o(this,"initializationPromise");this.game=e,this.game.world=this,this.worldSize=Math.max(24,Math.floor(t/2)*2),this.worldRadius=Math.floor(this.worldSize/2),this.initializationPromise=this.init()}async init(){try{let[e,t,s,r]=await Promise.all([Promise.resolve().then(()=>(ti(),ei)),Promise.resolve().then(()=>(ni(),si)),Promise.resolve().then(()=>(rt(),ii)),Promise.resolve().then(()=>(Je(),Bt))]);ri=e.default,oi=t.default,ai=s.default,hi=r.default,this.generateWorld()}catch(e){throw m.error("World: Failed to load world dependencies",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0}),e}}generateWorld(){O.generateClosestGrids(this.worldSize),ls.clear();let e=O.buildNoiseMap(this.worldRadius/3+1,this.worldRadius/3+1),t=O.buildNoiseMap(this.worldRadius/1.5+1,this.worldRadius/1.5+1),s=(e.length-1)/this.worldSize,r=(t.length-1)/this.worldSize;this.mapBounds={xl:0,yl:0,xh:0,yh:0};for(let h=0;h<this.worldSize;h++)for(let l=0;l<this.worldSize;l++){let c=O.getNoiseMapPoint(e,h*s,l*s),u=O.getNoiseMapPoint(t,h*r,l*r),d=(c+u*2)/3,p=h-this.worldRadius,g=l-this.worldRadius,M=(this.worldRadius-(Math.abs(p)+Math.abs(g))/2)/this.worldRadius;if(d/1.1<M){this.mapBounds.xl=Math.min(p,this.mapBounds.xl),this.mapBounds.yl=Math.min(g,this.mapBounds.yl),this.mapBounds.xh=Math.max(p,this.mapBounds.xh),this.mapBounds.yh=Math.max(g,this.mapBounds.yh);let v=new ri("grass",p,g,-.5);v.grid=p+":"+g,this.map[p+":"+g]=v,v.addToGame(this.game)}}m.info("World: Generated slab tiles",{tileCount:Object.keys(this.map).length}),this.staticMap=[],this.crawlMap(),this.createTiles(),this.createBackground(),hi.loadMap(this.walkable),Y=Object.keys(this.map);let a=Y.indexOf("0:0");a>-1&&Y.splice(a,1),m.worldGenerated({totalTiles:Object.keys(this.map).length,spawnablePositions:Y.length,worldSize:this.worldSize,worldRadius:this.worldRadius,mapBounds:this.mapBounds,mainIslandSize:this.islands[this.mainIsland]?.length||0,totalIslands:this.islands.length,spawnPositions:Y.slice(0,10)}),m.info("World: Created world",{tileCount:Object.keys(this.map).length})}createBackground(){m.debug("World: Creating background",{staticMapCount:this.staticMap.length});let e=0,t=0,s=0,r=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y};u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,e=e<u.x?e:u.x,t=t<u.y?t:u.y,s=s>u.x?s:u.x,r=r>u.y?r:u.y}m.debug("World: Calculated screen bounds",{lowestScreenX:e,lowestScreenY:t,highestScreenX:s,highestScreenY:r});let a=new E(s-e+32+1,r-t+32+9),h=0;for(let l=0;l<this.staticMap.length;l++){let c=this.staticMap[l],u={x:c.screen.x,y:c.screen.y},d=!isFinite(c.screen.x)||!isFinite(c.screen.y)||!isFinite(c.sprite.metrics.ox||0)||!isFinite(c.sprite.metrics.oy||0);if((l<3||d)&&m.debug("World: Background tile data",{tileIndex:l,tileScreen:c.screen,spriteMetrics:c.sprite.metrics,screenBeforeOffset:{x:u.x,y:u.y},hasNaN:d}),u.x+=c.sprite.metrics.ox||0,u.y+=c.sprite.metrics.oy||0,u.x-=e,u.y-=t,!isFinite(u.x)||!isFinite(u.y)){m.error("World: NaN detected in background tile",{tileIndex:l,originalScreen:{x:c.screen.x,y:c.screen.y},spriteOffsetX:c.sprite.metrics.ox,spriteOffsetY:c.sprite.metrics.oy,lowestScreenX:e,lowestScreenY:t,finalScreen:u});continue}let p=this.game.renderer.images[c.sprite.image];if(!p){m.error("World: Missing image for background tile",{tileImage:c.sprite.image,tileIndex:l});continue}a.drawImage(p,c.sprite.metrics.x,c.sprite.metrics.y,c.sprite.metrics.w,c.sprite.metrics.h,Math.round(u.x),Math.round(u.y),c.sprite.metrics.w,c.sprite.metrics.h),h++,l<5&&m.debug("World: Drew background tile",{tileIndex:l,image:c.sprite.image,sourceRect:`${c.sprite.metrics.x},${c.sprite.metrics.y} ${c.sprite.metrics.w}x${c.sprite.metrics.h}`,destPos:`${Math.round(u.x)},${Math.round(u.y)}`})}this.game.renderer.bgCanvas={x:e,y:t,image:a.canvas}}crawlMap(){this.islands=[];let e={},t=0;for(let s=this.mapBounds.xl;s<=this.mapBounds.xh;s++)for(let r=this.mapBounds.yl;r<=this.mapBounds.yh;r++){let a=this.map[s+":"+r];if(!a||e[a.grid])continue;let h=[];for(;;){e[a.grid]=a,this.islands[t]?this.islands[t].push(a):this.islands.push([a]);let l=O.getNeighbors(a.grid);for(let c in l){if(!l.hasOwnProperty(c))continue;let u=this.map[l[c]];if(!u){a.border=!0;continue}e[u.grid]||h.push(u)}if(h.length>0)a=h.pop();else{t++;break}}}this.mainIsland=0;for(let s=1;s<this.islands.length;s++)this.mainIsland=this.islands[s].length>this.islands[this.mainIsland].length?s:this.mainIsland;for(let s=0;s<this.islands.length;s++)if(s!=this.mainIsland)for(let r=0;r<this.islands[s].length;r++)delete this.map[this.islands[s][r].grid],this.islands[s][r].remove();for(let s in this.map){if(!this.map.hasOwnProperty(s))continue;let r=this.map[s];if(r.border)r.style="plain";else{let a=O.get8Neighbors(r.grid);for(let h in a)if(a.hasOwnProperty(h)&&!this.map[a[h]]){r.style="plain";break}}}this.map["0:0"]&&(this.map["0:0"].style="plain"),this.map["1:0"]&&(this.map["1:0"].style="plain"),this.map["-1:0"]&&(this.map["-1:0"].style="plain"),this.map["0:1"]&&(this.map["0:1"].style="plain"),this.map["0:-1"]&&(this.map["0:-1"].style="plain"),this.createFlowerPatches()}createFlowerPatches(){for(let e=0;e<Math.ceil(Math.pow(this.worldRadius,2)/80);e++){let t=0,s,r;do{if(r=!0,s=this.map[b.pickInObject(this.map)],!s)continue;let h=O.get8Neighbors(s.grid);for(let l in h){if(!h.hasOwnProperty(l))continue;let c=this.map[h[l]];if(!c||c.style!="grass"){r=!1;break}}t++}while(t<1e3&&(s.style!="grass"||!r));if(t==1e3)continue;s.style="flowers";let a=b.randomIntRange(1,4);for(let h=0;h<a;h++){let l=!0,c=s.position.x+b.randomIntRange(-1,1),u=s.position.y+b.randomIntRange(-1,1),d=this.map[c+":"+u];if(!d)continue;let p=O.get8Neighbors(d.grid);for(let g in p){if(!p.hasOwnProperty(g))continue;let M=this.map[p[g]];if(!M||M.style!="grass"&&M.style!="flowers"){l=!1;break}}l&&(d.style="flowers")}}}createTiles(){this.tileMap={};let e=this;function t(a){return e.map[a].style[0].replace(/p/,"s").toUpperCase()}function s(a,h){return a==h?t(a):e.map[h]?t(h):"E"}function r(a,h,l,c){let u=h.grids,d=s(a,u[0])+"-"+s(a,u[1])+"-"+s(a,u[2])+"-"+s(a,u[3]);return new ai("tile").map[d]||m.error("World: Unknown tile code",{tileCode:d,neighborGrids:u,originalGrid:a}),{tileCode:d,position:h,grid:l,game:c}}for(let a in this.map){if(!this.map.hasOwnProperty(a))continue;let h=+a.split(":")[0],l=+a.split(":")[1],c=this.map[a].position.z,u=O.get8Neighbors(a),d={x:h-.5,y:l-.5,z:c,grids:[u.nw,u.n,a,u.w]},p={x:h+.5,y:l-.5,z:c,grids:[u.n,u.ne,u.e,a]},g={x:h+.5,y:l+.5,z:c,grids:[a,u.e,u.se,u.s]},M={x:h-.5,y:l+.5,z:c,grids:[u.w,a,u.s,u.sw]},v=[d,p,g,M];for(let S=0;S<v.length;S++){let w=c+":"+v[S].x+":"+v[S].y;this.tileMap[w]||(this.tileMap[w]=new oi(r(a,v[S],w,this.game)),this.staticMap.push(this.tileMap[w]))}}this.staticMap.sort(function(a,h){return a.zDepth-h.zDepth}),this.logValidSpawnPositions()}logValidSpawnPositions(){let e=[],t=[];for(let s in this.map){if(!this.map.hasOwnProperty(s))continue;let r=this.map[s],a=r.position.x,h=r.position.y;if(a===0&&h===0){t.push(`${a}:${h} (beacon)`);continue}r.style==="grass"||r.style==="plain"||r.style==="flowers"?e.push(`${a}:${h}`):t.push(`${a}:${h} (${r.style})`)}m.worldSpawnAnalysis({totalPositions:Object.keys(this.map).length,validSpawnPositions:e.length,invalidSpawnPositions:t.length,validPositions:e,invalidPositions:t})}addToWorld(e){if(this.objects[e.position.x])if(this.objects[e.position.x][e.position.y]){if(this.objects[e.position.x][e.position.y][e.position.z])return m.error("World: Position occupied",{position:e.position,newObject:e.constructor?.name||"unknown",existingObject:this.objects[e.position.x][e.position.y][e.position.z].constructor?.name||"unknown"}),!1}else this.objects[e.position.x][e.position.y]={};else this.objects[e.position.x]={},this.objects[e.position.x][e.position.y]={};return this.objects[e.position.x][e.position.y][e.position.z]=e,this.updateWalkable(e.position.x,e.position.y),!0}removeFromWorld(e){this.objects[e.position.x]?.[e.position.y]?.[e.position.z]&&(delete this.objects[e.position.x][e.position.y][e.position.z],this.updateWalkable(e.position.x,e.position.y))}moveObject(e,t,s,r){this.removeFromWorld(e),e.position.x=t,e.position.y=s,e.position.z=r,this.addToWorld(e)}updateWalkable(e,t){let s=this.objects[e]?.[t];if(!s||Object.keys(s).length==0){delete this.walkable[e+":"+t];return}let r=Object.keys(s).sort(function(h,l){return+h-+l}),a=s[+r[r.length-1]];if(a.unWalkable)delete this.walkable[e+":"+t];else{let h=a.position.z+a.height;this.walkable[e+":"+t]=h}}canWalk(e,t){if(!this.map[e+":"+t])return!1;let r=this.walkable[e+":"+t],a=this.objects[e]?.[t];if(!a||Object.keys(a).length===0)return!0;let h=Object.keys(a).sort((u,d)=>+u-+d);return!a[+h[h.length-1]].unWalkable}getHeight(e,t){let s=this.walkable[e+":"+t];if(s!==void 0)return s;let r=this.map[e+":"+t];return r?r.position.z+r.height:-.5}randomEmptyGrid(){return Y.splice(b.randomIntRange(0,Y.length-1),1)[0]}objectAtXYZ(e,t,s){return this.objects[e]?.[t]?.[s]||null}objectUnderXYZ(e,t,s){let r=this.objects[e]?.[t];if(!r)return null;let a=-1e3;for(let h in r)r.hasOwnProperty(h)&&(+h>s||(a=+h>a?+h:a));return r[a]||null}findObject(e){for(let t in this.objects){if(!this.objects.hasOwnProperty(t))continue;let s=this.objects[t];for(let r in s){if(!s.hasOwnProperty(r))continue;let a=s[r];for(let h in a)if(a.hasOwnProperty(h)&&e===a[h])return[t,r,h]}}return null}};var fi=D(I(),1);L();q();var at,ht,me=class extends fi.EventEmitter{constructor(e,t){super();o(this,"game");o(this,"world");o(this,"beacon");this.game=e,this.world=t,this.game.decorator=this,this.init()}async init(){try{let[e,t]=await Promise.all([Promise.resolve().then(()=>(li(),ui)),Promise.resolve().then(()=>(mi(),di))]);at=e.default,ht=t.default,this.createBeacon()}catch(e){throw m.error("Decorator: Failed to load dependencies",{error:e instanceof Error?e.message:String(e)}),e}}sewSeed(e){if(!ht){m.error("Decorator: Seed class not loaded yet");return}let t;for(let r=0;r<O.closestGrids.length;r++){let a=O.closestGrids[r],h=this.world.map[e.origin.x+a[0]+":"+(e.origin.y+a[1])];if(!(!h||h.style=="plain")&&!this.world.objectAtXYZ(h.position.x,h.position.y,h.position.z+h.height)){t=h.position;break}}if(!t)return;new ht({origin:e.origin,destination:{x:t.x,y:t.y,z:t.z+.5}}).addToGame(this.game)}createBeacon(){if(!at){m.error("Decorator: Beacon class not loaded yet");return}this.beacon=new at(0,0,0),this.beacon.addToGame(this.game)}};var pi=D(I(),1);W();Q();var gi=D(I(),1);W();C();var N=class extends gi.EventEmitter{constructor(e){super();o(this,"ui");o(this,"parent");o(this,"elements");o(this,"w");o(this,"h");o(this,"autosize");o(this,"top");o(this,"bottom");o(this,"left");o(this,"right");o(this,"x",0);o(this,"y",0);o(this,"canvas");this.ui=e.ui,this.parent=e.parent,this.elements=[],this.w=1,this.h=1,e.w!==void 0?this.w=e.w:this.autosize=!0,e.h!==void 0?this.h=e.h:this.autosize=!0,e.top!==void 0&&(this.top=e.top),e.bottom!==void 0&&(this.bottom=e.bottom),e.left!==void 0&&(this.left=e.left),e.right!==void 0&&(this.right=e.right),this.canvas=new E(this.w||1,this.h||1),this.reposition()}reposition(){if(!(!this.parent||typeof this.parent.x!="number"||typeof this.parent.y!="number"||typeof this.parent.w!="number"||typeof this.parent.h!="number")&&(this.top!==void 0&&(this.top=="auto"?this.y=Math.round(this.parent.y+this.parent.h/2-this.h/2):this.y=this.parent.y+this.top),this.bottom!==void 0&&(this.y=this.parent.y+this.parent.h-this.h-this.bottom),this.left!==void 0&&(this.left=="auto"?this.x=Math.round(this.parent.x+this.parent.w/2-this.w/2):this.x=this.parent.x+this.left),this.right!==void 0&&(this.x=this.parent.x+this.parent.w-this.w-this.right),this.elements))for(let e=0;e<this.elements.length;e++)this.elements[e].reposition()}redraw(e){e.drawImage(this.canvas.canvas||this.canvas,0,0,this.w,this.h,this.x,this.y,this.w,this.h)}remove(){if(this.ui.mouseOnElement===this&&(this.ui.mouseOnElement=!1),this.removeAllListeners("redraw"),this.removeAllListeners("mouse-on-element"),this.removeAllListeners("mouse-off-element"),b.findAndRemove(this,this.ui.elements),this.elements)for(let e=0;e<this.elements.length;e++)this.elements[e].remove();this.ui.redraw()}resize(e,t){this.w=this.canvas.canvas.width=e,this.h=this.canvas.canvas.height=t,this.draw&&this.draw()}resizeChildren(e,t){if(this.elements)for(let s=0;s<this.elements.length;s++)this.elements[s].resize(e,t)}};Q();var fe=class extends N{constructor(e){super(e);o(this,"text");o(this,"textCanvas");o(this,"onPress");o(this,"disabled");o(this,"mouseOn");o(this,"pressed");o(this,"onMouseOnBound");o(this,"onMouseOffBound");o(this,"onMouseDownBound");o(this,"onMouseUpBound");e.text&&this.changeText(e.text),e.onPress&&(this.onPress=e.onPress),e.disabled&&(this.disabled=!0),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=T.blot({text:this.text}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2);let e="rgba("+(this.mouseOn?"77,102,184,0.9)":this.disabled?"245,240,213,0.3)":"0,0,0,0.8)");if(this.canvas.fillRect(e,1,1,this.w-2,this.h-2),this.textCanvas){let t=Math.floor((this.canvas.canvas.width-this.textCanvas.width)/2);this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,t,1,this.textCanvas.width,this.textCanvas.height)}this.emit("redraw")}onMouseOn(e){this.disabled||this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.disabled||!this.mouseOn||(this.mouseOn=!1,this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.disabled||!this.mouseOn||(this.pressed=!0,this.draw())}onMouseUp(e){this.disabled||!this.mouseOn||(this.pressed=!1,this.onPress&&this.onPress(),this.draw())}};var ge=class extends N{constructor(i){super(i),this.draw()}draw(){this.canvas.clear(),this.canvas.fillRect("rgba(255,255,255,0.8)",0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.emit("redraw")}};Q();C();var pe=class extends N{constructor(e){super(e);o(this,"text","");o(this,"textCanvas");o(this,"onSubmit");o(this,"focused");o(this,"mouseOn");o(this,"onMouseOnBound");o(this,"onMouseOffBound");o(this,"onMouseDownBound");o(this,"onMouseUpBound");o(this,"onKeyDownBound");this.changeText(e.text||""),e.onSubmit&&(this.onSubmit=e.onSubmit),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound),this.onKeyDownBound=this.onKeyDown.bind(this),this.on("key-down",this.onKeyDownBound)}changeText(e){this.text=e;let t=e+(this.focused?"_":"");this.textCanvas=T.blot({text:t}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width+2,this.h=this.canvas.canvas.height=this.textCanvas.height+2),this.draw()}draw(){this.canvas.clear();let e=this.mouseOn?"rgba(220,220,220,0.8)":"rgba(255,255,255,0.8)";e=this.focused?"rgba(115,138,215,0.8)":e,this.canvas.fillRect(e,0,0,this.w,this.h),this.canvas.clearRect(1,1,this.w-2,this.h-2),this.canvas.fillRect("rgba(0,0,0,0.8)",1,1,this.w-2,this.h-2),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,1,1,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}focus(e){this.focused=e!==!1,this.changeText(this.text)}submit(){this.onSubmit&&this.onSubmit(this.text)}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn||this.focus(!1)}onMouseUp(e){this.mouseOn&&this.focus()}onKeyDown(e){if(!this.focused)return;e.key=="enter"&&this.submit();let t=e.key;if(e.key=="backspace")this.changeText(this.text.substring(0,Math.max(0,this.text.length-1)));else{if(e.key=="period"&&(t="."),e.key=="dash"&&(t="-"),t!="."&&t!="-"&&b.alphabet.indexOf(t)<0&&b.hex.indexOf(t)<0)return;this.changeText(this.text+(this.ui.game.input.keys.shift?t.toUpperCase():t))}}};Q();var be=class extends N{constructor(e){super(e);o(this,"text");o(this,"textCanvas");o(this,"onPress");o(this,"hyperlink");o(this,"maxWidth");o(this,"mouseOn");o(this,"pressed");o(this,"onMouseOnBound");o(this,"onMouseOffBound");o(this,"onMouseDownBound");o(this,"onMouseUpBound");e.onPress&&(this.onPress=e.onPress),e.hyperlink&&(this.hyperlink=e.hyperlink),e.maxWidth&&(this.maxWidth=e.maxWidth),e.text&&this.changeText(e.text),this.onMouseOnBound=this.onMouseOn.bind(this),this.on("mouse-on",this.onMouseOnBound),this.onMouseOffBound=this.onMouseOff.bind(this),this.on("mouse-off",this.onMouseOffBound),this.onMouseDownBound=this.onMouseDown.bind(this),this.on("mouse-down",this.onMouseDownBound),this.onMouseUpBound=this.onMouseUp.bind(this),this.on("mouse-up",this.onMouseUpBound)}changeText(e){this.text=e,this.textCanvas=T.blot({text:this.text,maxWidth:this.maxWidth}),this.autosize&&(this.w=this.canvas.canvas.width=this.textCanvas.width,this.h=this.canvas.canvas.height=this.textCanvas.height),this.reposition(),this.draw()}draw(){this.canvas.clear(),this.textCanvas&&this.canvas.drawImage(this.textCanvas,0,0,this.textCanvas.width,this.textCanvas.height,0,0,this.textCanvas.width,this.textCanvas.height),this.emit("redraw")}onMouseOn(e){this.mouseOn||(this.mouseOn=!0,this.hyperlink&&(document.body.style.cursor="pointer"),this.emit("mouse-on-element",this),this.draw())}onMouseOff(e){this.mouseOn&&(this.mouseOn=!1,this.hyperlink&&(document.body.style.cursor="default"),this.pressed=!1,this.emit("mouse-off-element",this),this.draw())}onMouseDown(e){this.mouseOn&&(this.pressed=!0,this.draw())}onMouseUp(e){this.mouseOn&&(this.pressed=!1,this.onPress&&this.onPress(),this.hyperlink&&this.hyperlink!=="#"&&this.hyperlink!=="javascript:void(0)"&&window.open(this.hyperlink),this.draw())}};var ve=class extends pi.EventEmitter{constructor(e){super();o(this,"game");o(this,"elements",[]);o(this,"x",0);o(this,"y",0);o(this,"w");o(this,"h");o(this,"canvas");o(this,"mouseOnElement",!1);o(this,"boundRedraw");o(this,"boundOnMouseOnElement");o(this,"boundOnMouseOffElement");this.game=e,this.game.renderer?.images?.font&&T.loadImage(this.game.renderer.images.font),this.game.on("resize",this.onResize.bind(this)),this.game.on("mousemove",this.onMouseMove.bind(this)),this.game.on("mousedown",this.onMouseDown.bind(this)),this.game.on("mouseup",this.onMouseUp.bind(this)),this.game.on("keydown",this.onKeyDown.bind(this)),this.game.on("keyup",this.onKeyUp.bind(this)),this.elements=[],this.x=0,this.y=0,this.w=1,this.h=1,this.canvas=new E(1,1);let t=this;this.on("draw",function(s){s.drawStatic(t.canvas.canvas)}),this.boundRedraw=this.redraw.bind(this),this.boundOnMouseOnElement=this.onMouseOnElement.bind(this),this.boundOnMouseOffElement=this.onMouseOffElement.bind(this)}addButton(e){e.parent||(e.parent=this),e.ui=this;let t=new fe(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addPanel(e){e.parent||(e.parent=this),e.ui=this;let t=new ge(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t}addInput(e){e.parent||(e.parent=this),e.ui=this;let t=new pe(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}addLabel(e){e.parent||(e.parent=this),e.ui=this;let t=new be(e);return e.parent.elements.push(t),e.parent!==this&&this.elements.push(t),t.on("redraw",this.boundRedraw),t.on("mouse-on-element",this.boundOnMouseOnElement),t.on("mouse-off-element",this.boundOnMouseOffElement),t}redraw(){this.canvas.clear();for(let e=0;e<this.elements.length;e++)this.elements[e].redraw(this.canvas)}onMouseMove(e){if(!(this.game.mouseButtons.length>0))for(let t=0;t<this.elements.length;t++){let s=this.elements[t];e.x>=s.x&&e.x<s.x+s.w&&e.y>=s.y&&e.y<s.y+s.h?s.emit("mouse-on",e):s.emit("mouse-off",e)}}onMouseDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-down",e)}onMouseUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("mouse-up",e)}onKeyDown(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-down",e)}onKeyUp(e){for(let t=0;t<this.elements.length;t++)this.elements[t].emit("key-up",e)}onMouseOnElement(e){this.mouseOnElement=e,this.game.mouseOver=!1}onMouseOffElement(e){this.mouseOnElement=this.mouseOnElement===e?!1:this.mouseOnElement}onResize(e){this.w=e.width,this.h=e.height,this.canvas.canvas.width=this.w,this.canvas.canvas.height=this.h;for(let t=0;t<this.elements.length;t++)this.elements[t].reposition();this.redraw()}};var ne={name:"d-zone",version:"0.1.0",description:"An ambient life simulation driven by the user activity within a Discord server",type:"module",main:"index.ts",exports:{".":"./index.ts"},dependencies:{express:"^5.1.0",inherits:"^2.0.4",pino:"^10.0.0",raf:"^3.4.1",ws:"^8.13.0"},devDependencies:{"@playwright/test":"^1.40.0","@types/express":"^4.17.23","@types/node":"^20.19.17","@types/pino":"^7.0.4","@types/ws":"^8.18.1","@vitest/ui":"^1.6.0","allure-commandline":"^2.24.1","allure-playwright":"^2.9.2","allure-vitest":"^2.15.1",concurrently:"^9.2.1",esbuild:"^0.25.10",events:"^3.3.0",jsdom:"^24.0.0",msw:"^2.0.0","ts-node":"^10.9.2",typescript:"^5.9.2",vitest:"^1.6.0"},scripts:{"build:dev":"esbuild src/main.ts --bundle --sourcemap --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path","build:prod":"esbuild src/main.ts --bundle --minify --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path",dev:'concurrently "npm run watch" "npm start"',prestart:"npm run build:dev",start:"node server.mjs","start:ts":"ts-node --esm index.ts",test:"vitest run && playwright test","test:unit":"vitest run","test:unit:watch":"vitest","test:unit:ui":"vitest --ui","test:e2e":"playwright test","test:e2e:headed":"playwright test --headed","test:e2e:debug":"playwright test --debug","test:ci":"npm run test -- --project=ci","test:report":"allure generate --clean && allure open","test:report:generate":"allure generate --clean","type-check":"tsc --noEmit",watch:"esbuild src/main.ts --bundle --sourcemap --outfile=dist/static/bundle.js --format=iife --platform=browser --target=es2020 --define:global=window --external:fs --external:path --watch"},repository:{type:"git",url:"git+https://github.com/NNTin/d-zone.git"},keywords:["discord","Discord","isometric","canvas"],author:"Tin Nguyen",contributors:["Devin Spikowski (https://github.com/vegeta897)"],license:"ISC",bugs:{url:"https://github.com/NNTin/d-zone/issues"},homepage:"https://nntin.github.io/d-zone"};var vi,fs,f,re,y;function gs(n){m.info("Initializing game with images",{imageCount:Object.keys(n).length,imageNames:Object.keys(n)}),f=new Zt({step:1e3/60}),f.renderer=new Qt({game:f,images:n});let i=new Xt({id:"main",game:f,initialScale:2,backgroundColor:"#181213"});f.renderer.addCanvas(i),f.bindCanvas(i),f.ui=new ve(f),ps(),bs(),f.renderer.canvases[0].onResize(),vs(),window.pause=function(){f.paused=!0},window.unpause=function(){f.paused=!1},window.game=f;let e=!1;f.on("render",()=>{e||(e=!0,m.initialDraw())}),m.gameInitialized({width:i.width,height:i.height,version:ne.version})}function bi(n){m.info("Reinitializing Discord OAuth with new client ID",{newClientId:n});let i=y&&y.isLoggedIn(),e=y?y.getUser():null,t=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";y=new Qe({clientId:n,redirectUri:t,scopes:["identify"]}),yi(),i&&e&&m.warn("Discord OAuth client ID updated - user may need to re-authenticate",{currentUser:e?.username}),m.info("Discord OAuth reinitialized successfully")}function yi(){let n=y.login;y.login=function(){let i=this.getAuthUrl();return m.debug("Discord OAuth URL generated",{authUrl:i}),m.discordLoginAttempt(),n.call(this)},y.on("login-success",function(i){m.discordLoginSuccess(i.username),localStorage.setItem("discord_user",JSON.stringify(i)),f.pendingServerJoin&&(oe(f.pendingServerJoin),delete f.pendingServerJoin),f.helpPanel&&(f.helpPanel.remove(),delete f.helpPanel,setTimeout(function(){f.helpButton&&f.helpButton.onPress&&f.helpButton.onPress()},100))}),y.on("login-error",function(i){m.discordLoginError(i),window.alert("Discord login failed: "+i)}),y.on("login-cancelled",function(){m.info("Discord login cancelled by user")}),y.on("logout",function(){m.discordLogout(),f.helpPanel&&(f.helpPanel.remove(),delete f.helpPanel,setTimeout(function(){f.helpButton&&f.helpButton.onPress&&f.helpButton.onPress()},100))})}function ps(){let n=window.location.origin+window.location.pathname.replace("index.html","")+"discord-callback.html";m.debug("Discord OAuth initialization",{redirectUri:n,currentLocation:window.location.href,origin:window.location.origin,pathname:window.location.pathname}),fetch(n).then(function(i){m.debug("Discord callback page test",{status:i.status,accessible:i.ok}),i.ok?m.debug("\u2713 Discord callback page is accessible"):m.error("\u2717 Discord callback page not accessible",{status:i.status})}).catch(function(i){m.error("\u2717 Discord callback page test failed",{error:i.message})}),y=new Qe({clientId:"506432803173433344",redirectUri:n,scopes:["identify"]}),yi()}function bs(){f.helpButton=f.ui.addButton({text:"?",bottom:3,right:3,w:18,h:18,onPress:function(){if(f.serverListPanel&&(f.serverListPanel.remove(),delete f.serverListPanel),f.helpPanel){f.helpPanel.remove(),delete f.helpPanel;return}f.helpPanel=f.ui.addPanel({left:"auto",top:"auto",w:200,h:130}),f.ui.addLabel({text:"D-Zone (fork) "+(vi||ne.version),top:5,left:"auto",parent:f.helpPanel}),f.ui.addLabel({text:ne.description,top:20,left:2,maxWidth:196,parent:f.helpPanel}),f.ui.addLabel({text:"This is a fork of D-Zone (originally by Vegeta897). It follows its own versioning and is not published on npm.",top:50,left:2,maxWidth:196,parent:f.helpPanel}),f.ui.addLabel({text:":icon-npm: View on npm",hyperlink:"https://www.npmjs.com/package/d-zone",top:90,left:8,parent:f.helpPanel}),f.ui.addLabel({text:"View original :icon-github:",hyperlink:"https://github.com/d-zone-org/d-zone",top:90,right:8,parent:f.helpPanel}),f.ui.addLabel({text:"View fork :icon-github:",hyperlink:"https://github.com/nntin/d-zone",top:110,right:8,parent:f.helpPanel});let n=y&&y.isLoggedIn(),i=y&&y.getUser();n&&i?(f.ui.addLabel({text:`Logged in as: ${i.username}`,top:130,left:2,parent:f.helpPanel}),f.ui.addButton({text:"Logout Discord",top:150,left:2,w:80,h:16,parent:f.helpPanel,onPress:function(){y.logout()}})):(f.ui.addButton({text:"Login Discord",top:130,left:2,w:80,h:16,parent:f.helpPanel,onPress:function(){y.login()}}),f.ui.addLabel({text:"Login required for private servers",top:150,left:2,maxWidth:196,parent:f.helpPanel})),f.helpPanel.resize(200,170)}})}function vs(){let n,i,e;function t(){n&&n.removeAllListeners&&n.removeAllListeners(),i&&i.removeAllListeners&&i.removeAllListeners(),e&&e.removeAllListeners&&e.removeAllListeners()}let s=[],r=b.getURLParameter("socketURL");r&&s.push({url:r,description:"URL parameter"});let a="wss://"+window.location.hostname+window.location.pathname;a=a.replace(/\/$/,"")+"/ws",s.push({url:a,description:"current hostname and pathname"}),s.push({url:"wss://hermes.nntin.xyz/dzone",description:"Hermes fallback server"});let h=0;function l(){if(h>=s.length){m.error("All websocket connection strategies failed",{totalStrategies:s.length,attemptedStrategies:s.map(u=>u.description)});return}let c=s[h];m.info("Attempting websocket connection",{strategyIndex:h+1,totalStrategies:s.length,description:c.description,url:c.url}),re=new WebSocket(c.url),re.addEventListener("message",async function(u){let d=JSON.parse(u.data);if(m.websocketMessageReceived(d),e&&e.beacon.ping(),d.type==="server-list"){f.servers=d.data,m.info("Received server list",{serverCount:f.servers?Object.keys(f.servers).length:0,servers:f.servers}),f.ui.addButton({text:"Server",top:3,right:3,onPress:function(){if(f.helpPanel&&(f.helpPanel.remove(),delete f.helpPanel),f.serverListPanel){f.serverListPanel.remove(),delete f.serverListPanel;return}let M=function(z){return function(){if(z.passworded&&(!y||!y.isLoggedIn())){f.pendingServerJoin=z,window.alert("This server requires Discord authentication. Please login with Discord first.");return}let A="?s="+z.id;window.location.protocol!=="file:"&&window.history.pushState({server:z.id},z.id,window.location.pathname+A),oe(z),f.serverListPanel.remove(),delete f.serverListPanel}};f.serverListPanel=f.ui.addPanel({left:"auto",top:"auto",w:146,h:28+21*(Object.keys(f.servers||{}).length-1)});let v=136,S=0,w;for(let z in f.servers){if(!f.servers||!f.servers.hasOwnProperty(z))continue;let A=f.servers[z],ye=A.passworded?":icon-lock-small: ":"";w=f.ui.addButton({text:ye+f.servers[z].name,left:5,top:5+S*21,w:136,h:18,parent:f.serverListPanel,onPress:M(A),disabled:f.server===A.id}),v=Math.max(v,w.textCanvas.width+2),S++}f.serverListPanel.resize(v+10,f.serverListPanel.h),f.serverListPanel.resizeChildren(v,w.h),f.serverListPanel.reposition()}});let p=ys(),g=f.servers?.[p.id];!g||!g.passworded||y&&y.isLoggedIn()?oe(p):f.pendingServerJoin=p}else if(d.type==="server-join"){let p=d.data.request.server;localStorage.setItem("dzone-default-server",JSON.stringify({id:p})),m.serverJoined(p,d.data.serverName),d.data.clientId&&y&&(m.info("Setting Discord OAuth client ID from server-join",{clientId:d.data.clientId}),bi(d.data.clientId)),t(),f.reset(),f.renderer.clear();let g=d.data.users;f.server=p,i=new de(f,Math.round(3.3*Math.sqrt(Object.keys(g).length))),await i.initializationPromise,e=new me(f,i),f.decorator=e,n=new le(f,i);let M="?s="+d.data.request.server;window.location.protocol!=="file:"&&window.history.replaceState(d.data.request,p,window.location.pathname+M);let v=Object.keys(g).length;f.setMaxListeners(v+100),n.setMaxListeners(v+50),i&&i.setMaxListeners&&i.setMaxListeners(v+50),e&&e.setMaxListeners&&e.setMaxListeners(v+50);for(let w in g)g.hasOwnProperty(w)&&g[w].username&&n&&n.addActor(g[w]);let S=n?Object.keys(n.actors).length:0;m.info("Actors initialized",{totalUsers:v,createdActors:S,skippedUsers:v-S}),f.renderer.canvases[0].onResize()}else if(d.type==="presence")m.debug("Actor presence update",{uid:d.data.uid,presence:d.data.presence}),n&&n.updateActor(d.data);else if(d.type==="message")m.debug("Message received",{channel:d.data.channel,user:d.data.user?.username,messageLength:d.data.content?.length}),n.queueMessage(d.data);else if(d.type==="error")m.error("Server error received",{message:d.data.message}),window.alert(d.data.message),f.world||oe({id:"default"});else if(d.type==="update-clientid"&&(m.info("Received client ID update",{clientId:d.data.clientId}),d.data.clientId&&y&&(bi(d.data.clientId),f&&f.ui))){let p=f.ui.addPanel({left:"auto",top:50,w:250,h:60,backgroundColor:"#2c3e50"});f.ui.addLabel({text:"\u{1F504} Discord OAuth Updated",top:5,left:"auto",parent:p,color:"#ecf0f1"}),f.ui.addLabel({text:"Discord login configuration has been updated.",top:25,left:5,maxWidth:240,parent:p,color:"#bdc3c7"}),setTimeout(function(){p&&p.remove&&p.remove()},5e3)}}),re.addEventListener("open",function(){m.websocketConnected(c.url)}),re.addEventListener("close",function(){m.websocketDisconnected(`Strategy: ${c.description}`),t(),h===s.indexOf(c)&&(h++,setTimeout(l,1e3))}),re.addEventListener("error",function(u){m.warn("Websocket connection error",{strategy:c.description,strategyIndex:h+1,totalStrategies:s.length,error:u}),h===s.indexOf(c)&&(h++,setTimeout(l,1e3))})}l()}window.onpopstate=function(n){let i={id:n.state?.server};oe(i)};function oe(n){let i={type:"connect",data:{server:n.id}},e=null;if(f.servers){for(let t in f.servers)if(f.servers.hasOwnProperty(t)&&f.servers[t].id===n.id){e=f.servers[t];break}}m.debug("Server lookup for connection",{requestedServerId:n.id,foundServerData:e?{id:e.id,passworded:e.passworded}:null,serverCount:f.servers?Object.keys(f.servers).length:0}),e&&e.passworded&&y&&y.isLoggedIn()?(i.data.discordToken=y.accessToken,i.data.discordUser=y.getUser(),m.info("Sending Discord OAuth data for passworded server",{tokenLength:y.accessToken?y.accessToken.length:0,hasUser:!!y.getUser(),serverId:n.id})):m.debug("Not sending Discord OAuth data",{serverFound:!!e,serverPassworded:e?e.passworded:"unknown",discordAuthExists:!!y,discordLoggedIn:y?y.isLoggedIn():!1}),m.info("Requesting to join server",{serverId:n.id,hasDiscordAuth:!!i.data.discordToken}),re.send(JSON.stringify(i))}function ys(){let n={id:b.getURLParameter("s")};if(!n.id){let i=localStorage.getItem("dzone-default-server");i&&(n=JSON.parse(i))}return n||(n={id:"default"}),n}function ws(){m.info("Starting D-Zone application",{version:ne.version}),vi=ne.version,fs=new Jt(gs)}typeof window<"u"&&typeof document<"u"&&(ws(),window.joinServer=oe);})();
